<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>QNB Tracker ‚Äî FACT</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
    
    <script>
        dayjs.extend(dayjs_plugin_isBetween);
        
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    colors: {
                        fact: {
                            bg: '#F3F3F3',
                            card: '#FFFFFF',
                            ink: '#111111',
                            muted: '#666666',
                            border: '#E5E5E5',
                            yellow: '#F4C44E',
                            green: '#75B876',
                            purple: '#B593C6',
                            red: '#E57373',
                            'dark-bg': '#0F0F0F',
                            'dark-card': '#1A1A1A',
                            'dark-ink': '#F3F3F3',
                            'dark-muted': '#888888',
                            'dark-border': '#2A2A2A',
                        }
                    },
                    fontFamily: {
                        display: ['Noto Sans Display', 'Noto Sans', 'system-ui', 'sans-serif'],
                        body: ['Noto Sans', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Display:wght@500;600;700&display=swap');
        
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans', system-ui, sans-serif;
            background-color: #F3F3F3;
            background-image: radial-gradient(#D1D1D1 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #0F0F0F;
                background-image: radial-gradient(#2A2A2A 1px, transparent 1px);
            }
        }
        
        .font-display { font-family: 'Noto Sans Display', 'Noto Sans', system-ui, sans-serif; }
        
        .card {
            background: white;
            border: 1px solid #E5E5E5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        
        @media (prefers-color-scheme: dark) {
            .card {
                background: #1A1A1A;
                border-color: #2A2A2A;
                box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            }
        }
        
        .period-btn {
            transition: all 0.15s ease;
        }
        .period-btn:hover {
            background: #F4C44E;
            color: #111;
        }
        .period-btn.active {
            background: #111;
            color: white;
        }
        
        @media (prefers-color-scheme: dark) {
            .period-btn.active {
                background: #F3F3F3;
                color: #111;
            }
        }
        
        .modal-backdrop {
            background: rgba(17, 17, 17, 0.4);
            backdrop-filter: blur(4px);
        }
        .modal-box {
            animation: modalIn 0.2s ease-out;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        @media (prefers-color-scheme: dark) {
            .modal-backdrop {
                background: rgba(0, 0, 0, 0.6);
            }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #E5E5E5 25%, #F0F0F0 50%, #E5E5E5 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }
        
        @media (prefers-color-scheme: dark) {
            .skeleton {
                background: linear-gradient(90deg, #2A2A2A 25%, #333 50%, #2A2A2A 75%);
                background-size: 200% 100%;
            }
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D1D1D1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #B0B0B0; }
        
        @media (prefers-color-scheme: dark) {
            ::-webkit-scrollbar-thumb { background: #444; }
            ::-webkit-scrollbar-thumb:hover { background: #555; }
        }
        
        .corner-mark {
            position: absolute;
            width: 12px;
            height: 12px;
            border: 2px solid #111;
        }
        .corner-tl { top: -1px; left: -1px; border-right: none; border-bottom: none; }
        .corner-tr { top: -1px; right: -1px; border-left: none; border-bottom: none; }
        .corner-bl { bottom: -1px; left: -1px; border-right: none; border-top: none; }
        .corner-br { bottom: -1px; right: -1px; border-left: none; border-top: none; }
        
        @media (prefers-color-scheme: dark) {
            .corner-mark { border-color: #F3F3F3; }
        }
        
        .txn-row { transition: background 0.15s ease; }
        .txn-row:hover { background: #FAFAFA; }
        .txn-row.uncat { background: #FEF3E2; }

        @media (prefers-color-scheme: dark) {
            .txn-row:hover { background: #222; }
            .txn-row.uncat { background: #3D3020; }
        }

        /* Improved mobile spacing */
        @media (max-width: 640px) {
            .card { border-radius: 12px; }
            .modal-box { max-height: 95vh; }
        }

        /* Fade-in animation for cards */
        .card {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Better touch targets on mobile */
        @media (max-width: 640px) {
            .period-btn { padding: 8px 12px; }
            .txn-row { padding: 16px 12px; }
        }

        /* Category group card hover effect */
        .cat-group:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        @media (prefers-color-scheme: dark) {
            .cat-group:hover {
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
        }
        
        /* Date input styling */
        input[type="date"] {
            color-scheme: light;
        }
        @media (prefers-color-scheme: dark) {
            input[type="date"] {
                color-scheme: dark;
            }
        }
    </style>
</head>

<body class="text-fact-ink dark:text-fact-dark-ink">
    
    <div class="max-w-5xl mx-auto px-4 py-6 md:py-10">
        
        <!-- HEADER -->
        <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-fact-ink dark:bg-fact-dark-ink rounded flex items-center justify-center">
                    <span class="text-white dark:text-fact-dark-bg font-display font-bold text-lg">Q</span>
                </div>
                <div>
                    <h1 class="font-display font-bold text-xl tracking-tight">QNB Tracker</h1>
                    <p class="text-fact-muted dark:text-fact-dark-muted text-xs">
                        <span id="currentUserDisplay">Personal Finance</span> ¬∑ FACT
                    </p>
                </div>
            </div>
            
            <!-- Period Selector -->
            <div class="flex flex-wrap items-center gap-1 bg-white dark:bg-fact-dark-card border border-fact-border dark:border-fact-dark-border rounded-lg p-1">
                <button onclick="setPeriod('thisMonth')" data-period="thisMonth" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">This Month</button>
                <button onclick="setPeriod('lastMonth')" data-period="lastMonth" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">Last Month</button>
                <button onclick="setPeriod('last90')" data-period="last90" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">90 Days</button>
                <button onclick="setPeriod('thisYear')" data-period="thisYear" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">Year</button>
                <button onclick="openDatePicker()" data-period="custom" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">Custom</button>
            </div>
        </header>
        
        <!-- LOADING STATE -->
        <div id="loadingState" class="space-y-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="skeleton h-24"></div>
                <div class="skeleton h-24"></div>
                <div class="skeleton h-24"></div>
                <div class="skeleton h-24"></div>
            </div>
            <div class="skeleton h-80"></div>
        </div>
        
        <!-- MAIN CONTENT -->
        <div id="mainContent" class="hidden space-y-6">
            
            <!-- ROW 1: OVERVIEW -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                
                <!-- DONUT CHART -->
                <div class="card rounded-xl p-5 relative">
                    <div class="corner-mark corner-tl"></div>
                    <div class="corner-mark corner-tr"></div>
                    <div class="corner-mark corner-bl"></div>
                    <div class="corner-mark corner-br"></div>
                    
                    <h2 class="font-display font-semibold text-sm mb-4">Spending by Category</h2>
                    <div class="relative h-52 flex items-center justify-center">
                        <canvas id="donutChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="text-center">
                                <div class="font-display font-bold text-2xl" id="donutTotal">--</div>
                                <div class="text-xs text-fact-muted dark:text-fact-dark-muted">Total Spent</div>
                            </div>
                        </div>
                    </div>
                    <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted text-center mt-2">Click a segment for details</p>
                </div>
                
                <!-- KEY METRICS + INCOME VS EXPENSE -->
                <div class="lg:col-span-2 space-y-4">
                    
                    <!-- METRICS ROW -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="card rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 rounded-full bg-fact-green"></div>
                                <span class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider">Income</span>
                            </div>
                            <div class="font-display font-bold text-xl" id="metricIncome">--</div>
                        </div>
                        
                        <div class="card rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 rounded-full bg-fact-yellow"></div>
                                <span class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider">Spent</span>
                            </div>
                            <div class="font-display font-bold text-xl" id="metricSpent">--</div>
                        </div>
                        
                        <div class="card rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 rounded-full" id="netDot"></div>
                                <span class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider">Net</span>
                            </div>
                            <div class="font-display font-bold text-xl" id="metricNet">--</div>
                        </div>
                        
                        <div class="card rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-2 h-2 rounded-full bg-fact-purple"></div>
                                <span class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider">Daily Budget</span>
                            </div>
                            <div class="font-display font-bold text-xl" id="metricDaily">--</div>
                            <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted" id="metricDaysLeft">-- days left</div>
                        </div>
                    </div>
                    
                    <!-- INCOME VS EXPENSE BAR -->
                    <div class="card rounded-xl p-5">
                        <h2 class="font-display font-semibold text-sm mb-3">Income vs Expense</h2>
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-fact-muted dark:text-fact-dark-muted">Income</span>
                                    <span class="font-medium" id="incomeBarLabel">--</span>
                                </div>
                                <div class="h-4 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                                    <div id="incomeBar" class="h-full bg-fact-green rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-fact-muted dark:text-fact-dark-muted">Expenses</span>
                                    <span class="font-medium" id="expenseBarLabel">--</span>
                                </div>
                                <div class="h-4 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                                    <div id="expenseBar" class="h-full bg-fact-yellow rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ROW 2: SPENDING TRENDS -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                
                <!-- DAILY SPENDING TREND -->
                <div class="card rounded-xl p-5">
                    <h2 class="font-display font-semibold text-sm mb-1">Daily Spending</h2>
                    <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-4">Track your spending pattern over time</p>
                    <div class="h-48">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
                
                <!-- CUMULATIVE SPENDING -->
                <div class="card rounded-xl p-5">
                    <h2 class="font-display font-semibold text-sm mb-1">Cumulative Spending</h2>
                    <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-4">Running total through the period</p>
                    <div class="h-48">
                        <canvas id="cumulativeChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- ROW 3: MONTH COMPARISON -->
            <div class="card rounded-xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="font-display font-semibold text-sm">This Month vs Last Month</h2>
                        <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted">Category-by-category comparison</p>
                    </div>
                    <div class="flex items-center gap-4 text-xs">
                        <div class="flex items-center gap-1.5">
                            <div class="w-3 h-3 rounded bg-fact-yellow"></div>
                            <span class="text-fact-muted dark:text-fact-dark-muted">This Month</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-3 h-3 rounded bg-gray-300 dark:bg-gray-600"></div>
                            <span class="text-fact-muted dark:text-fact-dark-muted">Last Month</span>
                        </div>
                    </div>
                </div>
                <div class="h-56">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
            
            <!-- ROW 4: CATEGORIES LIST (Hierarchical) -->
            <div class="card rounded-xl overflow-hidden">
                <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                    <div>
                        <h2 class="font-display font-semibold text-sm">Spending by Category</h2>
                        <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted">Organized by priority</p>
                    </div>
                    <div class="flex items-center gap-1 bg-gray-100 dark:bg-gray-800 rounded-lg p-0.5">
                        <button onclick="setViewMode('parent')" id="viewParent" class="px-2 py-1 text-[10px] font-medium rounded-md bg-fact-ink dark:bg-fact-dark-ink text-white dark:text-fact-dark-bg">Groups</button>
                        <button onclick="setViewMode('subcat')" id="viewSubcat" class="px-2 py-1 text-[10px] font-medium rounded-md text-fact-muted dark:text-fact-dark-muted">Details</button>
                    </div>
                </div>
                <div id="categoryList" class="divide-y divide-fact-border dark:divide-fact-dark-border max-h-96 overflow-y-auto">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- ROW 4.5: TOP MERCHANTS -->
            <div class="card rounded-xl overflow-hidden">
                <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                    <div>
                        <h2 class="font-display font-semibold text-sm">Top Merchants</h2>
                        <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted">Transaction count & total value</p>
                    </div>
                    <button onclick="openMerchantModal()" class="text-xs font-medium text-fact-yellow hover:underline">View All</button>
                </div>
                <div id="merchantList" class="divide-y divide-fact-border dark:divide-fact-dark-border max-h-72 overflow-y-auto">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- ROW 5: UNCATEGORIZED ALERT -->
            <div id="uncatAlert" class="hidden card rounded-xl p-4 border-l-4 border-fact-yellow bg-yellow-50 dark:bg-yellow-900/20 cursor-pointer hover:bg-yellow-100 dark:hover:bg-yellow-900/30 transition" onclick="openUncatModal()">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-fact-yellow flex items-center justify-center">
                            <svg class="w-4 h-4 text-fact-ink" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <div>
                            <div class="font-medium text-sm"><span id="uncatCount">0</span> uncategorized transactions</div>
                            <div class="text-xs text-fact-muted dark:text-fact-dark-muted">QAR <span id="uncatAmount">0</span> needs categorizing</div>
                        </div>
                    </div>
                    <span class="text-xs font-medium text-fact-yellow">Fix Now ‚Üí</span>
                </div>
            </div>
            
            <!-- ROW 6: RECURRING & TRANSACTIONS -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                
                <!-- RECURRING -->
                <div class="card rounded-xl overflow-hidden">
                    <div class="p-5 border-b border-fact-border dark:border-fact-dark-border">
                        <h2 class="font-display font-semibold text-sm">Recurring Payments</h2>
                        <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted">Auto-detected subscriptions</p>
                    </div>
                    <div id="recurringList" class="divide-y divide-fact-border dark:divide-fact-dark-border max-h-64 overflow-y-auto">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- TRANSACTIONS PREVIEW -->
                <div class="card rounded-xl overflow-hidden">
                    <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                        <div>
                            <h2 class="font-display font-semibold text-sm">Recent Transactions</h2>
                            <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted" id="txnCountLabel">-- transactions</p>
                        </div>
                        <button onclick="openTxnModal()" class="text-xs font-medium text-fact-yellow hover:underline">View All</button>
                    </div>
                    <div id="recentTxns" class="divide-y divide-fact-border dark:divide-fact-dark-border max-h-64 overflow-y-auto">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            
            <!-- ROW 7: AI INSIGHTS -->
            <div class="card rounded-xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="font-display font-semibold text-sm">AI Insights</h2>
                        <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted">Pattern analysis & anomalies</p>
                    </div>
                    <button onclick="openAIQuery()" class="text-xs font-medium text-fact-yellow hover:underline">Ask AI</button>
                </div>

                <!-- Quick Insights -->
                <div id="quickInsights" class="space-y-3">
                    <div class="text-sm text-fact-muted dark:text-fact-dark-muted">Loading insights...</div>
                </div>

                <!-- Dimension Filters -->
                <div class="mt-4 pt-4 border-t border-fact-border dark:border-fact-dark-border">
                    <p class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider mb-2">Quick Filters</p>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterByDimension('workHours')" class="dim-filter px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">
                            üíº Work Hours
                        </button>
                        <button onclick="filterByDimension('lateNight')" class="dim-filter px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">
                            üåô Late Night
                        </button>
                        <button onclick="filterByDimension('nightOut')" class="dim-filter px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">
                            üéâ Night Out
                        </button>
                        <button onclick="filterByDimension('splurge')" class="dim-filter px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">
                            üí∏ Splurges
                        </button>
                        <button onclick="filterByDimension('large')" class="dim-filter px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">
                            ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ Large
                        </button>
                        <button onclick="filterByDimension('subscription')" class="dim-filter px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">
                            üìÖ Subscriptions
                        </button>
                        <button onclick="filterByDimension('clear')" class="dim-filter px-3 py-1.5 text-xs rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                            ‚úï Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <footer class="text-center text-[10px] text-fact-muted dark:text-fact-dark-muted pt-4">
                <span id="lastSync">Not synced</span> ¬∑ <button onclick="syncData()" class="underline hover:text-fact-ink dark:hover:text-fact-dark-ink">Sync Now</button>
            </footer>
        </div>
    </div>
    
    <!-- MODALS -->
    
    <!-- DATE PICKER MODAL -->
    <div id="dateModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-sm overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border">
                <h3 class="font-display font-semibold">Custom Date Range</h3>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Start Date</label>
                    <input type="date" id="startDate" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">End Date</label>
                    <input type="date" id="endDate" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                </div>
            </div>
            <div class="p-5 border-t border-fact-border dark:border-fact-dark-border flex gap-3">
                <button onclick="closeDatePicker()" class="flex-1 px-4 py-2 text-sm text-fact-muted hover:text-fact-ink rounded-lg">Cancel</button>
                <button onclick="applyCustomDate()" class="flex-1 px-4 py-2 text-sm bg-fact-ink dark:bg-fact-dark-ink text-white dark:text-fact-dark-bg rounded-lg font-medium">Apply</button>
            </div>
        </div>
    </div>
    
    <!-- CATEGORY DRILL-DOWN MODAL -->
    <div id="drilldownModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold" id="drilldownTitle">Category</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="drilldownSubtitle">-- transactions</p>
                </div>
                <button onclick="closeDrilldown()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <!-- Drilldown Charts -->
            <div class="p-5 space-y-4 border-b border-fact-border dark:border-fact-dark-border">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider mb-1">Total Spent</p>
                        <p class="font-display font-bold text-2xl" id="drilldownTotal">--</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider mb-1">vs Last Period</p>
                        <p class="font-display font-bold text-2xl" id="drilldownDelta">--</p>
                    </div>
                </div>
                
                <!-- Timeline Chart -->
                <div>
                    <p class="text-xs font-medium mb-2">Spending Over Time</p>
                    <div class="h-32">
                        <canvas id="drilldownTimeline"></canvas>
                    </div>
                </div>
                
                <!-- Breakdown Section (Merchants/Subcategories/Stats) -->
                <div id="drilldownMerchants" class="space-y-2">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Transactions -->
            <div class="flex-1 overflow-y-auto">
                <div id="drilldownTxns" class="divide-y divide-fact-border dark:divide-fact-dark-border">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- UNCATEGORIZED MODAL -->
    <div id="uncatModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">Uncategorized Transactions</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Click to categorize</p>
                </div>
                <button onclick="closeUncatModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="uncatList" class="flex-1 overflow-y-auto divide-y divide-fact-border dark:divide-fact-dark-border">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
    
    <!-- CATEGORIZE MODAL -->
    <div id="catModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-sm overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border">
                <h3 class="font-display font-semibold">Categorize Transaction</h3>
            </div>
            <div class="p-5 space-y-4">
                <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Original</div>
                    <div class="text-sm font-medium break-all" id="catModalRaw">--</div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Display Name</label>
                    <input type="text" id="catModalName" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow" placeholder="e.g., Starbucks">
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Category</label>
                    <select id="catModalCat" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>
            <div class="p-5 border-t border-fact-border dark:border-fact-dark-border flex gap-3">
                <button onclick="closeCatModal()" class="flex-1 px-4 py-2 text-sm text-fact-muted hover:text-fact-ink rounded-lg">Cancel</button>
                <button onclick="saveCategorization()" class="flex-1 px-4 py-2 text-sm bg-fact-yellow text-fact-ink rounded-lg font-medium">Save</button>
            </div>
        </div>
    </div>
    
    <!-- ALL TRANSACTIONS MODAL -->
    <div id="txnModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">All Transactions</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="txnModalCount">-- transactions</p>
                </div>
                <button onclick="closeTxnModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border flex gap-3">
                <input type="text" id="txnSearch" placeholder="Search..." class="flex-1 px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                <select id="txnFilter" class="px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div id="txnModalList" class="flex-1 overflow-y-auto divide-y divide-fact-border dark:divide-fact-dark-border">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- ALL MERCHANTS MODAL -->
    <div id="merchantModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">All Merchants</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="merchantModalCount">-- merchants</p>
                </div>
                <button onclick="closeMerchantModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border flex gap-3">
                <input type="text" id="merchantSearch" placeholder="Search merchants..." class="flex-1 px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow" oninput="filterMerchantModal()">
                <select id="merchantSort" class="px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none" onchange="filterMerchantModal()">
                    <option value="amount">By Total</option>
                    <option value="count">By Count</option>
                    <option value="name">By Name</option>
                </select>
            </div>
            <div id="merchantModalList" class="flex-1 overflow-y-auto divide-y divide-fact-border dark:divide-fact-dark-border">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- AI QUERY MODAL -->
    <div id="aiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">Ask AI About Your Spending</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Powered by GPT via GAS</p>
                </div>
                <button onclick="closeAIQuery()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Quick Questions -->
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border">
                <p class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider mb-2">Quick Questions</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="askAI('What are my biggest spending categories this period?')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Top categories</button>
                    <button onclick="askAI('Find any unusual or suspicious transactions')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Anomalies</button>
                    <button onclick="askAI('Which transactions might be work expenses I could claim?')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Work expenses</button>
                    <button onclick="askAI('Summarize my night out spending patterns')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Night outs</button>
                    <button onclick="askAI('What subscriptions or recurring payments do I have?')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Subscriptions</button>
                </div>
            </div>

            <!-- Custom Query -->
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border">
                <div class="flex gap-2">
                    <input type="text" id="aiQueryInput" placeholder="Ask anything about your spending..." class="flex-1 px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow" onkeydown="if(event.key==='Enter')askAI()">
                    <button onclick="askAI()" class="px-4 py-2 bg-fact-ink dark:bg-fact-dark-ink text-white dark:text-fact-dark-bg rounded-lg text-sm font-medium">Ask</button>
                </div>
            </div>

            <!-- Response -->
            <div class="flex-1 overflow-y-auto p-5">
                <div id="aiResponse" class="prose prose-sm dark:prose-invert max-w-none">
                    <p class="text-fact-muted dark:text-fact-dark-muted text-sm">Ask a question to analyze your spending data.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- FILTERED VIEW MODAL -->
    <div id="filteredModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold" id="filteredTitle">Filtered Transactions</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="filteredSubtitle">-- transactions</p>
                </div>
                <button onclick="closeFilteredModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Stats Summary -->
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border grid grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Total</div>
                    <div class="font-display font-bold" id="filteredTotal">--</div>
                </div>
                <div class="text-center">
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Count</div>
                    <div class="font-display font-bold" id="filteredCount">--</div>
                </div>
                <div class="text-center">
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Average</div>
                    <div class="font-display font-bold" id="filteredAvg">--</div>
                </div>
            </div>

            <div id="filteredList" class="flex-1 overflow-y-auto divide-y divide-fact-border dark:divide-fact-dark-border">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // CONFIG
        const CONFIG = {
            // Multi-user: Users access via ?u=<userId> in URL
            // Each user maps to their own SHEET_ID in USER_SHEETS
            USER_SHEETS: {
                'fares': '1LLpl1sH7LHqD3u3ZU4JWZJtvcHD_SGFql76llyfAIBw',
                // Add more users: 'username': 'sheet_id'
            },
            DEFAULT_SHEET_ID: '1LLpl1sH7LHqD3u3ZU4JWZJtvcHD_SGFql76llyfAIBw',
            STORAGE_KEY: 'qnb_tracker_v4',
            DEFAULT_FX: { USD: 3.65, EUR: 3.95, GBP: 4.60, SAR: 0.97 },
            // GAS URL for AI proxy - UPDATE THIS after deploying gas_enhanced.js
            GAS_URL: 'https://script.google.com/macros/s/AKfycbzyEuhcHVz0JZejwyGT2fjYfI6UAntZ5T0M0EX9eXDnHxvPW4y5Yo5WYC1jp2FdOfH0/exec'
        };

        // Get user from URL parameter
        function getCurrentUser() {
            const params = new URLSearchParams(window.location.search);
            return params.get('u') || 'default';
        }

        function getSheetId() {
            const user = getCurrentUser();
            return CONFIG.USER_SHEETS[user] || CONFIG.DEFAULT_SHEET_ID;
        }

        // DIMENSION-BASED CATEGORIZATION SYSTEM
        // Instead of rigid hierarchy, use computed dimensions for flexible analysis

        // DIMENSION 1: WHAT (merchant type) - the base category
        const MERCHANT_TYPES = {
            'Groceries': { color: '#4CAF50', icon: 'üõí', essential: true },
            'Dining': { color: '#E67E22', icon: 'üçΩÔ∏è', essential: false },
            'Bars & Nightlife': { color: '#AB47BC', icon: 'üç∏', essential: false },
            'Coffee': { color: '#795548', icon: '‚òï', essential: false },
            'Delivery': { color: '#FFA726', icon: 'üì¶', essential: false },
            'Shopping': { color: '#42A5F5', icon: 'üõçÔ∏è', essential: false },
            'Transport': { color: '#26C6DA', icon: 'üöó', essential: true },
            'Health': { color: '#66BB6A', icon: 'üíä', essential: true },
            'Bills': { color: '#78909C', icon: 'üìÑ', essential: true },
            'Travel': { color: '#FF7043', icon: '‚úàÔ∏è', essential: false },
            'Entertainment': { color: '#EC407A', icon: 'üé¨', essential: false },
            'Transfer': { color: '#8D6E63', icon: 'üí∏', essential: false },
            'Family': { color: '#E91E63', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', essential: false },
            'Other': { color: '#95A5A6', icon: 'üìã', essential: false },
            'Uncategorized': { color: '#E74C3C', icon: '‚ùì', essential: false }
        };

        // DIMENSION 2: WHEN (time context)
        const TIME_CONTEXTS = {
            'Work Hours': { color: '#3498DB', hours: [7, 16], days: [0, 1, 2, 3, 4], icon: 'üíº' }, // Sun-Thu in Qatar
            'Evening': { color: '#9B59B6', hours: [17, 21], icon: 'üåÜ' },
            'Late Night': { color: '#2C3E50', hours: [21, 4], icon: 'üåô' },
            'Weekend': { color: '#E74C3C', days: [5, 6], icon: 'üéâ' }, // Fri-Sat
            'Early Morning': { color: '#F39C12', hours: [5, 7], icon: 'üåÖ' }
        };

        // DIMENSION 3: SIZE (amount tier)
        const SIZE_TIERS = {
            'Micro': { max: 25, color: '#BDC3C7', icon: '‚Ä¢' },
            'Small': { max: 100, color: '#95A5A6', icon: '‚Ä¢‚Ä¢' },
            'Medium': { max: 500, color: '#7F8C8D', icon: '‚Ä¢‚Ä¢‚Ä¢' },
            'Large': { max: 2000, color: '#34495E', icon: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' },
            'Major': { max: Infinity, color: '#2C3E50', icon: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' }
        };

        // DIMENSION 4: PATTERN (AI-detected, computed from sequences)
        const PATTERNS = {
            'Routine': { color: '#3498DB', icon: 'üîÑ', description: 'Regular, repeated spending' },
            'Night Out': { color: '#9B59B6', icon: 'üéâ', description: 'Evening social spending cluster' },
            'Splurge': { color: '#E74C3C', icon: 'üí∏', description: 'Unusually large purchase' },
            'Trip': { color: '#E67E22', icon: '‚úàÔ∏è', description: 'Travel-related cluster' },
            'Subscription': { color: '#1ABC9C', icon: 'üìÖ', description: 'Recurring fixed amount' },
            'Work Expense': { color: '#3498DB', icon: 'üíº', description: 'Likely work-related' },
            'Normal': { color: '#95A5A6', icon: '‚óã', description: 'Standard transaction' }
        };

        // High-level groupings for summary view (simplified)
        const SUMMARY_GROUPS = {
            'Essentials': {
                color: '#75B876',
                icon: 'üè†',
                types: ['Groceries', 'Bills', 'Health', 'Transport']
            },
            'Food & Drinks': {
                color: '#E67E22',
                icon: 'üçΩÔ∏è',
                types: ['Dining', 'Coffee', 'Delivery', 'Bars & Nightlife']
            },
            'Shopping & Fun': {
                color: '#42A5F5',
                icon: 'üõçÔ∏è',
                types: ['Shopping', 'Entertainment', 'Travel']
            },
            'Family': {
                color: '#E91E63',
                icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                types: ['Family']
            },
            'Other': {
                color: '#95A5A6',
                icon: 'üìã',
                types: ['Transfer', 'Other', 'Uncategorized']
            }
        };

        // Compute summary group from merchant type
        function getSummaryGroup(merchantType) {
            for (const [group, data] of Object.entries(SUMMARY_GROUPS)) {
                if (data.types.includes(merchantType)) return group;
            }
            return 'Other';
        }

        // Compute time context from timestamp
        function getTimeContext(date) {
            const hour = date.hour();
            const day = date.day(); // 0 = Sunday

            const contexts = [];

            // Check weekend first (Fri-Sat in Qatar)
            if (day === 5 || day === 6) {
                contexts.push('Weekend');
            }

            // Check time of day
            if (hour >= 7 && hour < 16 && day >= 0 && day <= 4) {
                contexts.push('Work Hours');
            }
            if (hour >= 17 && hour < 21) {
                contexts.push('Evening');
            }
            if (hour >= 21 || hour < 5) {
                contexts.push('Late Night');
            }
            if (hour >= 5 && hour < 7) {
                contexts.push('Early Morning');
            }

            return contexts.length > 0 ? contexts : ['Normal'];
        }

        // Compute size tier from amount
        function getSizeTier(amount) {
            for (const [tier, data] of Object.entries(SIZE_TIERS)) {
                if (amount <= data.max) return tier;
            }
            return 'Major';
        }

        // COLORS helper
        function getTypeColor(type) {
            return MERCHANT_TYPES[type]?.color || '#95A5A6';
        }

        function getGroupColor(group) {
            return SUMMARY_GROUPS[group]?.color || '#95A5A6';
        }

        // STATE
        const STATE = {
            allTxns: [],
            filtered: [],
            merchantMap: [],
            categories: new Set(),
            fxRates: { ...CONFIG.DEFAULT_FX },
            localMappings: {},
            period: 'thisMonth',
            dateRange: { start: dayjs().startOf('month'), end: dayjs() },
            catTarget: null,
            currentUser: getCurrentUser(),
            viewMode: 'parent' // 'parent' or 'subcat'
        };

        // CHARTS
        const charts = {};

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            // Display current user
            const user = getCurrentUser();
            const userDisplay = document.getElementById('currentUserDisplay');
            if (user && user !== 'default') {
                userDisplay.textContent = user.charAt(0).toUpperCase() + user.slice(1);
            }

            loadLocal();
            syncData();

            document.getElementById('txnSearch').addEventListener('input', debounce(filterTxnModal, 200));
            document.getElementById('txnFilter').addEventListener('change', filterTxnModal);
        });

        function getStorageKey() {
            return `${CONFIG.STORAGE_KEY}_${STATE.currentUser}`;
        }

        function loadLocal() {
            try {
                const stored = localStorage.getItem(getStorageKey());
                if (stored) {
                    const data = JSON.parse(stored);
                    STATE.localMappings = data.mappings || {};
                }
            } catch (e) {}
        }

        function saveLocal() {
            localStorage.setItem(getStorageKey(), JSON.stringify({
                mappings: STATE.localMappings
            }));
        }

        // DATA FETCHING
        async function syncData() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');

            const sheetId = getSheetId();
            const url = (sheet) => `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}&_=${Date.now()}`;

            try {
                const [ledger, map, fx] = await Promise.all([
                    fetchCSV(url('RawLedger')),
                    fetchCSV(url('MerchantMap')),
                    fetchCSV(url('FXRates'))
                ]);

                processFX(fx);
                processMerchantMap(map);
                processTxns(ledger);

                document.getElementById('lastSync').textContent = `Synced ${dayjs().format('HH:mm')}`;
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                setPeriod(STATE.period);

            } catch (err) {
                console.error('Sync error:', err);
                alert('Sync failed. Check your connection.');
            }
        }

        function fetchCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: false,
                    skipEmptyLines: true,
                    complete: res => resolve(res.data),
                    error: err => reject(err)
                });
            });
        }

        function processFX(rows) {
            rows.forEach(r => {
                const cur = clean(r[0]);
                const rate = parseFloat(r[1]);
                if (cur && !isNaN(rate)) STATE.fxRates[cur] = rate;
            });
        }

        function processMerchantMap(rows) {
            if (rows.length && rows[0][0]?.toLowerCase().includes('pattern')) rows.shift();

            STATE.merchantMap = [];
            STATE.categories.clear();

            rows.forEach(r => {
                const pattern = clean(r[0]).toLowerCase();
                const display = clean(r[1]);
                const consolidated = clean(r[2]) || display;
                const category = clean(r[3]);

                if (pattern && category) {
                    STATE.merchantMap.push({ pattern, display, consolidated, category });
                    STATE.categories.add(category);
                }
            });

            STATE.categories.add('Uncategorized');
            updateCatDropdowns();
        }

        function processTxns(rows) {
            // Detect schema: old (8 cols) vs enhanced (12 cols)
            const headers = rows[0] || [];
            const hasEnhancedSchema = headers.length >= 10 &&
                (clean(headers[7]) === 'Category' || clean(headers[8]) === 'Category');

            const data = rows.filter(r => clean(r[1]) !== 'Amount' && !isNaN(parseFloat(r[1])));

            STATE.allTxns = data.map(r => {
                const raw = clean(r[3]);
                const currency = clean(r[2]) || 'QAR';
                const amount = parseFloat(r[1]);
                const rate = STATE.fxRates[currency] || 1;
                const amtQAR = currency === 'QAR' ? amount : amount * rate;
                const txnDate = dayjs(clean(r[0]));

                // Try to get AI-assigned category from enhanced schema
                let aiMerchantType = null;
                let confidence = null;
                let aiContext = null;

                if (hasEnhancedSchema) {
                    aiMerchantType = clean(r[8]) || clean(r[7]) || null;
                    confidence = clean(r[9]) || null;
                    try {
                        aiContext = r[10] ? JSON.parse(clean(r[10])) : null;
                    } catch (e) {
                        aiContext = null;
                    }
                }

                // Get merchant type and display info
                const meta = categorize(raw, aiMerchantType);

                // COMPUTE DIMENSIONS
                const dims = {
                    what: meta.merchantType,
                    when: getTimeContext(txnDate),
                    size: getSizeTier(amtQAR),
                    pattern: 'Normal' // Will be computed in batch by AI
                };

                return {
                    date: txnDate,
                    amount: amtQAR,
                    currency,
                    raw,
                    display: meta.display,
                    consolidated: meta.consolidated,
                    merchantType: meta.merchantType,
                    summaryGroup: getSummaryGroup(meta.merchantType),
                    direction: clean(r[5]),
                    txnType: clean(r[6]),
                    confidence,
                    aiContext,
                    // Dimensions
                    dims,
                    // Computed flags for quick filtering
                    isWorkHours: dims.when.includes('Work Hours'),
                    isLateNight: dims.when.includes('Late Night'),
                    isWeekend: dims.when.includes('Weekend'),
                    isLarge: dims.size === 'Large' || dims.size === 'Major',
                    isEssential: MERCHANT_TYPES[meta.merchantType]?.essential || false
                };
            }).sort((a, b) => b.date - a.date);

            // After loading, detect patterns
            detectPatterns();
        }

        function categorize(raw, aiMerchantType = null) {
            const lower = raw.toLowerCase();

            // Priority 1: Local user overrides
            if (STATE.localMappings[lower]) {
                const m = STATE.localMappings[lower];
                return {
                    display: m.display,
                    consolidated: m.consolidated,
                    merchantType: m.merchantType || m.category || 'Other'
                };
            }

            // Priority 2: AI-assigned type (if provided and valid)
            if (aiMerchantType && MERCHANT_TYPES[aiMerchantType]) {
                return { display: raw, consolidated: raw, merchantType: aiMerchantType };
            }

            // Priority 3: MerchantMap patterns
            const match = STATE.merchantMap.find(m => lower.includes(m.pattern));
            if (match) {
                // Map old categories to new merchant types
                const typeMap = {
                    'Groceries': 'Groceries',
                    'Dining': 'Dining',
                    'Bars & Hotels': 'Bars & Nightlife',
                    'Delivery': 'Delivery',
                    'Shopping': 'Shopping',
                    'Hobbies': 'Entertainment',
                    'Bills': 'Bills',
                    'Transport': 'Transport',
                    'Travel': 'Travel',
                    'Health': 'Health',
                    'Family Transfers': 'Family',
                    'Family': 'Family',
                    'Transfers': 'Transfer',
                    'Fees': 'Transfer'
                };
                const merchantType = typeMap[match.category] || match.category || 'Other';
                return { display: match.display, consolidated: match.consolidated, merchantType };
            }

            return { display: raw, consolidated: raw, merchantType: 'Uncategorized' };
        }

        // PATTERN DETECTION - runs on all transactions to find clusters
        function detectPatterns() {
            const out = STATE.allTxns.filter(t => t.direction === 'OUT');

            // Detect Night Out patterns: multiple bar/dining transactions in same evening
            const byDate = {};
            out.forEach(t => {
                const dateKey = t.date.format('YYYY-MM-DD');
                if (!byDate[dateKey]) byDate[dateKey] = [];
                byDate[dateKey].push(t);
            });

            Object.values(byDate).forEach(dayTxns => {
                const lateNightSocial = dayTxns.filter(t =>
                    t.isLateNight &&
                    ['Bars & Nightlife', 'Dining', 'Coffee'].includes(t.merchantType)
                );
                if (lateNightSocial.length >= 2) {
                    lateNightSocial.forEach(t => t.dims.pattern = 'Night Out');
                }
            });

            // Detect Work Expense candidates: work hours dining/coffee
            out.forEach(t => {
                if (t.isWorkHours && ['Dining', 'Coffee'].includes(t.merchantType) && t.dims.pattern === 'Normal') {
                    t.dims.pattern = 'Work Expense';
                }
            });

            // Detect Splurges: transactions > 3x average for that merchant type
            const avgByType = {};
            out.forEach(t => {
                if (!avgByType[t.merchantType]) avgByType[t.merchantType] = { sum: 0, count: 0 };
                avgByType[t.merchantType].sum += t.amount;
                avgByType[t.merchantType].count++;
            });
            Object.keys(avgByType).forEach(type => {
                avgByType[type].avg = avgByType[type].sum / avgByType[type].count;
            });

            out.forEach(t => {
                const avg = avgByType[t.merchantType]?.avg || 0;
                if (avg > 0 && t.amount > avg * 3 && t.dims.pattern === 'Normal') {
                    t.dims.pattern = 'Splurge';
                }
            });

            // Detect Subscriptions: same merchant, similar amount, ~monthly interval
            const byMerchant = {};
            out.forEach(t => {
                if (!byMerchant[t.consolidated]) byMerchant[t.consolidated] = [];
                byMerchant[t.consolidated].push(t);
            });

            Object.values(byMerchant).forEach(txns => {
                if (txns.length < 2) return;
                txns.sort((a, b) => a.date - b.date);

                const intervals = [];
                for (let i = 1; i < txns.length; i++) {
                    intervals.push(txns[i].date.diff(txns[i-1].date, 'day'));
                }

                const avgInterval = intervals.reduce((s, i) => s + i, 0) / intervals.length;
                const amounts = txns.map(t => t.amount);
                const avgAmount = amounts.reduce((s, a) => s + a, 0) / amounts.length;
                const amountVariance = amounts.every(a => Math.abs(a - avgAmount) < avgAmount * 0.1);

                if (avgInterval >= 25 && avgInterval <= 35 && amountVariance) {
                    txns.forEach(t => t.dims.pattern = 'Subscription');
                }
            });
        }

        function clean(str) {
            return str ? str.toString().replace(/^"|"$/g, '').trim() : '';
        }

        // PERIOD
        function setPeriod(period) {
            STATE.period = period;
            const now = dayjs();

            switch (period) {
                case 'thisMonth':
                    STATE.dateRange = { start: now.startOf('month'), end: now };
                    break;
                case 'lastMonth':
                    STATE.dateRange = { start: now.subtract(1, 'month').startOf('month'), end: now.subtract(1, 'month').endOf('month') };
                    break;
                case 'last90':
                    STATE.dateRange = { start: now.subtract(90, 'day'), end: now };
                    break;
                case 'thisYear':
                    STATE.dateRange = { start: now.startOf('year'), end: now };
                    break;
            }

            // Update UI
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });

            filterAndRender();
        }

        function openDatePicker() {
            document.getElementById('startDate').value = STATE.dateRange.start.format('YYYY-MM-DD');
            document.getElementById('endDate').value = STATE.dateRange.end.format('YYYY-MM-DD');
            document.getElementById('dateModal').classList.remove('hidden');
        }

        function closeDatePicker() {
            document.getElementById('dateModal').classList.add('hidden');
        }

        function applyCustomDate() {
            const start = dayjs(document.getElementById('startDate').value);
            const end = dayjs(document.getElementById('endDate').value);

            if (start.isValid() && end.isValid() && start.isBefore(end)) {
                STATE.period = 'custom';
                STATE.dateRange = { start, end };

                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.period === 'custom');
                });

                closeDatePicker();
                filterAndRender();
            } else {
                alert('Please select a valid date range');
            }
        }

        // FILTER & RENDER
        function filterAndRender() {
            const { start, end } = STATE.dateRange;
            STATE.filtered = STATE.allTxns.filter(t => t.date.isBetween(start, end, 'day', '[]'));

            renderMetrics();
            renderDonutChart();
            renderIncomeExpenseBar();
            renderDailyChart();
            renderCumulativeChart();
            renderComparisonChart();
            renderCategories();
            renderMerchants();
            renderRecurring();
            renderRecentTxns();
            renderUncatAlert();
            renderQuickInsights();
        }

        // VIEW MODE TOGGLE
        function setViewMode(mode) {
            STATE.viewMode = mode;

            const parentBtn = document.getElementById('viewParent');
            const subcatBtn = document.getElementById('viewSubcat');

            if (mode === 'parent') {
                parentBtn.classList.add('bg-fact-ink', 'dark:bg-fact-dark-ink', 'text-white', 'dark:text-fact-dark-bg');
                parentBtn.classList.remove('text-fact-muted', 'dark:text-fact-dark-muted');
                subcatBtn.classList.remove('bg-fact-ink', 'dark:bg-fact-dark-ink', 'text-white', 'dark:text-fact-dark-bg');
                subcatBtn.classList.add('text-fact-muted', 'dark:text-fact-dark-muted');
            } else {
                subcatBtn.classList.add('bg-fact-ink', 'dark:bg-fact-dark-ink', 'text-white', 'dark:text-fact-dark-bg');
                subcatBtn.classList.remove('text-fact-muted', 'dark:text-fact-dark-muted');
                parentBtn.classList.remove('bg-fact-ink', 'dark:bg-fact-dark-ink', 'text-white', 'dark:text-fact-dark-bg');
                parentBtn.classList.add('text-fact-muted', 'dark:text-fact-dark-muted');
            }

            renderCategories();
            renderDonutChart();
        }

        // METRICS
        function renderMetrics() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const inc = STATE.filtered.filter(t => t.direction === 'IN');

            const totalSpend = out.reduce((s, t) => s + t.amount, 0);
            const totalIncome = inc.reduce((s, t) => s + t.amount, 0);
            const net = totalIncome - totalSpend;

            const daysTotal = STATE.dateRange.end.diff(STATE.dateRange.start, 'day') + 1;
            const daysPassed = dayjs().diff(STATE.dateRange.start, 'day') + 1;
            const daysLeft = Math.max(0, daysTotal - daysPassed);
            const dailyBudget = daysLeft > 0 ? net / daysLeft : 0;

            document.getElementById('metricIncome').textContent = formatNum(totalIncome);
            document.getElementById('metricSpent').textContent = formatNum(totalSpend);
            document.getElementById('metricNet').textContent = (net >= 0 ? '+' : '') + formatNum(net);
            document.getElementById('metricDaily').textContent = formatNum(Math.max(0, dailyBudget));
            document.getElementById('metricDaysLeft').textContent = `${daysLeft} days left`;

            const netDot = document.getElementById('netDot');
            netDot.classList.toggle('bg-fact-green', net >= 0);
            netDot.classList.toggle('bg-fact-red', net < 0);
        }

        // DONUT CHART
        function renderDonutChart() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');

            let labels, data, colors;

            if (STATE.viewMode === 'parent') {
                // Group by parent category
                const parentSpend = {};
                out.forEach(t => {
                    const parent = getParentCategory(t.category);
                    parentSpend[parent] = (parentSpend[parent] || 0) + t.amount;
                });

                // Sort by priority order
                const parentOrder = ['Essentials', 'Lifestyle', 'Growth', 'Financial', 'Other'];
                labels = parentOrder.filter(p => parentSpend[p] > 0);
                data = labels.map(p => parentSpend[p]);
                colors = labels.map(l => CAT_COLORS[l] || '#999');
            } else {
                // Original subcategory view
                const catSpend = {};
                out.forEach(t => catSpend[t.category] = (catSpend[t.category] || 0) + t.amount);

                const sorted = Object.entries(catSpend).sort((a, b) => b[1] - a[1]);
                labels = sorted.map(c => c[0]);
                data = sorted.map(c => c[1]);
                colors = labels.map(l => CAT_COLORS[l] || '#999');
            }

            const total = data.reduce((s, v) => s + v, 0);
            document.getElementById('donutTotal').textContent = formatNum(total);

            const ctx = document.getElementById('donutChart');
            if (charts.donut) charts.donut.destroy();

            charts.donut = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            if (STATE.viewMode === 'parent') {
                                openParentDrilldown(labels[idx]);
                            } else {
                                openDrilldown(labels[idx]);
                            }
                        }
                    }
                }
            });
        }

        // INCOME VS EXPENSE BAR
        function renderIncomeExpenseBar() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const inc = STATE.filtered.filter(t => t.direction === 'IN');

            const totalSpend = out.reduce((s, t) => s + t.amount, 0);
            const totalIncome = inc.reduce((s, t) => s + t.amount, 0);
            const max = Math.max(totalIncome, totalSpend) || 1;

            document.getElementById('incomeBarLabel').textContent = formatNum(totalIncome);
            document.getElementById('expenseBarLabel').textContent = formatNum(totalSpend);
            document.getElementById('incomeBar').style.width = `${(totalIncome / max) * 100}%`;
            document.getElementById('expenseBar').style.width = `${(totalSpend / max) * 100}%`;
        }

        // DAILY CHART
        function renderDailyChart() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const dailySpend = {};

            out.forEach(t => {
                const key = t.date.format('YYYY-MM-DD');
                dailySpend[key] = (dailySpend[key] || 0) + t.amount;
            });

            const days = [];
            let d = STATE.dateRange.start;
            while (d.isBefore(STATE.dateRange.end) || d.isSame(STATE.dateRange.end, 'day')) {
                days.push(d.format('YYYY-MM-DD'));
                d = d.add(1, 'day');
            }

            const labels = days.map(d => dayjs(d).format('MMM D'));
            const data = days.map(d => dailySpend[d] || 0);

            const ctx = document.getElementById('dailyChart');
            if (charts.daily) charts.daily.destroy();

            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            charts.daily = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: '#F4C44E',
                        borderRadius: 3,
                        barThickness: Math.min(16, Math.max(4, 400 / days.length))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: isDark ? '#888' : '#666',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            grid: { color: isDark ? '#2A2A2A' : '#E5E5E5' },
                            ticks: { color: isDark ? '#888' : '#666' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // CUMULATIVE CHART
        function renderCumulativeChart() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT').sort((a, b) => a.date - b.date);
            const dailySpend = {};

            out.forEach(t => {
                const key = t.date.format('YYYY-MM-DD');
                dailySpend[key] = (dailySpend[key] || 0) + t.amount;
            });

            const days = [];
            let d = STATE.dateRange.start;
            while (d.isBefore(STATE.dateRange.end) || d.isSame(STATE.dateRange.end, 'day')) {
                days.push(d.format('YYYY-MM-DD'));
                d = d.add(1, 'day');
            }

            let cumulative = 0;
            const data = days.map(d => {
                cumulative += (dailySpend[d] || 0);
                return cumulative;
            });

            const labels = days.map(d => dayjs(d).format('MMM D'));

            const ctx = document.getElementById('cumulativeChart');
            if (charts.cumulative) charts.cumulative.destroy();

            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            charts.cumulative = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data,
                        borderColor: '#B593C6',
                        backgroundColor: 'rgba(181, 147, 198, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: isDark ? '#888' : '#666',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            grid: { color: isDark ? '#2A2A2A' : '#E5E5E5' },
                            ticks: { color: isDark ? '#888' : '#666' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // COMPARISON CHART
        function renderComparisonChart() {
            const now = dayjs();
            const thisMonthStart = now.startOf('month');
            const thisMonthEnd = now;
            const lastMonthStart = now.subtract(1, 'month').startOf('month');
            const lastMonthEnd = now.subtract(1, 'month').endOf('month');

            const thisMonthTxns = STATE.allTxns.filter(t => t.direction === 'OUT' && t.date.isBetween(thisMonthStart, thisMonthEnd, 'day', '[]'));
            const lastMonthTxns = STATE.allTxns.filter(t => t.direction === 'OUT' && t.date.isBetween(lastMonthStart, lastMonthEnd, 'day', '[]'));

            const thisMonthSpend = {};
            const lastMonthSpend = {};

            thisMonthTxns.forEach(t => thisMonthSpend[t.category] = (thisMonthSpend[t.category] || 0) + t.amount);
            lastMonthTxns.forEach(t => lastMonthSpend[t.category] = (lastMonthSpend[t.category] || 0) + t.amount);

            const allCats = [...new Set([...Object.keys(thisMonthSpend), ...Object.keys(lastMonthSpend)])];
            const sortedCats = allCats.sort((a, b) => (thisMonthSpend[b] || 0) - (thisMonthSpend[a] || 0)).slice(0, 8);

            const ctx = document.getElementById('comparisonChart');
            if (charts.comparison) charts.comparison.destroy();

            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            charts.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCats,
                    datasets: [
                        {
                            label: 'This Month',
                            data: sortedCats.map(c => thisMonthSpend[c] || 0),
                            backgroundColor: '#F4C44E',
                            borderRadius: 4
                        },
                        {
                            label: 'Last Month',
                            data: sortedCats.map(c => lastMonthSpend[c] || 0),
                            backgroundColor: isDark ? '#555' : '#D1D1D1',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: isDark ? '#888' : '#666', maxRotation: 45 }
                        },
                        y: {
                            grid: { color: isDark ? '#2A2A2A' : '#E5E5E5' },
                            ticks: { color: isDark ? '#888' : '#666' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // CATEGORIES LIST (Dimension-based)
        function renderCategories() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const container = document.getElementById('categoryList');

            if (STATE.viewMode === 'parent') {
                // Group by summary group
                const groupSpend = {};
                const groupCount = {};
                const typeBreakdown = {};

                out.forEach(t => {
                    const group = t.summaryGroup || 'Other';
                    groupSpend[group] = (groupSpend[group] || 0) + t.amount;
                    groupCount[group] = (groupCount[group] || 0) + 1;
                    if (!typeBreakdown[group]) typeBreakdown[group] = {};
                    typeBreakdown[group][t.merchantType] = (typeBreakdown[group][t.merchantType] || 0) + t.amount;
                });

                // Sort groups by defined order
                const groupOrder = ['Essentials', 'Food & Drinks', 'Shopping & Fun', 'Family', 'Other'];
                const total = Object.values(groupSpend).reduce((s, v) => s + v, 0) || 1;

                container.innerHTML = groupOrder
                    .filter(g => groupSpend[g] > 0)
                    .map(group => {
                        const amount = groupSpend[group];
                        const count = groupCount[group];
                        const pct = (amount / total * 100).toFixed(1);
                        const color = SUMMARY_GROUPS[group]?.color || '#95A5A6';
                        const icon = SUMMARY_GROUPS[group]?.icon || 'üìã';

                        // Top merchant types
                        const types = Object.entries(typeBreakdown[group] || {})
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 3)
                            .map(([type]) => type)
                            .join(', ');

                        return `
                            <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition" onclick="openGroupDrilldown('${group}')">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg" style="background:${color}20">${icon}</div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="font-semibold text-sm">${group}</span>
                                            <span class="font-display font-bold text-sm">${formatNum(amount)}</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="flex-1 h-2 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                                <div class="h-full rounded-full transition-all" style="width:${pct}%;background:${color}"></div>
                                            </div>
                                            <span class="text-[10px] text-fact-muted dark:text-fact-dark-muted w-12 text-right">${pct}%</span>
                                        </div>
                                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mt-1">${types} ¬∑ ${count} txns</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
            } else {
                // Detailed merchant type view
                const typeSpend = {};
                out.forEach(t => typeSpend[t.merchantType] = (typeSpend[t.merchantType] || 0) + t.amount);

                const sorted = Object.entries(typeSpend).sort((a, b) => b[1] - a[1]);
                const total = sorted.reduce((s, c) => s + c[1], 0) || 1;

                container.innerHTML = sorted.map(([type, amount]) => {
                    const pct = (amount / total * 100).toFixed(1);
                    const color = getTypeColor(type);
                    const icon = MERCHANT_TYPES[type]?.icon || 'üìã';
                    const count = out.filter(t => t.merchantType === type).length;
                    const group = getSummaryGroup(type);

                    return `
                        <div class="p-4 flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition" onclick="openTypeDrilldown('${type}')">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm" style="background:${color}20">${icon}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-1">
                                    <div>
                                        <span class="font-medium text-sm truncate">${type}</span>
                                        <span class="text-[10px] text-fact-muted dark:text-fact-dark-muted ml-2">${group}</span>
                                    </div>
                                    <span class="font-display font-semibold text-sm">${formatNum(amount)}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 h-1.5 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                        <div class="h-full rounded-full" style="width:${pct}%;background:${color}"></div>
                                    </div>
                                    <span class="text-[10px] text-fact-muted dark:text-fact-dark-muted w-12 text-right">${pct}%</span>
                                </div>
                            </div>
                            <span class="text-xs text-fact-muted dark:text-fact-dark-muted">${count}x</span>
                        </div>
                    `;
                }).join('');
            }
        }

        // Drilldown for summary group
        function openGroupDrilldown(group) {
            const types = SUMMARY_GROUPS[group]?.types || [];
            const out = STATE.filtered.filter(t => t.direction === 'OUT' && types.includes(t.merchantType));
            showFilteredResults(out, `${SUMMARY_GROUPS[group]?.icon || 'üìã'} ${group}`);
        }

        // Drilldown for merchant type
        function openTypeDrilldown(type) {
            const out = STATE.filtered.filter(t => t.direction === 'OUT' && t.merchantType === type);
            showFilteredResults(out, `${MERCHANT_TYPES[type]?.icon || 'üìã'} ${type}`);
        }

        // MERCHANTS LIST
        function renderMerchants() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const merchants = {};

            out.forEach(t => {
                if (!merchants[t.consolidated]) {
                    merchants[t.consolidated] = { count: 0, total: 0, merchantType: t.merchantType };
                }
                merchants[t.consolidated].count++;
                merchants[t.consolidated].total += t.amount;
            });

            const sorted = Object.entries(merchants)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 8);

            const container = document.getElementById('merchantList');
            const maxTotal = sorted[0]?.total || 1;

            container.innerHTML = sorted.map(m => {
                const color = getTypeColor(m.merchantType);
                const icon = MERCHANT_TYPES[m.merchantType]?.icon || 'üìã';
                const pct = (m.total / maxTotal * 100);

                return `
                    <div class="p-4 flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition" onclick="openMerchantDrilldown('${m.name.replace(/'/g, "\\'")}')">
                        <div class="w-2 h-2 rounded-full flex-shrink-0" style="background:${color}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-medium text-sm truncate">${m.name}</span>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-800 rounded-full text-fact-muted dark:text-fact-dark-muted">${m.count}x</span>
                                    <span class="font-display font-semibold text-sm">${formatNum(m.total)}</span>
                                </div>
                            </div>
                            <div class="h-1 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full rounded-full" style="width:${pct}%;background:${color}"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (sorted.length === 0) {
                container.innerHTML = '<div class="p-4 text-sm text-fact-muted dark:text-fact-dark-muted text-center">No transactions in this period</div>';
            }
        }

        // RECURRING
        function renderRecurring() {
            const out = STATE.allTxns.filter(t => t.direction === 'OUT');
            const byMerch = {};

            out.forEach(t => {
                if (!byMerch[t.consolidated]) byMerch[t.consolidated] = [];
                byMerch[t.consolidated].push(t);
            });

            const subs = [];
            Object.entries(byMerch).forEach(([name, arr]) => {
                if (arr.length < 2) return;
                arr.sort((a, b) => a.date - b.date);
                const intervals = [];
                for (let i = 1; i < arr.length; i++) {
                    intervals.push(arr[i].date.diff(arr[i-1].date, 'day'));
                }
                const avg = intervals.reduce((s, i) => s + i, 0) / intervals.length;
                if (avg >= 25 && avg <= 35) {
                    const avgAmount = arr.reduce((s, t) => s + t.amount, 0) / arr.length;
                    subs.push({ name, amount: avgAmount, freq: Math.round(avg), count: arr.length, cat: arr[0].category });
                }
            });

            const container = document.getElementById('recurringList');
            if (!subs.length) {
                container.innerHTML = '<div class="p-4 text-sm text-fact-muted dark:text-fact-dark-muted text-center">No recurring payments detected</div>';
                return;
            }

            container.innerHTML = subs.sort((a, b) => b.amount - a.amount).slice(0, 6).map(s => {
                const color = CAT_COLORS[s.cat] || '#999';
                return `
                    <div class="p-4 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full" style="background:${color}"></div>
                            <div>
                                <div class="font-medium text-sm">${s.name}</div>
                                <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">~${s.freq} days ¬∑ ${s.count} payments</div>
                            </div>
                        </div>
                        <div class="font-display font-semibold text-sm">${formatNum(s.amount)}</div>
                    </div>
                `;
            }).join('');
        }

        // RECENT TRANSACTIONS
        function renderRecentTxns() {
            const recent = STATE.filtered.slice(0, 8);
            document.getElementById('txnCountLabel').textContent = `${STATE.filtered.length} transactions`;

            const container = document.getElementById('recentTxns');
            container.innerHTML = recent.map(t => renderTxnRow(t)).join('');
        }

        function renderTxnRow(t) {
            const isOut = t.direction === 'OUT';
            const isUncat = t.category === 'Uncategorized';
            const color = CAT_COLORS[t.category] || '#999';

            return `
                <div class="txn-row ${isUncat ? 'uncat' : ''} p-3 flex items-center justify-between cursor-pointer" onclick="openCatModal('${t.raw.replace(/'/g, "\\'")}')">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-2 h-2 rounded-full flex-shrink-0" style="background:${color}"></div>
                        <div class="min-w-0">
                            <div class="font-medium text-sm truncate">${t.display}</div>
                            <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">${t.date.format('MMM D, HH:mm')}</div>
                        </div>
                    </div>
                    <div class="font-display font-semibold text-sm ${isOut ? '' : 'text-fact-green'}">${isOut ? '' : '+'}${formatNum(t.amount)}</div>
                </div>
            `;
        }

        // UNCATEGORIZED ALERT
        function renderUncatAlert() {
            const uncat = STATE.filtered.filter(t => t.category === 'Uncategorized' && t.direction === 'OUT');
            const count = uncat.length;
            const amount = uncat.reduce((s, t) => s + t.amount, 0);

            const alert = document.getElementById('uncatAlert');
            alert.classList.toggle('hidden', count === 0);
            document.getElementById('uncatCount').textContent = count;
            document.getElementById('uncatAmount').textContent = formatNum(amount);
        }

        // DRILLDOWN MODAL
        function openDrilldown(category) {
            const out = STATE.filtered.filter(t => t.direction === 'OUT' && t.category === category);
            const total = out.reduce((s, t) => s + t.amount, 0);

            // Calculate delta vs previous period
            const periodDays = STATE.dateRange.end.diff(STATE.dateRange.start, 'day');
            const prevStart = STATE.dateRange.start.subtract(periodDays + 1, 'day');
            const prevEnd = STATE.dateRange.start.subtract(1, 'day');
            const prevTxns = STATE.allTxns.filter(t => t.direction === 'OUT' && t.category === category && t.date.isBetween(prevStart, prevEnd, 'day', '[]'));
            const prevTotal = prevTxns.reduce((s, t) => s + t.amount, 0);
            const delta = prevTotal > 0 ? ((total - prevTotal) / prevTotal * 100) : 0;

            document.getElementById('drilldownTitle').textContent = category;
            document.getElementById('drilldownSubtitle').textContent = `${out.length} transactions`;
            document.getElementById('drilldownTotal').textContent = `QAR ${formatNum(total)}`;
            document.getElementById('drilldownDelta').textContent = (delta >= 0 ? '+' : '') + delta.toFixed(0) + '%';
            document.getElementById('drilldownDelta').className = `font-display font-bold text-2xl ${delta <= 0 ? 'text-fact-green' : 'text-fact-red'}`;

            // Timeline
            const dailySpend = {};
            out.forEach(t => {
                const key = t.date.format('YYYY-MM-DD');
                dailySpend[key] = (dailySpend[key] || 0) + t.amount;
            });

            const days = [];
            let d = STATE.dateRange.start;
            while (d.isBefore(STATE.dateRange.end) || d.isSame(STATE.dateRange.end, 'day')) {
                days.push(d.format('YYYY-MM-DD'));
                d = d.add(1, 'day');
            }

            const ctx = document.getElementById('drilldownTimeline');
            if (charts.drilldownTimeline) charts.drilldownTimeline.destroy();

            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const color = CAT_COLORS[category] || '#999';

            charts.drilldownTimeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days.map(d => dayjs(d).format('D')),
                    datasets: [{
                        data: days.map(d => dailySpend[d] || 0),
                        backgroundColor: color,
                        borderRadius: 2,
                        barThickness: Math.min(10, Math.max(2, 300 / days.length))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, beginAtZero: true }
                    }
                }
            });

            // Merchants with count
            const merchants = {};
            out.forEach(t => {
                if (!merchants[t.consolidated]) {
                    merchants[t.consolidated] = { total: 0, count: 0 };
                }
                merchants[t.consolidated].total += t.amount;
                merchants[t.consolidated].count++;
            });
            const sortedMerch = Object.entries(merchants)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);
            const maxMerch = sortedMerch[0]?.total || 1;

            document.getElementById('drilldownMerchants').innerHTML = `
                <p class="text-xs font-medium mb-2">Top Merchants</p>
                ${sortedMerch.map(m => `
                    <div class="flex items-center gap-2 cursor-pointer hover:opacity-80" onclick="closeDrilldown(); openMerchantDrilldown('${m.name.replace(/'/g, "\\'")}')">
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between text-xs mb-0.5">
                                <span class="truncate">${m.name}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] text-fact-muted dark:text-fact-dark-muted">${m.count}x</span>
                                    <span class="font-medium">${formatNum(m.total)}</span>
                                </div>
                            </div>
                            <div class="h-1.5 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full rounded-full" style="width:${(m.total/maxMerch*100)}%;background:${color}"></div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;

            // Transactions
            document.getElementById('drilldownTxns').innerHTML = out.slice(0, 20).map(t => renderTxnRow(t)).join('');

            document.getElementById('drilldownModal').classList.remove('hidden');
        }

        function closeDrilldown() {
            document.getElementById('drilldownModal').classList.add('hidden');
        }

        // PARENT CATEGORY DRILLDOWN
        function openParentDrilldown(parentCategory) {
            const subcats = CATEGORY_HIERARCHY[parentCategory]?.subcategories || [];
            const out = STATE.filtered.filter(t => t.direction === 'OUT' && subcats.includes(t.category));
            const total = out.reduce((s, t) => s + t.amount, 0);

            // Calculate delta vs previous period
            const periodDays = STATE.dateRange.end.diff(STATE.dateRange.start, 'day');
            const prevStart = STATE.dateRange.start.subtract(periodDays + 1, 'day');
            const prevEnd = STATE.dateRange.start.subtract(1, 'day');
            const prevTxns = STATE.allTxns.filter(t => t.direction === 'OUT' && subcats.includes(t.category) && t.date.isBetween(prevStart, prevEnd, 'day', '[]'));
            const prevTotal = prevTxns.reduce((s, t) => s + t.amount, 0);
            const delta = prevTotal > 0 ? ((total - prevTotal) / prevTotal * 100) : 0;

            const icon = CATEGORY_HIERARCHY[parentCategory]?.icon || 'üì¶';
            document.getElementById('drilldownTitle').textContent = `${icon} ${parentCategory}`;
            document.getElementById('drilldownSubtitle').textContent = `${out.length} transactions ¬∑ ${subcats.length} subcategories`;
            document.getElementById('drilldownTotal').textContent = `QAR ${formatNum(total)}`;
            document.getElementById('drilldownDelta').textContent = (delta >= 0 ? '+' : '') + delta.toFixed(0) + '%';
            document.getElementById('drilldownDelta').className = `font-display font-bold text-2xl ${delta <= 0 ? 'text-fact-green' : 'text-fact-red'}`;

            // Timeline by subcategory
            const color = CAT_COLORS[parentCategory];
            const dailySpend = {};
            out.forEach(t => {
                const key = t.date.format('YYYY-MM-DD');
                dailySpend[key] = (dailySpend[key] || 0) + t.amount;
            });

            const days = [];
            let d = STATE.dateRange.start;
            while (d.isBefore(STATE.dateRange.end) || d.isSame(STATE.dateRange.end, 'day')) {
                days.push(d.format('YYYY-MM-DD'));
                d = d.add(1, 'day');
            }

            const ctx = document.getElementById('drilldownTimeline');
            if (charts.drilldownTimeline) charts.drilldownTimeline.destroy();

            charts.drilldownTimeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days.map(d => dayjs(d).format('D')),
                    datasets: [{
                        data: days.map(d => dailySpend[d] || 0),
                        backgroundColor: color,
                        borderRadius: 2,
                        barThickness: Math.min(10, Math.max(2, 300 / days.length))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, beginAtZero: true }
                    }
                }
            });

            // Subcategory breakdown (instead of merchants)
            const subcatSpend = {};
            out.forEach(t => {
                subcatSpend[t.category] = (subcatSpend[t.category] || 0) + t.amount;
            });
            const sortedSubs = Object.entries(subcatSpend).sort((a, b) => b[1] - a[1]);
            const maxSub = sortedSubs[0]?.[1] || 1;

            document.getElementById('drilldownMerchants').innerHTML = `
                <p class="text-xs font-medium mb-2 -mt-2">Subcategories</p>
                ${sortedSubs.map(([name, amt]) => {
                    const subColor = CAT_COLORS[name] || color;
                    return `
                        <div class="flex items-center gap-2 cursor-pointer hover:opacity-80" onclick="closeDrilldown(); openDrilldown('${name}')">
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between text-xs mb-0.5">
                                    <span class="truncate">${name}</span>
                                    <span class="font-medium">${formatNum(amt)}</span>
                                </div>
                                <div class="h-1.5 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full" style="width:${(amt/maxSub*100)}%;background:${subColor}"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;

            // Transactions
            document.getElementById('drilldownTxns').innerHTML = out.slice(0, 20).map(t => renderTxnRow(t)).join('');

            document.getElementById('drilldownModal').classList.remove('hidden');
        }

        // MERCHANT DRILLDOWN
        function openMerchantDrilldown(merchantName) {
            const out = STATE.filtered.filter(t => t.direction === 'OUT' && t.consolidated === merchantName);
            const total = out.reduce((s, t) => s + t.amount, 0);
            const avgTxn = out.length > 0 ? total / out.length : 0;

            document.getElementById('drilldownTitle').textContent = merchantName;
            document.getElementById('drilldownSubtitle').textContent = `${out.length} transactions ¬∑ Avg: QAR ${formatNum(avgTxn)}`;
            document.getElementById('drilldownTotal').textContent = `QAR ${formatNum(total)}`;

            // Calculate delta vs previous period
            const periodDays = STATE.dateRange.end.diff(STATE.dateRange.start, 'day');
            const prevStart = STATE.dateRange.start.subtract(periodDays + 1, 'day');
            const prevEnd = STATE.dateRange.start.subtract(1, 'day');
            const prevTxns = STATE.allTxns.filter(t => t.direction === 'OUT' && t.consolidated === merchantName && t.date.isBetween(prevStart, prevEnd, 'day', '[]'));
            const prevTotal = prevTxns.reduce((s, t) => s + t.amount, 0);
            const delta = prevTotal > 0 ? ((total - prevTotal) / prevTotal * 100) : 0;

            document.getElementById('drilldownDelta').textContent = (delta >= 0 ? '+' : '') + delta.toFixed(0) + '%';
            document.getElementById('drilldownDelta').className = `font-display font-bold text-2xl ${delta <= 0 ? 'text-fact-green' : 'text-fact-red'}`;

            const category = out[0]?.category || 'Other';
            const color = CAT_COLORS[category] || '#999';

            // Timeline
            const dailySpend = {};
            out.forEach(t => {
                const key = t.date.format('YYYY-MM-DD');
                dailySpend[key] = (dailySpend[key] || 0) + t.amount;
            });

            const days = [];
            let d = STATE.dateRange.start;
            while (d.isBefore(STATE.dateRange.end) || d.isSame(STATE.dateRange.end, 'day')) {
                days.push(d.format('YYYY-MM-DD'));
                d = d.add(1, 'day');
            }

            const ctx = document.getElementById('drilldownTimeline');
            if (charts.drilldownTimeline) charts.drilldownTimeline.destroy();

            charts.drilldownTimeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days.map(d => dayjs(d).format('D')),
                    datasets: [{
                        data: days.map(d => dailySpend[d] || 0),
                        backgroundColor: color,
                        borderRadius: 2,
                        barThickness: Math.min(10, Math.max(2, 300 / days.length))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, beginAtZero: true }
                    }
                }
            });

            // Show category & stats instead of merchants
            document.getElementById('drilldownMerchants').innerHTML = `
                <div class="grid grid-cols-3 gap-3">
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Transactions</div>
                        <div class="font-display font-bold">${out.length}</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Average</div>
                        <div class="font-display font-bold">${formatNum(avgTxn)}</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Category</div>
                        <div class="font-display font-bold text-sm truncate">${category}</div>
                    </div>
                </div>
            `;

            // Transactions
            document.getElementById('drilldownTxns').innerHTML = out.slice(0, 30).map(t => renderTxnRow(t)).join('');

            document.getElementById('drilldownModal').classList.remove('hidden');
        }

        // MERCHANT MODAL
        function openMerchantModal() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const merchants = {};

            out.forEach(t => {
                if (!merchants[t.consolidated]) {
                    merchants[t.consolidated] = { count: 0, total: 0, category: t.category };
                }
                merchants[t.consolidated].count++;
                merchants[t.consolidated].total += t.amount;
            });

            STATE.allMerchants = Object.entries(merchants)
                .map(([name, data]) => ({ name, ...data }));

            document.getElementById('merchantModalCount').textContent = `${STATE.allMerchants.length} merchants`;
            document.getElementById('merchantSearch').value = '';
            document.getElementById('merchantSort').value = 'amount';
            filterMerchantModal();
            document.getElementById('merchantModal').classList.remove('hidden');
        }

        function closeMerchantModal() {
            document.getElementById('merchantModal').classList.add('hidden');
        }

        function filterMerchantModal() {
            const search = document.getElementById('merchantSearch').value.toLowerCase();
            const sortBy = document.getElementById('merchantSort').value;

            let merchants = STATE.allMerchants || [];
            if (search) {
                merchants = merchants.filter(m => m.name.toLowerCase().includes(search));
            }

            merchants.sort((a, b) => {
                if (sortBy === 'amount') return b.total - a.total;
                if (sortBy === 'count') return b.count - a.count;
                return a.name.localeCompare(b.name);
            });

            const maxTotal = merchants[0]?.total || 1;

            document.getElementById('merchantModalList').innerHTML = merchants.slice(0, 50).map(m => {
                const color = CAT_COLORS[m.category] || '#999';
                const pct = (m.total / maxTotal * 100);

                return `
                    <div class="p-4 flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition" onclick="closeMerchantModal(); openMerchantDrilldown('${m.name.replace(/'/g, "\\'")}')">
                        <div class="w-2 h-2 rounded-full flex-shrink-0" style="background:${color}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-medium text-sm truncate">${m.name}</span>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-800 rounded-full text-fact-muted dark:text-fact-dark-muted">${m.count}x</span>
                                    <span class="font-display font-semibold text-sm w-20 text-right">${formatNum(m.total)}</span>
                                </div>
                            </div>
                            <div class="h-1 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full rounded-full" style="width:${pct}%;background:${color}"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // UNCATEGORIZED MODAL
        function openUncatModal() {
            const uncat = STATE.filtered.filter(t => t.category === 'Uncategorized' && t.direction === 'OUT');

            document.getElementById('uncatList').innerHTML = uncat.map(t => `
                <div class="p-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer" onclick="closeUncatModal(); openCatModal('${t.raw.replace(/'/g, "\\'")}')">
                    <div class="min-w-0">
                        <div class="font-medium text-sm truncate">${t.raw}</div>
                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">${t.date.format('MMM D, HH:mm')}</div>
                    </div>
                    <div class="font-display font-semibold text-sm">${formatNum(t.amount)}</div>
                </div>
            `).join('');

            document.getElementById('uncatModal').classList.remove('hidden');
        }

        function closeUncatModal() {
            document.getElementById('uncatModal').classList.add('hidden');
        }

        // CATEGORIZE MODAL
        function openCatModal(raw) {
            STATE.catTarget = raw;
            document.getElementById('catModalRaw').textContent = raw;
            document.getElementById('catModalName').value = '';
            document.getElementById('catModal').classList.remove('hidden');
        }

        function closeCatModal() {
            document.getElementById('catModal').classList.add('hidden');
        }

        function saveCategorization() {
            const raw = STATE.catTarget;
            const name = document.getElementById('catModalName').value || raw;
            const cat = document.getElementById('catModalCat').value;

            if (!cat) {
                alert('Please select a category');
                return;
            }

            STATE.localMappings[raw.toLowerCase()] = { display: name, consolidated: name, category: cat };
            saveLocal();

            STATE.allTxns.forEach(t => {
                if (t.raw.toLowerCase() === raw.toLowerCase()) {
                    t.display = name;
                    t.consolidated = name;
                    t.category = cat;
                }
            });

            closeCatModal();
            filterAndRender();
        }

        function updateCatDropdowns() {
            const cats = Array.from(STATE.categories).filter(c => c !== 'Uncategorized').sort();
            
            document.getElementById('catModalCat').innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('txnFilter').innerHTML = '<option value="">All Categories</option>' + 
                Array.from(STATE.categories).sort().map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // ALL TRANSACTIONS MODAL
        function openTxnModal() {
            document.getElementById('txnModalCount').textContent = `${STATE.filtered.length} transactions`;
            document.getElementById('txnSearch').value = '';
            document.getElementById('txnFilter').value = '';
            renderTxnModal(STATE.filtered);
            document.getElementById('txnModal').classList.remove('hidden');
        }

        function closeTxnModal() {
            document.getElementById('txnModal').classList.add('hidden');
        }

        function filterTxnModal() {
            const search = document.getElementById('txnSearch').value.toLowerCase();
            const cat = document.getElementById('txnFilter').value;

            let txns = STATE.filtered;
            if (search) txns = txns.filter(t => t.display.toLowerCase().includes(search) || t.raw.toLowerCase().includes(search));
            if (cat) txns = txns.filter(t => t.category === cat);

            document.getElementById('txnModalCount').textContent = `${txns.length} transactions`;
            renderTxnModal(txns);
        }

        function renderTxnModal(txns) {
            document.getElementById('txnModalList').innerHTML = txns.slice(0, 100).map(t => renderTxnRow(t)).join('');
        }

        // ============== FRONTEND AI INTEGRATION (via GAS proxy) ==============

        function openAIQuery() {
            document.getElementById('aiModal').classList.remove('hidden');
        }

        function closeAIQuery() {
            document.getElementById('aiModal').classList.add('hidden');
        }

        async function askAI(question) {
            const query = question || document.getElementById('aiQueryInput').value.trim();
            if (!query) return;

            if (CONFIG.GAS_URL === '') {
                document.getElementById('aiResponse').innerHTML = '<p class="text-fact-red">Please update CONFIG.GAS_URL in track_spend.html with your deployed GAS URL</p>';
                return;
            }

            const responseDiv = document.getElementById('aiResponse');
            responseDiv.innerHTML = '<p class="text-fact-muted animate-pulse">Analyzing your spending...</p>';

            // Prepare transaction summary and encode it
            const txnSummary = prepareTransactionSummary();
            const encodedData = btoa(unescape(encodeURIComponent(txnSummary)));

            try {
                // Call GAS proxy endpoint
                const url = `${CONFIG.GAS_URL}?action=ai&q=${encodeURIComponent(query)}&data=${encodeURIComponent(encodedData)}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const answer = data.answer;
                responseDiv.innerHTML = marked ? marked.parse(answer) : answer.replace(/\n/g, '<br>');

            } catch (err) {
                responseDiv.innerHTML = `<p class="text-fact-red">Error: ${err.message}</p>`;
            }

            document.getElementById('aiQueryInput').value = '';
        }

        function prepareTransactionSummary() {
            const txns = STATE.filtered.filter(t => t.direction === 'OUT');

            // Group by merchant type
            const byType = {};
            txns.forEach(t => {
                if (!byType[t.merchantType]) byType[t.merchantType] = { total: 0, count: 0, txns: [] };
                byType[t.merchantType].total += t.amount;
                byType[t.merchantType].count++;
                byType[t.merchantType].txns.push(t);
            });

            // Build summary
            let summary = `Period: ${STATE.dateRange.start.format('MMM D')} - ${STATE.dateRange.end.format('MMM D, YYYY')}\n`;
            summary += `Total Transactions: ${txns.length}\n`;
            summary += `Total Spent: QAR ${formatNum(txns.reduce((s, t) => s + t.amount, 0))}\n\n`;

            summary += `By Type:\n`;
            Object.entries(byType)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([type, data]) => {
                    summary += `- ${type}: QAR ${formatNum(data.total)} (${data.count} txns)\n`;
                });

            summary += `\nRecent transactions (last 30):\n`;
            txns.slice(0, 30).forEach(t => {
                summary += `${t.date.format('MMM D HH:mm')} | ${t.display} | QAR ${formatNum(t.amount)} | ${t.merchantType} | ${t.dims.when.join(', ')} | ${t.dims.pattern}\n`;
            });

            return summary;
        }

        // Quick insights generation
        function renderQuickInsights() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const insights = [];

            // Night out patterns
            const nightOuts = out.filter(t => t.dims.pattern === 'Night Out');
            if (nightOuts.length > 0) {
                const total = nightOuts.reduce((s, t) => s + t.amount, 0);
                insights.push({
                    icon: 'üéâ',
                    text: `${nightOuts.length} Night Out transactions totaling QAR ${formatNum(total)}`,
                    filter: 'nightOut'
                });
            }

            // Work expense candidates
            const workExpenses = out.filter(t => t.dims.pattern === 'Work Expense');
            if (workExpenses.length > 0) {
                const total = workExpenses.reduce((s, t) => s + t.amount, 0);
                insights.push({
                    icon: 'üíº',
                    text: `${workExpenses.length} potential work expenses (QAR ${formatNum(total)})`,
                    filter: 'workHours'
                });
            }

            // Splurges
            const splurges = out.filter(t => t.dims.pattern === 'Splurge');
            if (splurges.length > 0) {
                const total = splurges.reduce((s, t) => s + t.amount, 0);
                insights.push({
                    icon: 'üí∏',
                    text: `${splurges.length} splurge purchases (QAR ${formatNum(total)})`,
                    filter: 'splurge'
                });
            }

            // Subscriptions
            const subs = out.filter(t => t.dims.pattern === 'Subscription');
            if (subs.length > 0) {
                const merchants = [...new Set(subs.map(t => t.consolidated))];
                insights.push({
                    icon: 'üìÖ',
                    text: `${merchants.length} detected subscriptions`,
                    filter: 'subscription'
                });
            }

            // Late night spending
            const lateNight = out.filter(t => t.isLateNight);
            if (lateNight.length >= 3) {
                const total = lateNight.reduce((s, t) => s + t.amount, 0);
                insights.push({
                    icon: 'üåô',
                    text: `QAR ${formatNum(total)} spent late at night (${lateNight.length} txns)`,
                    filter: 'lateNight'
                });
            }

            // Large purchases
            const large = out.filter(t => t.isLarge);
            if (large.length > 0) {
                insights.push({
                    icon: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
                    text: `${large.length} large purchases (500+ QAR each)`,
                    filter: 'large'
                });
            }

            const container = document.getElementById('quickInsights');
            if (insights.length === 0) {
                container.innerHTML = '<div class="text-sm text-fact-muted dark:text-fact-dark-muted">No notable patterns detected in this period.</div>';
                return;
            }

            container.innerHTML = insights.map(i => `
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition" onclick="filterByDimension('${i.filter}')">
                    <span class="text-lg">${i.icon}</span>
                    <span class="text-sm">${i.text}</span>
                    <span class="text-xs text-fact-yellow ml-auto">View ‚Üí</span>
                </div>
            `).join('');
        }

        // ============== DIMENSION FILTERING ==============

        function filterByDimension(dimension) {
            let filtered = [];
            let title = '';

            const out = STATE.filtered.filter(t => t.direction === 'OUT');

            switch (dimension) {
                case 'workHours':
                    filtered = out.filter(t => t.isWorkHours);
                    title = 'üíº Work Hours Spending';
                    break;
                case 'lateNight':
                    filtered = out.filter(t => t.isLateNight);
                    title = 'üåô Late Night Spending';
                    break;
                case 'nightOut':
                    filtered = out.filter(t => t.dims.pattern === 'Night Out');
                    title = 'üéâ Night Out Sessions';
                    break;
                case 'splurge':
                    filtered = out.filter(t => t.dims.pattern === 'Splurge');
                    title = 'üí∏ Splurge Purchases';
                    break;
                case 'large':
                    filtered = out.filter(t => t.isLarge);
                    title = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ Large Purchases (500+ QAR)';
                    break;
                case 'subscription':
                    filtered = out.filter(t => t.dims.pattern === 'Subscription');
                    title = 'üìÖ Detected Subscriptions';
                    break;
                case 'clear':
                    closeFilteredModal();
                    return;
                default:
                    return;
            }

            showFilteredResults(filtered, title);
        }

        function showFilteredResults(txns, title) {
            const total = txns.reduce((s, t) => s + t.amount, 0);
            const avg = txns.length > 0 ? total / txns.length : 0;

            document.getElementById('filteredTitle').textContent = title;
            document.getElementById('filteredSubtitle').textContent = `${txns.length} transactions`;
            document.getElementById('filteredTotal').textContent = `QAR ${formatNum(total)}`;
            document.getElementById('filteredCount').textContent = txns.length;
            document.getElementById('filteredAvg').textContent = `QAR ${formatNum(avg)}`;

            document.getElementById('filteredList').innerHTML = txns.map(t => renderTxnRowEnhanced(t)).join('');

            document.getElementById('filteredModal').classList.remove('hidden');
        }

        function closeFilteredModal() {
            document.getElementById('filteredModal').classList.add('hidden');
        }

        function renderTxnRowEnhanced(t) {
            const isOut = t.direction === 'OUT';
            const color = getTypeColor(t.merchantType);
            const icon = MERCHANT_TYPES[t.merchantType]?.icon || 'üìã';
            const patternBadge = t.dims.pattern !== 'Normal' ?
                `<span class="text-[10px] px-1.5 py-0.5 rounded-full bg-gray-100 dark:bg-gray-800">${PATTERNS[t.dims.pattern]?.icon || ''} ${t.dims.pattern}</span>` : '';

            return `
                <div class="txn-row p-3 flex items-center justify-between">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm" style="background:${color}20">${icon}</div>
                        <div class="min-w-0">
                            <div class="font-medium text-sm truncate">${t.display}</div>
                            <div class="flex items-center gap-2 text-[10px] text-fact-muted dark:text-fact-dark-muted">
                                <span>${t.date.format('MMM D, HH:mm')}</span>
                                <span>¬∑</span>
                                <span>${t.dims.when.join(', ')}</span>
                                ${patternBadge}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-display font-semibold text-sm ${isOut ? '' : 'text-fact-green'}">${isOut ? '' : '+'}${formatNum(t.amount)}</div>
                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">${t.dims.size}</div>
                    </div>
                </div>
            `;
        }

        // ============== UTILS ==============

        function formatNum(n) {
            return Math.round(n).toLocaleString();
        }

        function debounce(fn, wait) {
            let t;
            return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
        }

        // Simple markdown parser fallback (if marked.js not loaded)
        const marked = window.marked || {
            parse: (text) => text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
        };
    </script>
</body>
</html>
