<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>QNB Finance Pro</title>
    
    <!-- Optimized Tech Stack -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>

    <script>
        dayjs.extend(dayjs_plugin_isBetween);
        dayjs.extend(dayjs_plugin_relativeTime);
        
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f5f3ff', 100: '#ede9fe', 200: '#ddd6fe', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9' },
                        dark: { bg: '#0f172a', card: '#1e293b', border: '#334155', hover: '#283548' }
                    },
                    spacing: {
                        'safe-b': 'env(safe-area-inset-bottom)',
                        'safe-t': 'env(safe-area-inset-top)'
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * { -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        .dark .skeleton {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 200% 100%;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Health Ring */
        .health-ring { transform: rotate(-90deg); }
        .health-ring circle { transition: stroke-dashoffset 0.8s ease-out; }
        
        /* Category Expansion */
        .cat-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .cat-details.open { max-height: 400px; }
        
        /* Bottom Nav (Mobile) */
        .bottom-nav {
            padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
        }
        
        /* Modal */
        .modal { display: none; position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.6); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-box { 
            background: white; 
            border-radius: 1rem; 
            width: 90%; 
            max-width: 420px; 
            max-height: 85vh; 
            overflow-y: auto;
            animation: modalIn 0.2s ease-out;
        }
        .dark .modal-box { background: #1e293b; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* Tooltip */
        [data-tip]:hover::after {
            content: attr(data-tip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 8px;
            padding: 4px 8px;
            background: #1e293b;
            color: white;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 50;
        }
        
        /* Responsive Breakpoints */
        /* iPhone 13: 390px */
        /* iPad Air 11": 820px */
        /* MBP 14": ~1512px */
        /* Studio Display: 2560px */
        
        @media (min-width: 768px) {
            .mobile-only { display: none !important; }
        }
        @media (max-width: 767px) {
            .desktop-only { display: none !important; }
        }
        
        /* Celebration */
        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .celebrate { animation: celebrate 0.4s ease-out; }
        
        /* Touch-friendly tap targets */
        .tap-target { min-height: 44px; min-width: 44px; }
        
        /* Chart container responsive */
        .chart-wrap { position: relative; width: 100%; }
    </style>
</head>

<body class="bg-gray-50 dark:bg-dark-bg text-slate-800 dark:text-slate-100 min-h-screen">
    
    <!-- DESKTOP/TABLET SIDEBAR -->
    <aside id="sidebar" class="desktop-only fixed left-0 top-0 h-full bg-white dark:bg-dark-card border-r border-gray-200 dark:border-dark-border z-40 transition-all duration-300 w-64 lg:w-64 md:w-16 flex flex-col">
        
        <!-- Logo -->
        <div class="p-4 lg:p-5 flex items-center gap-3 border-b border-gray-100 dark:border-dark-border">
            <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-brand-500 to-brand-700 text-white flex items-center justify-center font-bold text-lg shadow-lg shadow-brand-500/20 flex-shrink-0">Q</div>
            <span class="font-bold text-lg tracking-tight hidden lg:block">Finance Pro</span>
        </div>
        
        <!-- Nav -->
        <nav class="flex-1 p-2 lg:p-3 space-y-1 overflow-y-auto">
            <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-btn active w-full flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-xl transition tap-target relative" data-tip="Dashboard">
                <i class="fa-solid fa-chart-pie w-5 text-center text-lg"></i>
                <span class="hidden lg:inline">Dashboard</span>
            </button>
            <button onclick="switchView('transactions')" id="nav-transactions" class="nav-btn w-full flex items-center gap-3 px-3 py-3 text-sm font-medium rounded-xl transition tap-target relative" data-tip="Transactions">
                <i class="fa-solid fa-list w-5 text-center text-lg"></i>
                <span class="hidden lg:inline">Transactions</span>
            </button>
        </nav>
        
        <!-- Footer -->
        <div class="p-3 lg:p-4 border-t border-gray-100 dark:border-dark-border space-y-2">
            <!-- Uncategorized Alert -->
            <div id="uncatAlertDesktop" class="hidden p-2 lg:p-3 bg-red-50 dark:bg-red-900/20 rounded-lg cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/30 transition tap-target" onclick="openUncatModal()">
                <div class="flex items-center gap-2 text-red-600 dark:text-red-400 justify-center lg:justify-start">
                    <i class="fa-solid fa-circle-exclamation"></i>
                    <span class="text-sm font-medium hidden lg:inline"><span id="uncatCountDesktop">0</span> to fix</span>
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <button onclick="toggleTheme()" class="w-9 h-9 rounded-lg bg-gray-100 dark:bg-dark-border hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center justify-center transition tap-target">
                    <i id="themeIcon" class="fa-solid fa-moon text-gray-500"></i>
                </button>
                <button onclick="syncData()" id="syncBtn" class="w-9 h-9 rounded-lg bg-brand-50 dark:bg-brand-900/20 hover:bg-brand-100 flex items-center justify-center transition tap-target">
                    <i class="fa-solid fa-rotate text-brand-600" id="syncIcon"></i>
                </button>
            </div>
            
            <div class="text-xs text-gray-400 text-center hidden lg:block" id="lastUpdatedDesktop">Not synced</div>
        </div>
    </aside>

    <!-- MOBILE BOTTOM NAV -->
    <nav class="mobile-only fixed bottom-0 left-0 right-0 bg-white dark:bg-dark-card border-t border-gray-200 dark:border-dark-border z-40 bottom-nav">
        <div class="flex items-center justify-around py-2">
            <button onclick="switchView('dashboard')" id="mob-dashboard" class="mob-nav-btn active flex flex-col items-center gap-1 px-4 py-2 tap-target">
                <i class="fa-solid fa-chart-pie text-lg"></i>
                <span class="text-[10px] font-medium">Dashboard</span>
            </button>
            <button onclick="switchView('transactions')" id="mob-transactions" class="mob-nav-btn flex flex-col items-center gap-1 px-4 py-2 tap-target">
                <i class="fa-solid fa-list text-lg"></i>
                <span class="text-[10px] font-medium">History</span>
            </button>
            <button onclick="openUncatModal()" id="mob-categorize" class="mob-nav-btn flex flex-col items-center gap-1 px-4 py-2 tap-target relative">
                <i class="fa-solid fa-tags text-lg"></i>
                <span class="text-[10px] font-medium">Categorize</span>
                <span id="uncatBadgeMobile" class="hidden absolute -top-1 right-2 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center">0</span>
            </button>
            <button onclick="openSettingsModal()" class="mob-nav-btn flex flex-col items-center gap-1 px-4 py-2 tap-target">
                <i class="fa-solid fa-gear text-lg"></i>
                <span class="text-[10px] font-medium">Settings</span>
            </button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="md:ml-16 lg:ml-64 pb-24 md:pb-8 min-h-screen">
        
        <!-- MOBILE HEADER -->
        <header class="mobile-only sticky top-0 bg-white/90 dark:bg-dark-card/90 backdrop-blur-lg border-b border-gray-200 dark:border-dark-border z-30 px-4 py-3 flex items-center justify-between" style="padding-top: max(0.75rem, env(safe-area-inset-top))">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-500 to-brand-700 text-white flex items-center justify-center font-bold">Q</div>
                <span class="font-semibold">Finance Pro</span>
            </div>
            <button onclick="openDateModal()" class="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-dark-border rounded-lg text-sm tap-target">
                <i class="fa-regular fa-calendar text-brand-500"></i>
                <span id="dateRangeMobile" class="text-xs">This Month</span>
            </button>
        </header>
        
        <!-- DESKTOP HEADER -->
        <header class="desktop-only sticky top-0 bg-white/90 dark:bg-dark-card/90 backdrop-blur-lg border-b border-gray-200 dark:border-dark-border z-30 px-6 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold" id="viewTitle">Dashboard</h1>
                <p class="text-sm text-gray-500" id="viewSubtitle">Your financial overview</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openDateModal()" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg hover:border-brand-500 transition tap-target">
                    <i class="fa-regular fa-calendar text-brand-500"></i>
                    <span id="dateRangeDesktop" class="text-sm">This Month</span>
                    <i class="fa-solid fa-chevron-down text-xs text-gray-400"></i>
                </button>
            </div>
        </header>

        <!-- CONTENT AREA -->
        <div class="p-4 md:p-6 lg:p-8 max-w-7xl mx-auto">
            
            <!-- ==================== DASHBOARD VIEW ==================== -->
            <div id="view-dashboard" class="space-y-4 md:space-y-6">
                
                <!-- LOADING SKELETON -->
                <div id="loadingSkeleton" class="space-y-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                        <div class="skeleton h-28 rounded-2xl"></div>
                        <div class="skeleton h-28 rounded-2xl"></div>
                        <div class="skeleton h-28 rounded-2xl"></div>
                        <div class="skeleton h-28 rounded-2xl"></div>
                    </div>
                    <div class="skeleton h-64 rounded-2xl"></div>
                </div>
                
                <!-- ACTUAL CONTENT (hidden until loaded) -->
                <div id="dashboardContent" class="hidden space-y-4 md:space-y-6">
                    
                    <!-- QUICK FIX BANNER (if uncategorized) -->
                    <div id="quickFixBanner" class="hidden bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 border border-amber-200 dark:border-amber-800 rounded-2xl p-4 flex items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid fa-wand-magic-sparkles text-amber-600"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-amber-900 dark:text-amber-100 text-sm">Quick Fix Available</div>
                                <div class="text-xs text-amber-700 dark:text-amber-300 truncate max-w-[180px] md:max-w-none" id="quickFixMerchant">--</div>
                            </div>
                        </div>
                        <button onclick="quickFixTop()" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition tap-target flex-shrink-0">
                            Fix Now
                        </button>
                    </div>
                    
                    <!-- KEY METRICS ROW -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                        
                        <!-- Health Score -->
                        <div class="bg-gradient-to-br from-brand-600 to-purple-700 text-white p-4 rounded-2xl shadow-lg cursor-pointer tap-target" onclick="openHealthModal()">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-[10px] text-brand-200 uppercase tracking-wider font-semibold">Health</div>
                                    <div class="text-2xl md:text-3xl font-bold mt-1" id="healthScore">--</div>
                                    <div class="text-xs text-brand-200 mt-1" id="healthLabel">Tap for details</div>
                                </div>
                                <div class="relative w-12 h-12 md:w-14 md:h-14">
                                    <svg class="health-ring w-full h-full" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="10"/>
                                        <circle id="healthRing" cx="50" cy="50" r="42" fill="none" stroke="white" stroke-width="10" stroke-linecap="round" stroke-dasharray="264" stroke-dashoffset="264"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total Spend -->
                        <div class="bg-white dark:bg-dark-card p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold">Spent</span>
                                <i class="fa-solid fa-arrow-trend-up text-red-400 text-xs"></i>
                            </div>
                            <div class="text-xl md:text-2xl font-bold" id="totalSpend">--</div>
                            <div class="text-[10px] text-gray-400 mt-1" id="spendDelta">--</div>
                        </div>
                        
                        <!-- Money Left / Daily Budget -->
                        <div class="bg-white dark:bg-dark-card p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold">Daily Budget</span>
                                <i class="fa-solid fa-calendar-day text-brand-400 text-xs"></i>
                            </div>
                            <div class="text-xl md:text-2xl font-bold" id="dailyBudget">--</div>
                            <div class="text-[10px] text-gray-400 mt-1" id="daysLeft">-- days left</div>
                        </div>
                        
                        <!-- Savings Rate -->
                        <div class="bg-white dark:bg-dark-card p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold">Saved</span>
                                <i class="fa-solid fa-piggy-bank text-emerald-400 text-xs"></i>
                            </div>
                            <div class="text-xl md:text-2xl font-bold" id="savingsRate">--%</div>
                            <div class="text-[10px] mt-1" id="savingsAmount">--</div>
                        </div>
                    </div>
                    
                    <!-- MAIN GRID -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                        
                        <!-- SPENDING BY CATEGORY (Chart) -->
                        <div class="lg:col-span-2 bg-white dark:bg-dark-card p-4 md:p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold">Spending by Category</h3>
                                <span class="text-xs text-gray-400" id="catCount">-- categories</span>
                            </div>
                            <div class="chart-wrap h-48 md:h-64">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- CATEGORY DRILL-DOWN -->
                        <div class="bg-white dark:bg-dark-card rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border overflow-hidden">
                            <div class="p-4 border-b border-gray-100 dark:border-dark-border">
                                <h3 class="font-semibold">Category Details</h3>
                                <p class="text-xs text-gray-400">Tap to see merchants</p>
                            </div>
                            <div id="catDrilldown" class="max-h-64 md:max-h-80 overflow-y-auto divide-y divide-gray-50 dark:divide-dark-border">
                                <!-- JS populated -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- BOTTOM ROW -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                        
                        <!-- TOP MERCHANTS -->
                        <div class="bg-white dark:bg-dark-card rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border overflow-hidden">
                            <div class="p-4 border-b border-gray-100 dark:border-dark-border flex items-center justify-between">
                                <h3 class="font-semibold">Top Merchants</h3>
                                <span class="text-xs text-gray-400">By spend</span>
                            </div>
                            <div id="topMerchants" class="divide-y divide-gray-50 dark:divide-dark-border max-h-72 overflow-y-auto">
                                <!-- JS populated -->
                            </div>
                        </div>
                        
                        <!-- RECURRING PAYMENTS -->
                        <div class="bg-white dark:bg-dark-card rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border overflow-hidden">
                            <div class="p-4 border-b border-gray-100 dark:border-dark-border flex items-center justify-between">
                                <h3 class="font-semibold">Recurring Payments</h3>
                                <span class="text-xs text-gray-400">Auto-detected</span>
                            </div>
                            <div id="recurring" class="divide-y divide-gray-50 dark:divide-dark-border max-h-72 overflow-y-auto">
                                <!-- JS populated -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- SPENDING PATTERNS (Collapsible) -->
                    <details class="bg-white dark:bg-dark-card rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border">
                        <summary class="p-4 cursor-pointer flex items-center justify-between tap-target">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-chart-line text-brand-500"></i>
                                <span class="font-semibold">Spending Patterns</span>
                            </div>
                            <i class="fa-solid fa-chevron-down text-gray-400 text-sm"></i>
                        </summary>
                        <div class="p-4 pt-0 border-t border-gray-100 dark:border-dark-border">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                <div>
                                    <h4 class="text-sm font-medium text-gray-500 mb-3">By Day of Week</h4>
                                    <div class="chart-wrap h-40">
                                        <canvas id="dowChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-sm font-medium text-gray-500 mb-3">By Hour</h4>
                                    <div class="chart-wrap h-40">
                                        <canvas id="hourChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
            
            <!-- ==================== TRANSACTIONS VIEW ==================== -->
            <div id="view-transactions" class="hidden space-y-4">
                
                <!-- SEARCH & FILTER -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="txnSearch" placeholder="Search transactions..." 
                               class="w-full bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-xl pl-10 pr-4 py-3 text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition tap-target">
                    </div>
                    <select id="catFilter" class="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-brand-500 outline-none tap-target">
                        <option value="">All Categories</option>
                    </select>
                </div>
                
                <!-- TRANSACTION LIST -->
                <div class="bg-white dark:bg-dark-card rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border overflow-hidden">
                    
                    <!-- Desktop Table Header -->
                    <div class="hidden md:grid grid-cols-12 gap-4 px-4 py-3 bg-gray-50 dark:bg-dark-border text-xs text-gray-500 uppercase font-semibold">
                        <div class="col-span-2">Date</div>
                        <div class="col-span-4">Merchant</div>
                        <div class="col-span-3">Category</div>
                        <div class="col-span-3 text-right">Amount</div>
                    </div>
                    
                    <div id="txnList" class="divide-y divide-gray-100 dark:divide-dark-border max-h-[60vh] overflow-y-auto">
                        <!-- JS populated -->
                    </div>
                    
                    <div class="p-3 border-t border-gray-100 dark:border-dark-border flex items-center justify-between">
                        <span class="text-sm text-gray-500" id="txnCount">Showing 0</span>
                        <button onclick="loadMore()" id="loadMoreBtn" class="text-sm text-brand-600 font-medium tap-target">Load More</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ==================== MODALS ==================== -->
    
    <!-- DATE PICKER MODAL -->
    <div id="dateModal" class="modal">
        <div class="modal-box">
            <div class="p-4 border-b border-gray-100 dark:border-dark-border flex items-center justify-between">
                <h3 class="font-semibold">Select Date Range</h3>
                <button onclick="closeDateModal()" class="text-gray-400 hover:text-gray-600 tap-target"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-4 space-y-2">
                <button onclick="setDateRange('thisMonth')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-dark-border transition tap-target">This Month</button>
                <button onclick="setDateRange('lastMonth')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-dark-border transition tap-target">Last Month</button>
                <button onclick="setDateRange('last30')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-dark-border transition tap-target">Last 30 Days</button>
                <button onclick="setDateRange('last90')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-dark-border transition tap-target">Last 90 Days</button>
                <button onclick="setDateRange('thisYear')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-dark-border transition tap-target">This Year</button>
                <button onclick="setDateRange('allTime')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-dark-border transition tap-target">All Time</button>
            </div>
        </div>
    </div>
    
    <!-- HEALTH SCORE MODAL -->
    <div id="healthModal" class="modal">
        <div class="modal-box">
            <div class="p-4 border-b border-gray-100 dark:border-dark-border flex items-center justify-between">
                <h3 class="font-semibold">Health Score Breakdown</h3>
                <button onclick="closeHealthModal()" class="text-gray-400 hover:text-gray-600 tap-target"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-4 space-y-4" id="healthBreakdown">
                <!-- JS populated -->
            </div>
        </div>
    </div>
    
    <!-- CATEGORIZE MODAL -->
    <div id="catModal" class="modal">
        <div class="modal-box">
            <div class="p-4 border-b border-gray-100 dark:border-dark-border flex items-center justify-between">
                <h3 class="font-semibold">Categorize Transaction</h3>
                <button onclick="closeCatModal()" class="text-gray-400 hover:text-gray-600 tap-target"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-4 space-y-4">
                <div class="p-3 bg-gray-50 dark:bg-dark-border rounded-lg">
                    <div class="text-xs text-gray-400 mb-1">Original Transaction</div>
                    <div class="font-medium text-sm break-all" id="catModalRaw">--</div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1.5">Merchant Name</label>
                    <input type="text" id="catModalName" class="w-full bg-white dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-lg px-3 py-3 text-sm focus:ring-2 focus:ring-brand-500 outline-none tap-target" placeholder="e.g., Keeta, Netflix">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1.5">Category</label>
                    <select id="catModalCat" class="w-full bg-white dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-lg px-3 py-3 text-sm focus:ring-2 focus:ring-brand-500 outline-none tap-target">
                        <!-- JS populated -->
                    </select>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 dark:border-dark-border flex gap-2">
                <button onclick="closeCatModal()" class="flex-1 px-4 py-3 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-dark-border rounded-lg transition tap-target">Cancel</button>
                <button onclick="saveCategorization()" class="flex-1 px-4 py-3 text-sm bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition tap-target">Save</button>
            </div>
        </div>
    </div>
    
    <!-- UNCATEGORIZED LIST MODAL -->
    <div id="uncatModal" class="modal">
        <div class="modal-box" style="max-width: 500px;">
            <div class="p-4 border-b border-gray-100 dark:border-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-semibold">Uncategorized Transactions</h3>
                    <p class="text-xs text-gray-400">Tap to categorize</p>
                </div>
                <button onclick="closeUncatModal()" class="text-gray-400 hover:text-gray-600 tap-target"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div id="uncatList" class="max-h-[50vh] overflow-y-auto divide-y divide-gray-100 dark:divide-dark-border">
                <!-- JS populated -->
            </div>
            <div class="p-3 border-t border-gray-100 dark:border-dark-border flex justify-between items-center">
                <button onclick="exportMappings()" class="text-sm text-brand-600 tap-target"><i class="fa-solid fa-download mr-1"></i> Export</button>
                <button onclick="closeUncatModal()" class="px-4 py-2 text-sm text-gray-500 tap-target">Close</button>
            </div>
        </div>
    </div>
    
    <!-- SETTINGS MODAL (Mobile) -->
    <div id="settingsModal" class="modal">
        <div class="modal-box">
            <div class="p-4 border-b border-gray-100 dark:border-dark-border flex items-center justify-between">
                <h3 class="font-semibold">Settings</h3>
                <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600 tap-target"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-4 space-y-4">
                <div class="flex items-center justify-between">
                    <span class="font-medium">Dark Mode</span>
                    <button onclick="toggleTheme()" class="w-12 h-7 rounded-full bg-gray-200 dark:bg-brand-600 relative transition tap-target">
                        <div class="w-5 h-5 rounded-full bg-white absolute top-1 left-1 dark:left-6 transition-all shadow"></div>
                    </button>
                </div>
                <button onclick="syncData(); closeSettingsModal();" class="w-full py-3 bg-brand-50 dark:bg-brand-900/20 text-brand-600 rounded-lg font-medium tap-target">
                    <i class="fa-solid fa-rotate mr-2"></i> Sync Now
                </button>
                <div class="text-center text-xs text-gray-400" id="lastUpdatedMobile">Not synced</div>
            </div>
        </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            SHEET_ID: '1LLpl1sH7LHqD3u3ZU4JWZJtvcHD_SGFql76llyfAIBw',
            STORAGE_VERSION: 2,
            DEFAULT_FX: { USD: 3.65, EUR: 3.95, GBP: 4.60, SAR: 0.97 }
        };

        // ============================================
        // STATE
        // ============================================
        const STATE = {
            allTxns: [],
            filtered: [],
            merchantMap: [],
            categories: new Set(),
            catColors: {},
            fxRates: { ...CONFIG.DEFAULT_FX },
            localMappings: {},
            dateRange: { start: dayjs().startOf('month'), end: dayjs() },
            dateLabel: 'This Month',
            view: 'dashboard',
            txnLimit: 30,
            expandedCats: new Set(),
            catTarget: null,
            isLoading: true
        };

        // ============================================
        // COLOR PALETTE (Divergent, WCAG AA)
        // ============================================
        const COLORS = [
            '#7C3AED', '#F59E0B', '#10B981', '#3B82F6', '#EC4899',
            '#06B6D4', '#EF4444', '#84CC16', '#8B5CF6', '#F97316',
            '#14B8A6', '#A855F7', '#0EA5E9', '#F43F5E', '#22C55E'
        ];

        function assignColors(cats) {
            const arr = Array.from(cats).filter(c => c !== 'Uncategorized').sort();
            const colors = {};
            arr.forEach((c, i) => colors[c] = COLORS[i % COLORS.length]);
            colors['Uncategorized'] = '#DC2626';
            return colors;
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            loadLocalData();
            initTheme();
            syncData();
            
            // Event listeners
            document.getElementById('txnSearch').addEventListener('input', debounce(filterTxns, 200));
            document.getElementById('catFilter').addEventListener('change', filterTxns);
        });

        function loadLocalData() {
            try {
                const stored = localStorage.getItem('qnb_data');
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data.version === CONFIG.STORAGE_VERSION) {
                        STATE.localMappings = data.mappings || {};
                    }
                }
            } catch (e) { console.warn('localStorage parse error', e); }
        }

        function saveLocalData() {
            localStorage.setItem('qnb_data', JSON.stringify({
                version: CONFIG.STORAGE_VERSION,
                mappings: STATE.localMappings
            }));
        }

        function initTheme() {
            if (localStorage.getItem('qnb_theme') === 'dark') {
                document.documentElement.classList.add('dark');
            }
            updateThemeIcon();
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('qnb_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            updateThemeIcon();
            renderCharts();
        }

        function updateThemeIcon() {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.className = document.documentElement.classList.contains('dark') ? 'fa-solid fa-sun text-yellow-400' : 'fa-solid fa-moon text-gray-500';
            }
        }

        // ============================================
        // DATA FETCHING
        // ============================================
        async function syncData() {
            STATE.isLoading = true;
            showLoading(true);
            
            const icon = document.getElementById('syncIcon');
            if (icon) icon.classList.add('fa-spin');

            const url = (sheet) => `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}&_=${Date.now()}`;

            try {
                const [ledger, map, fx] = await Promise.all([
                    fetchCSV(url('RawLedger')),
                    fetchCSV(url('MerchantMap')),
                    fetchCSV(url('FXRates'))
                ]);

                processFX(fx);
                processMerchantMap(map);
                processTxns(ledger);

                const now = dayjs().format('HH:mm');
                ['lastUpdatedDesktop', 'lastUpdatedMobile'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = `Synced ${now}`;
                });

                STATE.isLoading = false;
                showLoading(false);
                filterData();

            } catch (err) {
                console.error('Sync error:', err);
                STATE.isLoading = false;
                showLoading(false);
                showError('Sync failed. Check your connection and try again.');
            } finally {
                if (icon) icon.classList.remove('fa-spin');
            }
        }

        function fetchCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: false,
                    skipEmptyLines: true,
                    complete: res => resolve(res.data),
                    error: err => reject(err)
                });
            });
        }

        function showLoading(show) {
            const skeleton = document.getElementById('loadingSkeleton');
            const content = document.getElementById('dashboardContent');
            if (skeleton) skeleton.classList.toggle('hidden', !show);
            if (content) content.classList.toggle('hidden', show);
        }

        function showError(msg) {
            alert(msg); // Simple for now - could enhance with toast
        }

        // ============================================
        // DATA PROCESSING
        // ============================================
        function processFX(rows) {
            rows.forEach(r => {
                const cur = clean(r[0]);
                const rate = parseFloat(r[1]);
                if (cur && !isNaN(rate)) STATE.fxRates[cur] = rate;
            });
        }

        function processMerchantMap(rows) {
            // Skip header
            if (rows.length && rows[0][0]?.toLowerCase().includes('pattern')) rows.shift();

            STATE.merchantMap = [];
            STATE.categories.clear();

            rows.forEach(r => {
                const pattern = clean(r[0]).toLowerCase();
                const display = clean(r[1]);
                const consolidated = clean(r[2]) || display;
                const category = clean(r[3]);

                if (pattern && category) {
                    STATE.merchantMap.push({ pattern, display, consolidated, category });
                    STATE.categories.add(category);
                }
            });

            STATE.categories.add('Uncategorized');
            STATE.catColors = assignColors(STATE.categories);
            updateCatDropdowns();
        }

        function processTxns(rows) {
            const data = rows.filter(r => clean(r[1]) !== 'Amount' && !isNaN(parseFloat(r[1])));

            STATE.allTxns = data.map(r => {
                const raw = clean(r[3]);
                const currency = clean(r[2]) || 'QAR';
                const amount = parseFloat(r[1]);
                const rate = STATE.fxRates[currency] || 1;
                const amtQAR = currency === 'QAR' ? amount : amount * rate;
                const meta = categorize(raw);

                return {
                    date: dayjs(clean(r[0])),
                    amount: amtQAR,
                    currency,
                    raw,
                    display: meta.display,
                    consolidated: meta.consolidated,
                    category: meta.category,
                    direction: clean(r[5]),
                    type: clean(r[6])
                };
            }).sort((a, b) => b.date - a.date);
        }

        function categorize(raw) {
            const lower = raw.toLowerCase();

            // Local mappings first
            if (STATE.localMappings[lower]) {
                return STATE.localMappings[lower];
            }

            // MerchantMap
            const match = STATE.merchantMap.find(m => lower.includes(m.pattern));
            if (match) {
                return { display: match.display, consolidated: match.consolidated, category: match.category };
            }

            return { display: raw, consolidated: raw, category: 'Uncategorized' };
        }

        function clean(str) {
            return str ? str.toString().replace(/^"|"$/g, '').trim() : '';
        }

        // ============================================
        // FILTERING
        // ============================================
        function filterData() {
            const { start, end } = STATE.dateRange;
            STATE.filtered = STATE.allTxns.filter(t => t.date.isBetween(start, end, 'day', '[]'));
            STATE.txnLimit = 30;
            updateAll();
        }

        function filterTxns() {
            const search = document.getElementById('txnSearch').value.toLowerCase();
            const cat = document.getElementById('catFilter').value;

            let txns = STATE.filtered;
            if (search) txns = txns.filter(t => t.display.toLowerCase().includes(search) || t.raw.toLowerCase().includes(search));
            if (cat) txns = txns.filter(t => t.category === cat);

            renderTxnList(txns);
        }

        // ============================================
        // UI UPDATES
        // ============================================
        function updateAll() {
            updateDashboard();
            updateTxnView();
            updateUncatAlerts();
        }

        function updateDashboard() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const inc = STATE.filtered.filter(t => t.direction === 'IN');

            const totalSpend = out.reduce((s, t) => s + t.amount, 0);
            const totalIncome = inc.reduce((s, t) => s + t.amount, 0);
            const saved = totalIncome - totalSpend;
            const savingsRate = totalIncome > 0 ? (saved / totalIncome) * 100 : 0;

            // Days left in period
            const daysTotal = STATE.dateRange.end.diff(STATE.dateRange.start, 'day') + 1;
            const daysPassed = dayjs().diff(STATE.dateRange.start, 'day') + 1;
            const daysLeft = Math.max(0, daysTotal - daysPassed);

            // Daily budget (remaining / days left)
            const remaining = totalIncome - totalSpend;
            const dailyBudget = daysLeft > 0 ? remaining / daysLeft : remaining;

            // Health Score
            const uncatCount = out.filter(t => t.category === 'Uncategorized').length;
            const uncatRatio = out.length > 0 ? uncatCount / out.length : 0;
            const healthData = calculateHealth(savingsRate, uncatRatio);

            // Week over week comparison
            const thisWeekSpend = out.filter(t => t.date.isAfter(dayjs().subtract(7, 'day'))).reduce((s, t) => s + t.amount, 0);
            const lastWeekSpend = out.filter(t => t.date.isBetween(dayjs().subtract(14, 'day'), dayjs().subtract(7, 'day'), 'day', '[]')).reduce((s, t) => s + t.amount, 0);
            const weekDelta = lastWeekSpend > 0 ? ((thisWeekSpend - lastWeekSpend) / lastWeekSpend * 100) : 0;

            // Update DOM
            document.getElementById('healthScore').textContent = healthData.score;
            document.getElementById('healthLabel').textContent = healthData.label;
            const ring = document.getElementById('healthRing');
            ring.style.strokeDashoffset = 264 - (healthData.score / 100) * 264;

            document.getElementById('totalSpend').textContent = formatNum(totalSpend);
            document.getElementById('spendDelta').textContent = weekDelta >= 0 ? `+${Math.round(weekDelta)}% vs last week` : `${Math.round(weekDelta)}% vs last week`;
            document.getElementById('spendDelta').className = `text-[10px] mt-1 ${weekDelta >= 0 ? 'text-red-500' : 'text-emerald-500'}`;

            document.getElementById('dailyBudget').textContent = formatNum(Math.max(0, dailyBudget));
            document.getElementById('daysLeft').textContent = `${daysLeft} days left`;

            document.getElementById('savingsRate').textContent = `${Math.round(savingsRate)}%`;
            document.getElementById('savingsAmount').textContent = saved >= 0 ? `+${formatNum(saved)} saved` : `${formatNum(saved)} deficit`;
            document.getElementById('savingsAmount').className = `text-[10px] mt-1 ${saved >= 0 ? 'text-emerald-500' : 'text-red-500'}`;

            // Category breakdown
            const catSpend = {};
            out.forEach(t => catSpend[t.category] = (catSpend[t.category] || 0) + t.amount);
            const sortedCats = Object.entries(catSpend).sort((a, b) => b[1] - a[1]);

            document.getElementById('catCount').textContent = `${sortedCats.length} categories`;
            renderCategoryChart(sortedCats);
            renderCatDrilldown(sortedCats, out);

            // Top merchants
            const merchSpend = {};
            out.forEach(t => {
                const key = t.consolidated;
                if (!merchSpend[key]) merchSpend[key] = { sum: 0, count: 0, cat: t.category };
                merchSpend[key].sum += t.amount;
                merchSpend[key].count++;
            });
            renderTopMerchants(Object.entries(merchSpend).sort((a, b) => b[1].sum - a[1].sum).slice(0, 8));

            // Recurring
            detectRecurring(out);

            // Patterns
            renderPatterns(out);

            // Quick fix banner
            const topUncat = out.find(t => t.category === 'Uncategorized');
            const banner = document.getElementById('quickFixBanner');
            if (topUncat) {
                banner.classList.remove('hidden');
                document.getElementById('quickFixMerchant').textContent = topUncat.raw;
            } else {
                banner.classList.add('hidden');
            }

            // Store health breakdown for modal
            STATE.healthBreakdown = healthData.breakdown;
        }

        function calculateHealth(savingsRate, uncatRatio) {
            const breakdown = [];
            let score = 0;

            // Savings (40 pts)
            let savingsPts = 0;
            if (savingsRate >= 30) savingsPts = 40;
            else if (savingsRate >= 20) savingsPts = 30;
            else if (savingsRate >= 10) savingsPts = 20;
            else if (savingsRate >= 0) savingsPts = 10;
            score += savingsPts;
            breakdown.push({ label: 'Savings Rate', pts: savingsPts, max: 40, detail: `${Math.round(savingsRate)}% saved` });

            // Categorization (30 pts)
            let catPts = 0;
            if (uncatRatio < 0.05) catPts = 30;
            else if (uncatRatio < 0.15) catPts = 20;
            else if (uncatRatio < 0.30) catPts = 10;
            else catPts = 5;
            score += catPts;
            breakdown.push({ label: 'Categorization', pts: catPts, max: 30, detail: `${Math.round(uncatRatio * 100)}% uncategorized` });

            // Data completeness (20 pts) - placeholder
            score += 20;
            breakdown.push({ label: 'Data Completeness', pts: 20, max: 20, detail: 'All transactions tracked' });

            // Consistency (10 pts) - placeholder
            score += 10;
            breakdown.push({ label: 'Tracking Consistency', pts: 10, max: 10, detail: 'Regular tracking' });

            let label = 'Excellent';
            if (score < 40) label = 'Needs Work';
            else if (score < 60) label = 'Fair';
            else if (score < 80) label = 'Good';

            return { score, label, breakdown };
        }

        // ============================================
        // CHART RENDERING
        // ============================================
        const charts = {};

        function renderCategoryChart(sortedCats) {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;
            if (charts.category) charts.category.destroy();

            const labels = sortedCats.slice(0, 8).map(c => c[0]);
            const data = sortedCats.slice(0, 8).map(c => c[1]);
            const colors = labels.map(l => STATE.catColors[l] || '#94A3B8');

            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? '#334155' : '#f1f5f9';
            const textColor = isDark ? '#94a3b8' : '#64748b';

            charts.category = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{ data, backgroundColor: colors, borderRadius: 6, barThickness: window.innerWidth < 768 ? 20 : 32 }]
                },
                options: {
                    indexAxis: window.innerWidth < 768 ? 'y' : 'x',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: window.innerWidth >= 768, color: gridColor }, ticks: { color: textColor, maxRotation: 0 } },
                        y: { grid: { color: gridColor }, beginAtZero: true, ticks: { color: textColor } }
                    }
                }
            });
        }

        function renderPatterns(txns) {
            // Day of week
            const dow = { Sun: 0, Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0 };
            txns.forEach(t => dow[t.date.format('ddd')] += t.amount);
            renderSmallChart('dowChart', Object.keys(dow), Object.values(dow), '#8B5CF6');

            // Hour
            const hours = Array(24).fill(0);
            txns.forEach(t => hours[t.date.hour()] += t.amount);
            renderSmallChart('hourChart', hours.map((_, i) => `${i}h`), hours, '#F59E0B');
        }

        function renderSmallChart(id, labels, data, color) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            if (charts[id]) charts[id].destroy();

            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? '#334155' : '#f1f5f9';
            const textColor = isDark ? '#94a3b8' : '#64748b';

            charts[id] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{ data, backgroundColor: color, borderRadius: 3, barThickness: 12 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: textColor, font: { size: 9 }, maxRotation: 0 } },
                        y: { grid: { color: gridColor }, beginAtZero: true, ticks: { color: textColor, font: { size: 9 } } }
                    }
                }
            });
        }

        function renderCharts() {
            // Re-render after theme change
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const catSpend = {};
            out.forEach(t => catSpend[t.category] = (catSpend[t.category] || 0) + t.amount);
            renderCategoryChart(Object.entries(catSpend).sort((a, b) => b[1] - a[1]));
            renderPatterns(out);
        }

        // ============================================
        // COMPONENT RENDERING
        // ============================================
        function renderCatDrilldown(sortedCats, txns) {
            const container = document.getElementById('catDrilldown');
            if (!container) return;

            container.innerHTML = sortedCats.map(([cat, sum]) => {
                const catTxns = txns.filter(t => t.category === cat);
                const merchants = {};
                catTxns.forEach(t => {
                    if (!merchants[t.consolidated]) merchants[t.consolidated] = { sum: 0, count: 0 };
                    merchants[t.consolidated].sum += t.amount;
                    merchants[t.consolidated].count++;
                });
                const sorted = Object.entries(merchants).sort((a, b) => b[1].sum - a[1].sum).slice(0, 6);
                const open = STATE.expandedCats.has(cat);
                const color = STATE.catColors[cat] || '#94A3B8';

                return `
                    <div>
                        <div class="p-3 flex items-center justify-between cursor-pointer hover:bg-gray-50 dark:hover:bg-dark-hover tap-target" onclick="toggleCat('${cat}')">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded" style="background:${color}"></div>
                                <span class="font-medium text-sm">${cat}</span>
                                <span class="text-xs text-gray-400">(${catTxns.length})</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-semibold text-sm">${formatNum(sum)}</span>
                                <i class="fa-solid fa-chevron-${open ? 'up' : 'down'} text-gray-400 text-xs"></i>
                            </div>
                        </div>
                        <div class="cat-details ${open ? 'open' : ''} bg-gray-50 dark:bg-dark-bg">
                            <div class="px-4 pb-3 space-y-1">
                                ${sorted.map(([name, d]) => `
                                    <div class="flex justify-between text-xs py-1">
                                        <span class="text-gray-600 dark:text-gray-400">${name} <span class="text-gray-400">(${d.count}x)</span></span>
                                        <span class="font-medium">${formatNum(d.sum)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleCat(cat) {
            if (STATE.expandedCats.has(cat)) STATE.expandedCats.delete(cat);
            else STATE.expandedCats.add(cat);
            
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const catSpend = {};
            out.forEach(t => catSpend[t.category] = (catSpend[t.category] || 0) + t.amount);
            renderCatDrilldown(Object.entries(catSpend).sort((a, b) => b[1] - a[1]), out);
        }

        function renderTopMerchants(merchants) {
            const container = document.getElementById('topMerchants');
            if (!container) return;

            if (!merchants.length) {
                container.innerHTML = '<div class="p-4 text-sm text-gray-400 text-center">No spending data</div>';
                return;
            }

            container.innerHTML = merchants.map(([name, d], i) => `
                <div class="p-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-7 h-7 rounded-full bg-brand-50 dark:bg-brand-900/20 flex items-center justify-center text-xs font-bold text-brand-600">${i + 1}</div>
                        <div>
                            <div class="font-medium text-sm">${name}</div>
                            <div class="text-xs text-gray-400">${d.cat}  ${d.count}x</div>
                        </div>
                    </div>
                    <div class="font-semibold">${formatNum(d.sum)}</div>
                </div>
            `).join('');
        }

        function detectRecurring(txns) {
            const container = document.getElementById('recurring');
            if (!container) return;

            const byMerch = {};
            txns.forEach(t => {
                if (!byMerch[t.consolidated]) byMerch[t.consolidated] = [];
                byMerch[t.consolidated].push(t);
            });

            const subs = [];
            Object.entries(byMerch).forEach(([name, arr]) => {
                if (arr.length < 2) return;
                arr.sort((a, b) => a.date - b.date);
                const intervals = [];
                for (let i = 1; i < arr.length; i++) {
                    intervals.push(arr[i].date.diff(arr[i-1].date, 'day'));
                }
                const avg = intervals.reduce((s, i) => s + i, 0) / intervals.length;
                if (avg >= 25 && avg <= 35) {
                    subs.push({ name, amount: arr.reduce((s, t) => s + t.amount, 0) / arr.length, freq: Math.round(avg), count: arr.length });
                }
            });

            if (!subs.length) {
                container.innerHTML = '<div class="p-4 text-sm text-gray-400 text-center">No recurring detected</div>';
                return;
            }

            container.innerHTML = subs.sort((a, b) => b.amount - a.amount).map(s => `
                <div class="p-3 flex items-center justify-between">
                    <div>
                        <div class="font-medium text-sm">${s.name}</div>
                        <div class="text-xs text-gray-400">~${s.freq} days  ${s.count} payments</div>
                    </div>
                    <div class="font-semibold">${formatNum(s.amount)}</div>
                </div>
            `).join('');
        }

        // ============================================
        // TRANSACTION VIEW
        // ============================================
        function updateTxnView() {
            renderTxnList(STATE.filtered);
        }

        function renderTxnList(txns) {
            const container = document.getElementById('txnList');
            if (!container) return;

            const show = txns.slice(0, STATE.txnLimit);
            document.getElementById('txnCount').textContent = `Showing ${show.length} of ${txns.length}`;
            document.getElementById('loadMoreBtn').style.display = show.length < txns.length ? 'block' : 'none';

            container.innerHTML = show.map(t => {
                const isOut = t.direction === 'OUT';
                const isUncat = t.category === 'Uncategorized';
                const color = STATE.catColors[t.category] || '#94A3B8';

                return `
                    <div class="${isUncat ? 'bg-red-50 dark:bg-red-900/10' : ''} p-3 md:grid md:grid-cols-12 md:gap-4 md:items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-dark-hover transition tap-target" onclick="openCatModal('${t.raw.replace(/'/g, "\\'")}')">
                        <div class="md:col-span-2 text-xs text-gray-500 mb-1 md:mb-0">${t.date.format('MMM D, HH:mm')}</div>
                        <div class="md:col-span-4 font-medium text-sm mb-1 md:mb-0">${t.display}</div>
                        <div class="md:col-span-3 mb-1 md:mb-0">
                            <span class="text-xs px-2 py-1 rounded" style="background:${color}20;color:${color}">${t.category}</span>
                        </div>
                        <div class="md:col-span-3 text-right font-semibold ${isOut ? '' : 'text-emerald-600'}">
                            ${isOut ? '' : '+'}${t.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadMore() {
            STATE.txnLimit += 30;
            filterTxns();
        }

        // ============================================
        // UNCATEGORIZED
        // ============================================
        function updateUncatAlerts() {
            const uncat = STATE.filtered.filter(t => t.category === 'Uncategorized' && t.direction === 'OUT');
            const count = uncat.length;

            // Desktop
            const alertD = document.getElementById('uncatAlertDesktop');
            const countD = document.getElementById('uncatCountDesktop');
            if (alertD) alertD.classList.toggle('hidden', count === 0);
            if (countD) countD.textContent = count;

            // Mobile
            const badge = document.getElementById('uncatBadgeMobile');
            if (badge) {
                badge.classList.toggle('hidden', count === 0);
                badge.textContent = count > 9 ? '9+' : count;
            }
        }

        function openUncatModal() {
            const uncat = STATE.filtered.filter(t => t.category === 'Uncategorized' && t.direction === 'OUT');
            const container = document.getElementById('uncatList');

            if (!uncat.length) {
                container.innerHTML = '<div class="p-6 text-center text-gray-400"><i class="fa-solid fa-check-circle text-emerald-500 text-2xl mb-2"></i><br>All categorized!</div>';
            } else {
                container.innerHTML = uncat.slice(0, 20).map(t => `
                    <div class="p-3 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-dark-hover cursor-pointer tap-target" onclick="closeUncatModal(); openCatModal('${t.raw.replace(/'/g, "\\'")}')">
                        <div>
                            <div class="font-medium text-sm">${t.raw}</div>
                            <div class="text-xs text-gray-400">${t.date.format('MMM D')}</div>
                        </div>
                        <div class="font-semibold">${formatNum(t.amount)}</div>
                    </div>
                `).join('');
            }

            document.getElementById('uncatModal').classList.add('show');
        }

        function closeUncatModal() {
            document.getElementById('uncatModal').classList.remove('show');
        }

        // ============================================
        // CATEGORIZATION
        // ============================================
        function openCatModal(raw) {
            STATE.catTarget = raw;
            document.getElementById('catModalRaw').textContent = raw;
            document.getElementById('catModalName').value = '';
            document.getElementById('catModal').classList.add('show');
        }

        function closeCatModal() {
            document.getElementById('catModal').classList.remove('show');
        }

        function saveCategorization() {
            const raw = STATE.catTarget;
            const name = document.getElementById('catModalName').value || raw;
            const cat = document.getElementById('catModalCat').value;

            if (!cat) {
                alert('Please select a category');
                return;
            }

            STATE.localMappings[raw.toLowerCase()] = { display: name, consolidated: name, category: cat };
            saveLocalData();

            // Re-categorize
            STATE.allTxns.forEach(t => {
                if (t.raw.toLowerCase() === raw.toLowerCase()) {
                    t.display = name;
                    t.consolidated = name;
                    t.category = cat;
                }
            });

            closeCatModal();
            filterData();
        }

        function quickFixTop() {
            const top = STATE.filtered.find(t => t.category === 'Uncategorized' && t.direction === 'OUT');
            if (top) openCatModal(top.raw);
        }

        function updateCatDropdowns() {
            const cats = Array.from(STATE.categories).filter(c => c !== 'Uncategorized').sort();
            
            // Modal
            const modal = document.getElementById('catModalCat');
            if (modal) modal.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');

            // Filter
            const filter = document.getElementById('catFilter');
            if (filter) filter.innerHTML = '<option value="">All Categories</option>' + Array.from(STATE.categories).sort().map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function exportMappings() {
            const rows = ['Pattern,Display Name,Consolidated Name,Category'];
            Object.entries(STATE.localMappings).forEach(([p, d]) => {
                rows.push(`"${p}","${d.display}","${d.consolidated}","${d.category}"`);
            });
            download('qnb_mappings.csv', rows.join('\n'));
        }

        // ============================================
        // DATE RANGE
        // ============================================
        function openDateModal() {
            document.getElementById('dateModal').classList.add('show');
        }

        function closeDateModal() {
            document.getElementById('dateModal').classList.remove('show');
        }

        function setDateRange(preset) {
            const now = dayjs();
            let start, end, label;

            switch (preset) {
                case 'thisMonth':
                    start = now.startOf('month'); end = now; label = 'This Month'; break;
                case 'lastMonth':
                    start = now.subtract(1, 'month').startOf('month'); end = now.subtract(1, 'month').endOf('month'); label = 'Last Month'; break;
                case 'last30':
                    start = now.subtract(30, 'day'); end = now; label = 'Last 30 Days'; break;
                case 'last90':
                    start = now.subtract(90, 'day'); end = now; label = 'Last 90 Days'; break;
                case 'thisYear':
                    start = now.startOf('year'); end = now; label = 'This Year'; break;
                case 'allTime':
                    start = dayjs('2020-01-01'); end = now; label = 'All Time'; break;
            }

            STATE.dateRange = { start, end };
            STATE.dateLabel = label;

            document.getElementById('dateRangeMobile').textContent = label;
            document.getElementById('dateRangeDesktop').textContent = label;

            closeDateModal();
            filterData();
        }

        // ============================================
        // HEALTH MODAL
        // ============================================
        function openHealthModal() {
            const container = document.getElementById('healthBreakdown');
            if (!container || !STATE.healthBreakdown) return;

            container.innerHTML = STATE.healthBreakdown.map(b => `
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-dark-border rounded-lg">
                    <div>
                        <div class="font-medium">${b.label}</div>
                        <div class="text-xs text-gray-400">${b.detail}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-brand-600">${b.pts}/${b.max}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('healthModal').classList.add('show');
        }

        function closeHealthModal() {
            document.getElementById('healthModal').classList.remove('show');
        }

        // ============================================
        // SETTINGS MODAL
        // ============================================
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function switchView(view) {
            STATE.view = view;

            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');

            // Desktop nav
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active', 'bg-brand-50', 'dark:bg-brand-900/20', 'text-brand-600'));
            const deskBtn = document.getElementById(`nav-${view}`);
            if (deskBtn) {
                deskBtn.classList.add('active', 'bg-brand-50', 'dark:bg-brand-900/20', 'text-brand-600');
            }

            // Mobile nav
            document.querySelectorAll('.mob-nav-btn').forEach(b => b.classList.remove('active', 'text-brand-600'));
            const mobBtn = document.getElementById(`mob-${view}`);
            if (mobBtn) {
                mobBtn.classList.add('active', 'text-brand-600');
            }

            // Header text
            const titles = { dashboard: ['Dashboard', 'Your financial overview'], transactions: ['Transactions', 'Full transaction history'] };
            document.getElementById('viewTitle').textContent = titles[view]?.[0] || 'Finance Pro';
            document.getElementById('viewSubtitle').textContent = titles[view]?.[1] || '';

            // Re-render if needed
            if (view === 'transactions') filterTxns();
        }

        // ============================================
        // UTILITIES
        // ============================================
        function formatNum(n) {
            return Math.round(n).toLocaleString();
        }

        function debounce(fn, wait) {
            let t;
            return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
        }

        function download(filename, content) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }
    </script>
</body>
</html>
