<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QNB Spend Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'media', // Uses system dark mode
            theme: {
                extend: {
                    colors: {
                        qnb: {
                            purple: '#6B46C1',
                            darkPurple: '#553C9A',
                            yellow: '#ECC94B',
                            bg: '#f8fafc',
                            darkBg: '#0f172a',
                            card: '#ffffff',
                            darkCard: '#1e293b'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .glass-panel {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        /* Custom Scrollbar for Table */
        .scroller::-webkit-scrollbar { width: 6px; height: 6px; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .dark .scroller::-webkit-scrollbar-thumb { background-color: #475569; }
    </style>
</head>
<body class="bg-qnb-bg dark:bg-qnb-darkBg text-slate-800 dark:text-slate-100 transition-colors duration-300 min-h-screen flex flex-col">

    <nav class="sticky top-0 z-50 bg-white/80 dark:bg-qnb-darkCard/80 glass-panel border-b border-slate-200 dark:border-slate-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-qnb-purple flex items-center justify-center text-white font-bold">Q</div>
                    <span class="font-bold text-xl tracking-tight">QNB Tracker</span>
                </div>
                <div class="flex items-center gap-4">
                    <span id="lastUpdated" class="text-xs text-slate-500 hidden sm:block">Syncing...</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full space-y-8">

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white dark:bg-qnb-darkCard p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 relative overflow-hidden group">
                <div class="absolute right-0 top-0 w-24 h-24 bg-red-500/5 rounded-full -mr-10 -mt-10 transition group-hover:bg-red-500/10"></div>
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Spend (30d)</p>
                <div class="mt-2 flex items-baseline gap-2">
                    <span class="text-2xl font-bold text-slate-900 dark:text-white" id="kpiOut">--</span>
                    <span class="text-xs font-medium text-slate-400">QAR</span>
                </div>
            </div>
            
            <div class="bg-white dark:bg-qnb-darkCard p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 relative overflow-hidden group">
                <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-500/5 rounded-full -mr-10 -mt-10 transition group-hover:bg-emerald-500/10"></div>
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Income (30d)</p>
                <div class="mt-2 flex items-baseline gap-2">
                    <span class="text-2xl font-bold text-emerald-600 dark:text-emerald-400" id="kpiIn">--</span>
                    <span class="text-xs font-medium text-slate-400">QAR</span>
                </div>
            </div>

            <div class="bg-white dark:bg-qnb-darkCard p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 relative overflow-hidden group">
                <div class="absolute right-0 top-0 w-24 h-24 bg-qnb-purple/5 rounded-full -mr-10 -mt-10 transition group-hover:bg-qnb-purple/10"></div>
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Net Flow</p>
                <div class="mt-2 flex items-baseline gap-2">
                    <span class="text-2xl font-bold text-slate-900 dark:text-white" id="kpiNet">--</span>
                    <span class="text-xs font-medium text-slate-400">QAR</span>
                </div>
            </div>

            <div class="bg-white dark:bg-qnb-darkCard p-5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 relative overflow-hidden group">
                <div class="absolute right-0 top-0 w-24 h-24 bg-qnb-yellow/10 rounded-full -mr-10 -mt-10 transition group-hover:bg-qnb-yellow/20"></div>
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Transactions</p>
                <div class="mt-2 flex items-baseline gap-2">
                    <span class="text-2xl font-bold text-slate-900 dark:text-white" id="kpiCount">--</span>
                    <span class="text-xs font-medium text-slate-400">Txns</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white dark:bg-qnb-darkCard p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 lg:col-span-1 flex flex-col">
                <h3 class="font-bold text-lg mb-4">Spend by Category</h3>
                <div class="relative flex-grow min-h-[250px] flex items-center justify-center">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <div class="bg-white dark:bg-qnb-darkCard p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 lg:col-span-2 flex flex-col">
                <h3 class="font-bold text-lg mb-4">Spending Trend</h3>
                <div class="relative flex-grow min-h-[250px]">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-qnb-darkCard rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col">
            <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex flex-col sm:flex-row gap-4 justify-between items-center">
                <h3 class="font-bold text-lg">Transactions</h3>
                <div class="flex gap-2 w-full sm:w-auto">
                    <input type="text" id="searchInput" placeholder="Search merchant..." 
                        class="bg-slate-50 dark:bg-slate-800 border-none rounded-lg px-4 py-2 text-sm w-full sm:w-64 focus:ring-2 focus:ring-qnb-purple outline-none">
                    <select id="typeFilter" class="bg-slate-50 dark:bg-slate-800 border-none rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-qnb-purple outline-none">
                        <option value="ALL">All Types</option>
                        <option value="Purchase">Purchases</option>
                        <option value="Fawran">Fawran</option>
                        <option value="Transfer">Transfer</option>
                        <option value="Received">Money In</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto scroller">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 dark:bg-slate-800/50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3">Date</th>
                            <th class="px-6 py-3">Merchant / Entity</th>
                            <th class="px-6 py-3">Category</th>
                            <th class="px-6 py-3">Method</th>
                            <th class="px-6 py-3 text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="txnTableBody" class="divide-y divide-slate-100 dark:divide-slate-700">
                        </tbody>
                </table>
            </div>
            <div class="p-4 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center text-xs text-slate-500">
                <span id="showingCount">Showing 0 of 0</span>
                <div class="flex gap-2">
                    <button id="prevBtn" class="px-3 py-1 bg-slate-100 dark:bg-slate-700 rounded disabled:opacity-50">Prev</button>
                    <button id="nextBtn" class="px-3 py-1 bg-slate-100 dark:bg-slate-700 rounded disabled:opacity-50">Next</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // ==========================================
        // CONFIGURATION SECTION
        // ==========================================
        
        // YOUR HARDCODED GOOGLE SHEET ID
        const SHEET_ID = '1LLpl1sH7LHqD3u3ZU4JWZJtvcHD_SGFql76llyfAIBw'; 

        // ==========================================

        // --- APP STATE ---
        const STATE = {
            transactions: [],
            merchantMap: [],
            fxRates: { 'USD': 3.65, 'EUR': 3.9, 'GBP': 4.6 }, 
            displayData: [],
            page: 1,
            rowsPerPage: 20
        };

        // --- URL BUILDER ---
        function getSheetUrl(sheetName) {
            // Added cache buster (Date.now) to prevent browser from serving old CSVs
            const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
            const query = encodeURIComponent('select *'); 
            return `${base}?tqx=out:csv&sheet=${sheetName}&tq=${query}&_=${Date.now()}`;
        }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            initDataLoad();
        });

        // --- DATA FETCHING ---
        async function initDataLoad() {
            // We fetch the 3 core sheets by NAME
            const ledgerUrl = getSheetUrl('RawLedger');
            const mapUrl = getSheetUrl('MerchantMap');
            const fxUrl = getSheetUrl('FXRates');

            const promises = [fetchCSV(ledgerUrl), fetchCSV(mapUrl), fetchCSV(fxUrl)];

            try {
                const results = await Promise.all(promises);
                const rawTxns = results[0];
                const rawMap = results[1] || [];
                const rawFX = results[2] || [];

                processFX(rawFX);
                processMap(rawMap);
                processTransactions(rawTxns);
                
                document.getElementById('lastUpdated').innerText = `Updated: ${new Date().toLocaleTimeString()}`;
            } catch (err) {
                console.error(err);
                document.getElementById('lastUpdated').innerText = `Error Syncing`;
                alert("Error loading data. Ensure your Google Sheet is shared as 'Anyone with the link' (Viewer).");
            }
        }

        function fetchCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: false,
                    skipEmptyLines: true,
                    complete: (res) => resolve(res.data),
                    error: (err) => reject(err)
                });
            });
        }

        // --- PROCESSING LOGIC ---
        function cleanString(str) {
            if (!str) return '';
            // Remove extra quotes that Google Viz API might add
            return str.toString().replace(/^"|"$/g, '');
        }

        function processFX(rows) {
            // Remove header if exists
            if (rows.length > 0 && (rows[0][0] === 'Currency' || rows[0][0].includes('Currency'))) rows.shift();
            
            rows.forEach(r => {
                if(r[0] && r[1]) {
                    const cur = cleanString(r[0]);
                    const rate = parseFloat(r[1]);
                    if (!isNaN(rate)) STATE.fxRates[cur] = rate;
                }
            });
        }

        function processMap(rows) {
            if (rows.length > 0 && rows[0][0].includes('Pattern')) rows.shift();
            
            STATE.merchantMap = rows.map(r => ({
                pattern: r[0] ? cleanString(r[0]).toLowerCase() : '',
                cleanName: cleanString(r[1]),
                category: cleanString(r[2])
            })).filter(x => x.pattern);
        }

        function categorize(rawName) {
            if (!rawName) return { name: "Unknown", cat: "Uncategorized" };
            const lower = rawName.toLowerCase();
            
            // 1. Check Map
            const match = STATE.merchantMap.find(m => lower.includes(m.pattern));
            if (match) return { name: match.cleanName, cat: match.category };

            // 2. Simple Heuristics (Fallback)
            if (lower.includes("uber") || lower.includes("karwa")) return { name: "Transport", cat: "Transport" };
            if (lower.includes("ooredoo") || lower.includes("vodafone")) return { name: "Telecom", cat: "Utilities" };
            if (lower.includes("talabat") || lower.includes("deliveroo")) return { name: "Food Delivery", cat: "Food & Drink" };
            
            return { name: rawName, cat: "Uncategorized" };
        }

        function processTransactions(rows) {
            // Spec: 0:Time, 1:Amt, 2:Cur, 3:Counterparty, 4:Card, 5:Dir, 6:Type
            
            // Filter out header
            const cleanRows = rows.filter(r => {
                const val = cleanString(r[1]);
                // Ensure it's not the header row and has a valid amount
                return val !== 'Amount' && !isNaN(parseFloat(val));
            });

            STATE.transactions = cleanRows.map(r => {
                const rawName = cleanString(r[3]);
                const meta = categorize(rawName);
                const rawAmt = parseFloat(r[1]);
                const cur = cleanString(r[2]) || 'QAR';
                const rate = STATE.fxRates[cur] || 1;

                return {
                    date: new Date(cleanString(r[0])),
                    amountRaw: rawAmt,
                    currency: cur,
                    amountQAR: cur === 'QAR' ? rawAmt : rawAmt * rate,
                    counterparty: rawName,
                    cleanName: meta.name,
                    category: meta.cat,
                    card: cleanString(r[4]),
                    direction: cleanString(r[5]), // IN or OUT
                    type: cleanString(r[6])
                };
            }).filter(t => !isNaN(t.amountRaw) && t.date instanceof Date && !isNaN(t.date));

            // Sort desc (Newest first)
            STATE.transactions.sort((a,b) => b.date - a.date);
            
            updateUI();
        }

        // --- RENDERING ---
        function updateUI() {
            // 1. Filter
            const search = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;

            STATE.displayData = STATE.transactions.filter(t => {
                const matchesSearch = t.cleanName.toLowerCase().includes(search) || t.counterparty.toLowerCase().includes(search);
                const matchesType = typeFilter === 'ALL' || t.type === typeFilter || (typeFilter === 'Received' && t.direction === 'IN');
                return matchesSearch && matchesType;
            });

            renderKPIs();
            renderCharts();
            STATE.page = 1;
            renderTable();
        }

        function renderKPIs() {
            const now = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(now.getDate() - 30);

            let kpiOut = 0, kpiIn = 0, count = 0;

            STATE.transactions.forEach(t => {
                if (t.date >= thirtyDaysAgo) {
                    count++;
                    if (t.direction === 'OUT') kpiOut += t.amountQAR;
                    else kpiIn += t.amountQAR;
                }
            });

            document.getElementById('kpiOut').innerText = kpiOut.toLocaleString('en-QA', {maximumFractionDigits: 0});
            document.getElementById('kpiIn').innerText = kpiIn.toLocaleString('en-QA', {maximumFractionDigits: 0});
            document.getElementById('kpiNet').innerText = (kpiIn - kpiOut).toLocaleString('en-QA', {maximumFractionDigits: 0});
            document.getElementById('kpiCount').innerText = count;
        }

        let catChartInstance = null;
        let trendChartInstance = null;

        function renderCharts() {
            const cats = {};
            const dates = {};
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(new Date().getDate() - 30);

            // Chart Logic
            STATE.transactions.forEach(t => {
                if (t.date < thirtyDaysAgo || t.direction !== 'OUT') return;
                
                // Aggregate Categories
                cats[t.category] = (cats[t.category] || 0) + t.amountQAR;
                
                // Aggregate Dates
                const dStr = t.date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                dates[dStr] = (dates[dStr] || 0) + t.amountQAR;
            });

            // Donut Chart
            const catCtx = document.getElementById('categoryChart').getContext('2d');
            if (catChartInstance) catChartInstance.destroy();

            catChartInstance = new Chart(catCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{
                        data: Object.values(cats),
                        backgroundColor: ['#6B46C1', '#ECC94B', '#F56565', '#48BB78', '#4299E1', '#ED8936', '#9F7AEA'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } }
                }
            });

            // Bar Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            if (trendChartInstance) trendChartInstance.destroy();
            
            // We need to sort the dates correctly for the chart, currently just reversing the keys
            // which works because we iterated through sorted transactions (desc)
            const sortedDates = Object.keys(dates).reverse(); 
            
            trendChartInstance = new Chart(trendCtx, {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Daily Spend (QAR)',
                        data: Object.values(dates).reverse(),
                        backgroundColor: '#6B46C1',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#e2e8f0' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderTable() {
            const start = (STATE.page - 1) * STATE.rowsPerPage;
            const end = start + STATE.rowsPerPage;
            const pageData = STATE.displayData.slice(start, end);
            const tbody = document.getElementById('txnTableBody');
            tbody.innerHTML = '';

            pageData.forEach(t => {
                const isInc = t.direction === 'IN';
                const colorClass = isInc ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-900 dark:text-slate-100';
                const sign = isInc ? '+' : '';
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors";
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-slate-500">${t.date.toLocaleDateString()} <span class="text-xs opacity-50 block">${t.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-slate-900 dark:text-white">${t.cleanName}</div>
                        <div class="text-xs text-slate-400 truncate max-w-[150px]">${t.counterparty}</div>
                    </td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300">${t.category}</span></td>
                    <td class="px-6 py-4 text-xs text-slate-500">${t.type} <span class="opacity-50">${t.card}</span></td>
                    <td class="px-6 py-4 text-right font-bold ${colorClass}">
                        ${sign}${t.currency} ${t.amountRaw.toLocaleString()}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('showingCount').innerText = `Showing ${Math.min(end, STATE.displayData.length)} of ${STATE.displayData.length}`;
            document.getElementById('prevBtn').disabled = STATE.page === 1;
            document.getElementById('nextBtn').disabled = end >= STATE.displayData.length;
        }

        // Listeners
        document.getElementById('searchInput').addEventListener('input', updateUI);
        document.getElementById('typeFilter').addEventListener('change', updateUI);
        document.getElementById('prevBtn').addEventListener('click', () => { STATE.page--; renderTable(); });
        document.getElementById('nextBtn').addEventListener('click', () => { STATE.page++; renderTable(); });

    </script>
</body>
</html>
