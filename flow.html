<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>FACT/Flow</title>

    <!-- PWA & Favicons -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F4C44E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="FACT/Flow">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="shortcut icon" href="favicon.ico">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <script>
        dayjs.extend(dayjs_plugin_isBetween);
        
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    colors: {
                        fact: {
                            bg: '#F3F3F3',
                            card: '#FFFFFF',
                            ink: '#111111',
                            muted: '#666666',
                            border: '#E5E5E5',
                            yellow: '#F4C44E',
                            green: '#75B876',
                            purple: '#B593C6',
                            red: '#E57373',
                            'dark-bg': '#0F0F0F',
                            'dark-card': '#1A1A1A',
                            'dark-ink': '#F3F3F3',
                            'dark-muted': '#888888',
                            'dark-border': '#2A2A2A',
                        }
                    },
                    fontFamily: {
                        display: ['Noto Sans Display', 'Noto Sans', 'system-ui', 'sans-serif'],
                        body: ['Noto Sans', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Display:wght@500;600;700&display=swap');
        
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans', system-ui, sans-serif;
            background-color: #F3F3F3;
            background-image: radial-gradient(#D1D1D1 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #0F0F0F;
                background-image: radial-gradient(#2A2A2A 1px, transparent 1px);
            }
        }
        
        .font-display { font-family: 'Noto Sans Display', 'Noto Sans', system-ui, sans-serif; }
        
        .card {
            background: white;
            border: 1px solid #E5E5E5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        
        @media (prefers-color-scheme: dark) {
            .card {
                background: #1A1A1A;
                border-color: #2A2A2A;
                box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            }
        }
        
        .period-btn {
            transition: all 0.15s ease;
        }
        .period-btn:hover {
            background: linear-gradient(135deg, #F4C44E 0%, #75B876 100%);
            color: #111;
        }
        .period-btn.active {
            background: linear-gradient(135deg, #F4C44E 0%, #75B876 50%, #B593C6 100%);
            color: white;
        }
        
        @media (prefers-color-scheme: dark) {
            .period-btn.active {
                background: #F3F3F3;
                color: #111;
            }
        }
        
        .modal-backdrop {
            background: rgba(17, 17, 17, 0.4);
            backdrop-filter: blur(4px);
        }
        .modal-box {
            animation: modalIn 0.2s ease-out;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        @media (prefers-color-scheme: dark) {
            .modal-backdrop {
                background: rgba(0, 0, 0, 0.6);
            }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #E5E5E5 25%, #F0F0F0 50%, #E5E5E5 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }
        
        @media (prefers-color-scheme: dark) {
            .skeleton {
                background: linear-gradient(90deg, #2A2A2A 25%, #333 50%, #2A2A2A 75%);
                background-size: 200% 100%;
            }
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D1D1D1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #B0B0B0; }
        
        @media (prefers-color-scheme: dark) {
            ::-webkit-scrollbar-thumb { background: #444; }
            ::-webkit-scrollbar-thumb:hover { background: #555; }
        }
        
        .corner-mark {
            position: absolute;
            width: 12px;
            height: 12px;
            border: 2px solid #111;
        }
        .corner-tl { top: -1px; left: -1px; border-right: none; border-bottom: none; }
        .corner-tr { top: -1px; right: -1px; border-left: none; border-bottom: none; }
        .corner-bl { bottom: -1px; left: -1px; border-right: none; border-top: none; }
        .corner-br { bottom: -1px; right: -1px; border-left: none; border-top: none; }
        
        @media (prefers-color-scheme: dark) {
            .corner-mark { border-color: #F3F3F3; }
        }
        
        .txn-row { transition: background 0.15s ease; }
        .txn-row:hover { background: #FAFAFA; }
        .txn-row.uncat { background: #FEF3E2; }

        @media (prefers-color-scheme: dark) {
            .txn-row:hover { background: #222; }
            .txn-row.uncat { background: #3D3020; }
        }

        /* Improved mobile spacing */
        @media (max-width: 640px) {
            .card { border-radius: 12px; }
            .modal-box { max-height: 95vh; }
        }

        /* Fade-in animation for cards */
        .card {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Better touch targets on mobile */
        @media (max-width: 640px) {
            .period-btn { padding: 8px 12px; }
            .txn-row { padding: 16px 12px; }
        }

        /* Category group card hover effect */
        .cat-group:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        @media (prefers-color-scheme: dark) {
            .cat-group:hover {
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
        }
        
        /* Date input styling */
        input[type="date"] {
            color-scheme: light;
        }
        @media (prefers-color-scheme: dark) {
            input[type="date"] {
                color-scheme: dark;
            }
        }

        /* Command Palette */
        .cmd-palette {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
        }
        .cmd-palette.active { display: flex; }
        .cmd-palette-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        .cmd-palette-box {
            position: relative;
            width: 100%;
            max-width: 480px;
            margin: 0 16px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            overflow: hidden;
            animation: cmdSlideIn 0.15s ease-out;
        }
        @media (prefers-color-scheme: dark) {
            .cmd-palette-box { background: #1A1A1A; }
        }
        @keyframes cmdSlideIn {
            from { opacity: 0; transform: translateY(-10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .cmd-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.1s;
        }
        .cmd-item:hover, .cmd-item.selected {
            background: #F4C44E20;
        }
        .cmd-item-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #F3F3F3;
            font-size: 14px;
        }
        @media (prefers-color-scheme: dark) {
            .cmd-item-icon { background: #2A2A2A; }
        }
        .cmd-item-shortcut {
            margin-left: auto;
            font-size: 10px;
            font-family: monospace;
            padding: 2px 6px;
            background: #E5E5E5;
            border-radius: 4px;
            color: #666;
        }
        @media (prefers-color-scheme: dark) {
            .cmd-item-shortcut { background: #333; color: #999; }
        }

        /* Voice Input */
        .voice-btn {
            position: relative;
            transition: all 0.2s;
        }
        .voice-btn.listening {
            animation: voicePulse 1s ease-in-out infinite;
        }
        .voice-btn.listening::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid #E57373;
            animation: voiceRing 1s ease-out infinite;
        }
        @keyframes voicePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes voiceRing {
            from { transform: scale(0.8); opacity: 1; }
            to { transform: scale(1.5); opacity: 0; }
        }

        /* Goals Progress */
        .goal-progress {
            position: relative;
            height: 6px;
            background: #E5E5E5;
            border-radius: 3px;
            overflow: visible;
        }
        @media (prefers-color-scheme: dark) {
            .goal-progress { background: #2A2A2A; }
        }
        .goal-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease-out;
        }
        .goal-progress-marker {
            position: absolute;
            top: -2px;
            width: 2px;
            height: 10px;
            background: #111;
            border-radius: 1px;
        }
        @media (prefers-color-scheme: dark) {
            .goal-progress-marker { background: #F3F3F3; }
        }

        /* Timeline Heatmap */
        .heatmap-cell {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .heatmap-cell:hover {
            transform: scale(1.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }

        /* Swipe Actions */
        .swipe-container {
            overflow: hidden;
            position: relative;
        }
        .swipe-content {
            transition: transform 0.2s ease-out;
        }
        .swipe-actions {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: stretch;
        }
        .swipe-action {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 70px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Install Banner */
        .install-banner {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            max-width: 400px;
            margin: 0 auto;
            background: linear-gradient(135deg, #F4C44E 0%, #75B876 50%, #B593C6 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 90;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Spending Velocity Ring */
        .velocity-ring {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s ease-out;
        }
        .velocity-pulse {
            animation: velocityPulse 2s ease-in-out infinite;
        }
        @keyframes velocityPulse {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.5; }
        }

        /* Dark mode toggle */
        .theme-toggle {
            position: relative;
            width: 32px;
            height: 18px;
            background: #E5E5E5;
            border-radius: 9px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .theme-toggle.dark { background: #4A5568; }
        .theme-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .theme-toggle.dark::after {
            transform: translateX(14px);
            background: #F4C44E;
        }

        /* Manual dark mode override */
        body.dark-mode {
            --fact-bg: var(--fact-dark-bg);
            --fact-card: var(--fact-dark-card);
            --fact-ink: var(--fact-dark-ink);
            --fact-muted: var(--fact-dark-muted);
            --fact-border: var(--fact-dark-border);
            background: var(--fact-dark-bg);
            color: var(--fact-dark-ink);
        }
        body.dark-mode .card {
            background: var(--fact-dark-card);
            border-color: var(--fact-dark-border);
        }

        /* Export button animation */
        .export-spin { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Forecast dashed line */
        .forecast-line {
            stroke-dasharray: 4 4;
            animation: dash 1s linear infinite;
        }
        @keyframes dash { to { stroke-dashoffset: -8; } }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        .toast {
            background: #1A1A1A;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: toastIn 0.3s ease-out;
            pointer-events: auto;
        }
        .toast.success { border-left: 3px solid #75B876; }
        .toast.error { border-left: 3px solid #E57373; }
        .toast.info { border-left: 3px solid #F4C44E; }
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .toast-exit { animation: toastOut 0.3s ease-in forwards; }
        @keyframes toastOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(50px); }
        }

        /* Keyboard shortcuts help */
        .kbd-key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 6px;
            background: #F3F3F3;
            border: 1px solid #E5E5E5;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            color: #666;
        }
        @media (prefers-color-scheme: dark) {
            .kbd-key { background: #2A2A2A; border-color: #3A3A3A; color: #AAA; }
        }

        /* Print styles */
        @media print {
            body { background: white !important; }
            .card { box-shadow: none !important; border: 1px solid #ddd !important; }
            #loginScreen, .period-btn, .theme-toggle, button, .modal-backdrop,
            .cmd-palette, .toast-container, .install-banner { display: none !important; }
            #mainApp { display: block !important; }
            @page { margin: 1cm; }
        }

        /* Confirmation Modal */
        .confirm-overlay {
            position: fixed;
            inset: 0;
            z-index: 250;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.15s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .confirm-box {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 320px;
            width: 90%;
            text-align: center;
            animation: scaleIn 0.2s ease-out;
        }
        @media (prefers-color-scheme: dark) {
            .confirm-box { background: #1A1A1A; }
        }
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Impulse Warning */
        .impulse-banner {
            background: linear-gradient(135deg, #E57373 0%, #EF5350 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: none;
            animation: shakeIn 0.5s ease-out;
        }
        @keyframes shakeIn {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        /* Daily Budget Meter */
        .budget-meter {
            height: 8px;
            background: #E5E5E5;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        @media (prefers-color-scheme: dark) {
            .budget-meter { background: #2A2A2A; }
        }
        .budget-meter-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out, background 0.3s;
        }
        .budget-meter-fill.safe { background: #75B876; }
        .budget-meter-fill.warning { background: #F4C44E; }
        .budget-meter-fill.danger { background: #E57373; }

        /* Pause Modal (for large purchases) */
        .pause-modal {
            text-align: center;
        }
        .pause-countdown {
            font-size: 48px;
            font-weight: bold;
            color: #F4C44E;
            margin: 16px 0;
        }

        /* Streak Badge */
        .streak-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #F4C44E 0%, #FFD700 100%);
            color: #111;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(244, 196, 78, 0.3);
        }

        /* Generosity Budget Section */
        .generosity-card {
            background: linear-gradient(135deg, #F8F4FF 0%, #F3E8FF 100%);
            border: 1px solid #DDD6FE;
        }
        @media (prefers-color-scheme: dark) {
            .generosity-card {
                background: linear-gradient(135deg, #2D2340 0%, #352850 100%);
                border-color: #4C3D70;
            }
        }
        body.dark-mode .generosity-card {
            background: linear-gradient(135deg, #2D2340 0%, #352850 100%);
            border-color: #4C3D70;
        }
        .generosity-meter {
            height: 10px;
            background: #E9D5FF;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        @media (prefers-color-scheme: dark) {
            .generosity-meter { background: #4C3D70; }
        }
        body.dark-mode .generosity-meter { background: #4C3D70; }
        .generosity-meter-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease-out;
            background: linear-gradient(90deg, #B593C6 0%, #9F7AEA 100%);
        }
        .generosity-meter-fill.over {
            background: linear-gradient(90deg, #E57373 0%, #EF5350 100%);
        }
        .heart-pulse {
            animation: heartPulse 1.5s ease-in-out infinite;
        }
        @keyframes heartPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .generosity-amount {
            font-family: 'Noto Sans Display', sans-serif;
            font-weight: 700;
            color: #9F7AEA;
        }
        @media (prefers-color-scheme: dark) {
            .generosity-amount { color: #C4B5FD; }
        }
        body.dark-mode .generosity-amount { color: #C4B5FD; }

        /* Focus Mode Indicator */
        .focus-mode .hide-in-focus { display: none !important; }
        .focus-mode .main-metric { font-size: 3rem !important; }

        /* Achievement Celebration */
        .celebration-overlay {
            position: fixed;
            inset: 0;
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s ease-out;
        }
        .celebration-box {
            background: linear-gradient(135deg, #F4C44E 0%, #FFD700 50%, #F4C44E 100%);
            border-radius: 24px;
            padding: 32px;
            text-align: center;
            max-width: 320px;
            animation: celebrationPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes celebrationPop {
            0% { transform: scale(0.5) rotate(-5deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(2deg); }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        .celebration-icon {
            font-size: 64px;
            animation: bounce 0.6s ease infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }
        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Achievement Badge */
        .achievement-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            background: #F9F9F9;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        @media (prefers-color-scheme: dark) {
            .achievement-badge { background: #2A2A2A; }
        }
        .achievement-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .achievement-badge.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }
        .achievement-badge .badge-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .achievement-badge.locked .badge-icon {
            filter: blur(2px);
        }

        /* Generosity Budget */
        .generosity-card {
            background: linear-gradient(135deg, #B593C6 0%, #9B7BB0 100%);
            color: white;
        }
        .generosity-meter {
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        .generosity-meter-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
    </style>
</head>

<body class="text-fact-ink dark:text-fact-dark-ink">
    <!-- Toast Notification Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Confirmation Modal (dynamic) -->
    <div id="confirmModal" class="hidden">
        <!-- Rendered dynamically by showConfirm() -->
    </div>

    <!-- Celebration Overlay (dynamic) -->
    <div id="celebrationOverlay" class="hidden">
        <!-- Rendered dynamically by celebrate() -->
    </div>

    <!-- ACHIEVEMENTS MODAL -->
    <div id="achievementsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-lg overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">Achievements</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="achievementProgress">0 of 0 unlocked</p>
                </div>
                <button onclick="closeAchievements()" class="text-fact-muted hover:text-fact-ink">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="achievementsList" class="p-5 grid grid-cols-3 gap-3 max-h-[400px] overflow-y-auto">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="card rounded-2xl p-8 w-full max-w-sm relative overflow-hidden">
            <!-- Brand color accent bar -->
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-fact-yellow via-fact-green to-fact-purple"></div>

            <div class="text-center mb-6">
                <div class="w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4 bg-[#0a0a0a]">
                    <img src="flow-icon-512.png" alt="/" class="w-12 h-12 object-contain">
                </div>
                <h1 class="font-display font-bold text-2xl">FACT/Flow</h1>
                <p class="text-fact-muted dark:text-fact-dark-muted text-sm mt-1">Personal Finance Intelligence</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username"
                        class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:border-fact-yellow"
                        onkeypress="if(event.key==='Enter')document.getElementById('loginPassword').focus()">
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password"
                        class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:border-fact-yellow"
                        onkeypress="if(event.key==='Enter')attemptLogin()">
                </div>
                <button type="button" onclick="attemptLogin()" id="loginBtn"
                    class="w-full py-3 bg-gradient-to-r from-fact-yellow via-fact-green to-fact-purple text-white rounded-lg font-medium hover:opacity-90 transition shadow-sm">
                    Sign In
                </button>
                <p id="loginError" class="text-center text-sm text-fact-red hidden">Invalid credentials</p>
            </div>

            <p class="text-center text-[10px] text-fact-muted dark:text-fact-dark-muted mt-6">FACT/Flow ¬∑ Secure Access</p>
        </div>
    </div>

    <!-- MAIN APP (hidden until logged in) -->
    <div id="mainApp" class="hidden">
    <div class="max-w-5xl mx-auto px-4 py-6 md:py-10">

        <!-- HEADER -->
        <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded flex items-center justify-center bg-[#0a0a0a]">
                    <img src="flow-icon-512.png" alt="/" class="w-8 h-8 object-contain">
                </div>
                <div>
                    <h1 class="font-display font-bold text-xl tracking-tight">FACT<span class="text-fact-yellow">/</span><span class="text-fact-muted font-normal text-sm">Flow</span></h1>
                    <p class="text-fact-muted dark:text-fact-dark-muted text-xs">
                        <span id="currentUserDisplay">Personal Intelligence</span> ¬∑
                        <button onclick="openGoals()" class="hover:text-fact-green">Goals</button> ¬∑
                        <button onclick="openHeatmap()" class="hover:text-fact-purple">Heatmap</button> ¬∑
                        <button onclick="openSettings()" class="hover:text-fact-yellow">Settings</button> ¬∑
                        <button onclick="logout()" class="hover:text-fact-red">Logout</button>
                        <span class="hidden md:inline ml-2 text-[10px] opacity-50">(</span><kbd class="hidden md:inline text-[10px] opacity-50 px-1 rounded bg-gray-100 dark:bg-gray-800">‚åòK</kbd><span class="hidden md:inline text-[10px] opacity-50">)</span>
                    </p>
                </div>
            </div>

            <!-- Period Selector + Controls -->
            <div class="flex flex-col items-end gap-2">
                <div class="flex items-center gap-2">
                    <!-- Export Button -->
                    <button onclick="exportCSV()" title="Export CSV" class="w-8 h-8 flex items-center justify-center rounded-lg border border-fact-border dark:border-fact-dark-border hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                        <svg id="exportIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                    </button>
                    <!-- Dark Mode Toggle -->
                    <div id="themeToggle" onclick="toggleDarkMode()" class="theme-toggle" title="Toggle dark mode"></div>
                    <!-- Sync Button -->
                    <button onclick="syncData()" title="Sync data" class="w-8 h-8 flex items-center justify-center rounded-lg border border-fact-border dark:border-fact-dark-border hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                </div>
                <div class="flex flex-wrap items-center gap-1 bg-white dark:bg-fact-dark-card border border-fact-border dark:border-fact-dark-border rounded-lg p-1">
                    <button onclick="setSalaryPeriod()" data-period="salary" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">Salary</button>
                    <button onclick="setPeriod('thisMonth')" data-period="thisMonth" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">Month</button>
                    <button onclick="setPeriod('lastMonth')" data-period="lastMonth" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">Last</button>
                    <button onclick="setPeriod('last90')" data-period="last90" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">90d</button>
                    <button onclick="openDatePicker()" data-period="custom" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">Custom</button>
                </div>
                <div class="flex items-center gap-2">
                    <span id="dateRangeDisplay" class="text-[10px] text-fact-muted dark:text-fact-dark-muted">--</span>
                    <span id="lastSync" class="text-[10px] text-fact-muted dark:text-fact-dark-muted">--</span>
                </div>
            </div>
        </header>
        
        <!-- LOADING STATE -->
        <div id="loadingState" class="space-y-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="skeleton h-24"></div>
                <div class="skeleton h-24"></div>
                <div class="skeleton h-24"></div>
                <div class="skeleton h-24"></div>
            </div>
            <div class="skeleton h-80"></div>
        </div>
        
        <!-- MAIN CONTENT -->
        <div id="mainContent" class="hidden space-y-4">

            <!-- BUDGET HERO - Consolidated overview -->
            <div class="card rounded-xl p-4">
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 items-center">
                    <!-- Days until salary -->
                    <div class="flex items-center gap-3">
                        <div class="w-14 h-14 rounded-full bg-fact-purple/20 flex items-center justify-center">
                            <span class="font-display font-bold text-xl text-fact-purple" id="daysUntilSalary">--</span>
                        </div>
                        <div>
                            <div class="text-xs font-medium">days to salary</div>
                            <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted" id="nextSalaryDate">~--</div>
                        </div>
                    </div>

                    <!-- In / Out / Net -->
                    <div class="col-span-2 lg:col-span-3 flex items-center justify-center gap-3 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                        <div class="text-center">
                            <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">IN</div>
                            <div class="font-display font-bold text-lg text-fact-green" id="projIncome">--</div>
                        </div>
                        <div class="text-xl text-fact-muted">‚àí</div>
                        <div class="text-center">
                            <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">OUT</div>
                            <div class="font-display font-bold text-lg text-fact-yellow" id="projExpense">--</div>
                        </div>
                        <div class="text-xl text-fact-muted">=</div>
                        <div class="text-center">
                            <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">NET</div>
                            <div class="font-display font-bold text-lg" id="projNet">--</div>
                        </div>
                    </div>

                    <!-- Daily budget -->
                    <div class="text-right">
                        <div class="flex items-center justify-end gap-2">
                            <span id="budgetStatus" class="text-[10px] px-2 py-0.5 rounded-full bg-fact-green/20 text-fact-green font-medium">On Track</span>
                        </div>
                        <div class="font-display font-bold text-lg text-fact-purple mt-1" id="suggestedDaily">--/day</div>
                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">avg: <span id="avgDailySpend">--</span>/day</div>
                    </div>
                </div>
            </div>

            <!-- TODAY'S FOCUS - Simple daily view for ADHD -->
            <div class="card rounded-xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <h2 class="font-display font-semibold text-sm">Today</h2>
                        <div id="streakContainer">
                            <!-- Streak badge rendered by JS -->
                        </div>
                    </div>
                    <div class="text-xs text-fact-muted dark:text-fact-dark-muted" id="todayDate">--</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-fact-muted dark:text-fact-dark-muted">Spent today</span>
                        <span class="font-display font-bold" id="todaySpent">--</span>
                    </div>
                    <div id="dailyBudgetMeter" class="budget-meter">
                        <div class="budget-meter-fill safe" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-fact-muted dark:text-fact-dark-muted" id="dailyBudgetLabel">-- left today</span>
                        <span class="text-xs text-fact-muted dark:text-fact-dark-muted">Budget: <span id="todayBudget">--</span></span>
                    </div>
                </div>
            </div>

            <!-- IMPULSE WARNING BANNER (shown when burst detected) -->
            <div id="impulseBanner" class="impulse-banner">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">‚ö°</span>
                        <div>
                            <div class="font-semibold text-sm">Impulse Alert</div>
                            <div class="text-xs opacity-80" id="impulseMessage">Multiple purchases detected</div>
                        </div>
                    </div>
                    <button onclick="dismissImpulseBanner()" class="text-white/80 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>

            <!-- GENEROSITY BUDGET - For those who give generously -->
            <div id="generosityCard" class="generosity-card rounded-xl p-4 hidden">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="text-xl heart-pulse">üíú</span>
                        <h2 class="font-display font-semibold text-sm">Generosity Budget</h2>
                    </div>
                    <button onclick="openGenerositySettings()" class="text-fact-purple hover:text-fact-purple/80 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </button>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-fact-muted dark:text-fact-dark-muted">Given this month</span>
                        <span class="generosity-amount" id="generositySpent">QAR 0</span>
                    </div>
                    <div class="generosity-meter">
                        <div class="generosity-meter-fill" id="generosityMeterFill" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-fact-muted dark:text-fact-dark-muted" id="generosityStatus">You can still give!</span>
                        <span class="text-xs text-fact-muted dark:text-fact-dark-muted">Budget: <span id="generosityBudget">QAR 0</span></span>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-fact-border dark:border-fact-dark-border">
                    <div class="text-xs text-fact-muted dark:text-fact-dark-muted mb-2">Recent giving:</div>
                    <div id="recentGenerosity" class="space-y-1 max-h-24 overflow-y-auto">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>

            <!-- GENEROSITY SETTINGS MODAL -->
            <div id="generosityModal" class="modal-backdrop hidden" onclick="if(event.target === this) closeGenerositySettings()">
                <div class="modal-content max-w-md" onclick="event.stopPropagation()">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-display font-semibold text-lg flex items-center gap-2">
                            <span class="heart-pulse">üíú</span> Generosity Budget
                        </h3>
                        <button onclick="closeGenerositySettings()" class="text-fact-muted hover:text-fact-ink dark:hover:text-fact-dark-ink">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>

                    <p class="text-sm text-fact-muted dark:text-fact-dark-muted mb-4">
                        It's wonderful to be generous! Setting a giving budget helps you be intentionally generous without guilt or financial strain.
                    </p>

                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-1 block">Monthly Generosity Budget (QAR)</label>
                            <input type="number" id="generosityBudgetInput" placeholder="e.g., 500" min="0" step="50"
                                class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card">
                        </div>

                        <div>
                            <label class="text-sm font-medium mb-2 block">What counts as "generosity"?</label>
                            <div id="generosityCategories" class="space-y-2 text-sm">
                                <!-- Checkboxes rendered by JS -->
                            </div>
                        </div>

                        <div class="bg-fact-purple/10 rounded-lg p-3">
                            <div class="text-xs font-medium text-fact-purple mb-1">üí° Why set a giving budget?</div>
                            <ul class="text-xs text-fact-muted dark:text-fact-dark-muted space-y-1">
                                <li>‚Ä¢ Give without guilt (you planned for it!)</li>
                                <li>‚Ä¢ Say "not this time" without feeling bad</li>
                                <li>‚Ä¢ Be generous sustainably, not impulsively</li>
                            </ul>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button onclick="closeGenerositySettings()" class="flex-1 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg text-sm font-medium">
                            Cancel
                        </button>
                        <button onclick="saveGenerositySettings()" class="flex-1 py-2 bg-fact-purple text-white rounded-lg text-sm font-medium">
                            Save Budget
                        </button>
                    </div>
                </div>
            </div>

            <!-- UNCATEGORIZED ALERT -->
            <div id="uncatAlert" class="hidden card rounded-xl p-3 border-l-4 border-fact-yellow bg-yellow-50 dark:bg-yellow-900/20 cursor-pointer hover:bg-yellow-100 dark:hover:bg-yellow-900/30 transition" onclick="openUncatModal()">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">‚ö†Ô∏è</span>
                        <span class="text-sm"><span id="uncatCount">0</span> uncategorized (QAR <span id="uncatAmount">0</span>)</span>
                    </div>
                    <span class="text-xs font-medium text-fact-yellow">Fix ‚Üí</span>
                </div>
            </div>

            <!-- MAIN GRID: Breakdown (left) | AI Chat + Transactions (right) -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4" style="min-height: 500px;">

                <!-- SPENDING BREAKDOWN (Full left - 2 cols) -->
                <div class="lg:col-span-2 card rounded-xl p-4 relative flex flex-col">
                    <div class="corner-mark corner-tl"></div>
                    <div class="corner-mark corner-tr"></div>
                    <div class="corner-mark corner-bl"></div>
                    <div class="corner-mark corner-br"></div>

                    <div class="flex items-center justify-between mb-3">
                        <h2 class="font-display font-semibold text-sm">Spending Breakdown</h2>
                        <div class="flex items-center gap-1 bg-gray-100 dark:bg-gray-800 rounded-lg p-0.5">
                            <button onclick="setViewMode('parent')" id="viewParent" class="px-2 py-1 text-[10px] font-medium rounded-md bg-fact-ink dark:bg-fact-dark-ink text-white dark:text-fact-dark-bg">Groups</button>
                            <button onclick="setViewMode('subcat')" id="viewSubcat" class="px-2 py-1 text-[10px] font-medium rounded-md text-fact-muted dark:text-fact-dark-muted">Details</button>
                        </div>
                    </div>

                    <!-- Donut Chart -->
                    <div class="relative h-44 flex items-center justify-center">
                        <canvas id="donutChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="text-center">
                                <div class="font-display font-bold text-2xl" id="donutTotal">--</div>
                                <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">Total Spent</div>
                            </div>
                        </div>
                    </div>

                    <!-- INSIGHTS (between donut and categories) -->
                    <div id="insightsSection" class="mt-3 py-3 px-3 bg-gradient-to-br from-gray-50 to-white dark:from-gray-800 dark:to-gray-900 rounded-lg border border-fact-border dark:border-fact-dark-border">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-semibold text-fact-ink dark:text-fact-dark-ink">Insights</span>
                                <span id="insightsCount" class="text-[9px] bg-fact-yellow/20 text-fact-yellow px-1.5 py-0.5 rounded-full font-medium">0</span>
                            </div>
                            <button onclick="refreshInsights()" id="refreshInsightsBtn" class="text-[10px] text-fact-muted hover:text-fact-yellow transition flex items-center gap-1" title="Refresh insights using your context">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                        <div id="insightsTags" class="flex flex-wrap gap-1.5">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Category List (expanded breakdown) -->
                    <div class="flex-1 mt-3 overflow-y-auto">
                        <div id="categoryBreakdown" class="space-y-2">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Quick dimension filters -->
                    <div class="mt-3 pt-3 border-t border-fact-border dark:border-fact-dark-border">
                        <div class="flex flex-wrap gap-1.5">
                            <button onclick="filterByDimension('workHours')" class="dim-filter px-2 py-1 text-[10px] rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">üíº Work</button>
                            <button onclick="filterByDimension('lateNight')" class="dim-filter px-2 py-1 text-[10px] rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">üåô Night</button>
                            <button onclick="filterByDimension('nightOut')" class="dim-filter px-2 py-1 text-[10px] rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">üéâ Out</button>
                            <button onclick="filterByDimension('splurge')" class="dim-filter px-2 py-1 text-[10px] rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">üí∏ Splurge</button>
                            <button onclick="filterByDimension('clear')" class="dim-filter px-2 py-1 text-[10px] rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: AI Chat (top 2/3) + Transactions (bottom 1/3) -->
                <div class="lg:col-span-3 flex flex-col gap-4">

                    <!-- AI CHAT PANEL -->
                    <div class="card rounded-xl overflow-hidden flex flex-col flex-[2]" style="min-height: 300px;">
                        <div class="p-3 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                            <div>
                                <h2 class="font-display font-semibold text-sm">Ask AI</h2>
                                <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted">using <span class="text-fact-purple" id="aiModelName">gpt-5</span></p>
                            </div>
                            <button onclick="clearAIChat()" class="text-[10px] text-fact-muted hover:text-fact-ink dark:hover:text-fact-dark-ink">Clear</button>
                        </div>

                        <!-- Chat messages -->
                        <div id="aiChatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm">
                            <div class="text-fact-muted dark:text-fact-dark-muted text-xs">Ask me anything about your spending...</div>
                        </div>

                        <!-- Quick questions -->
                        <div class="px-4 py-2 border-t border-fact-border dark:border-fact-dark-border">
                            <div class="flex flex-wrap gap-1.5">
                                <button onclick="askAIChat('What are my biggest spending categories?')" class="text-[10px] px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-fact-yellow hover:text-fact-ink transition">Top categories</button>
                                <button onclick="askAIChat('Are there any unusual transactions?')" class="text-[10px] px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-fact-yellow hover:text-fact-ink transition">Unusual?</button>
                                <button onclick="askAIChat('How can I save money?')" class="text-[10px] px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-fact-yellow hover:text-fact-ink transition">Save tips</button>
                                <button onclick="askAIChat('What are my salary payments?')" class="text-[10px] px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-fact-yellow hover:text-fact-ink transition">Salary info</button>
                            </div>
                        </div>

                        <!-- Input with Voice -->
                        <div class="p-3 border-t border-fact-border dark:border-fact-dark-border">
                            <div class="flex gap-2">
                                <input type="text" id="aiChatInput" placeholder="Ask about your spending..."
                                    class="flex-1 px-3 py-2 text-sm border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:border-fact-yellow"
                                    onkeypress="if(event.key==='Enter')askAIChat()">
                                <button id="voiceBtn" onclick="toggleVoiceInput()" title="Voice input"
                                    class="voice-btn w-10 h-10 flex items-center justify-center rounded-lg border border-fact-border dark:border-fact-dark-border hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                                    </svg>
                                </button>
                                <button onclick="askAIChat()" class="px-4 py-2 text-sm font-medium rounded-lg bg-fact-yellow text-fact-ink hover:bg-fact-yellow/80 transition">Send</button>
                            </div>
                            <div id="voiceStatus" class="hidden mt-2 text-xs text-fact-muted dark:text-fact-dark-muted text-center">
                                <span class="animate-pulse">Listening...</span>
                            </div>
                        </div>
                    </div>

                    <!-- TRANSACTIONS (bottom 1/3) -->
                    <div class="card rounded-xl overflow-hidden flex flex-col flex-1" style="min-height: 180px;">
                        <div class="p-3 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                            <div>
                                <h2 class="font-display font-semibold text-sm">Transactions</h2>
                                <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted" id="txnCountLabel">--</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <select id="txnSortSelect" onchange="sortTransactions(this.value)" class="text-[10px] px-2 py-1 border border-fact-border dark:border-fact-dark-border rounded bg-white dark:bg-fact-dark-card">
                                    <option value="date-desc">Newest</option>
                                    <option value="date-asc">Oldest</option>
                                    <option value="amount-desc">Highest</option>
                                    <option value="amount-asc">Lowest</option>
                                </select>
                                <input type="text" id="txnFilterInput" placeholder="Filter..." oninput="filterTransactions(this.value)"
                                    class="text-[10px] w-20 px-2 py-1 border border-fact-border dark:border-fact-dark-border rounded bg-white dark:bg-fact-dark-card">
                                <button onclick="openTxnModal()" class="text-xs font-medium text-fact-yellow">All</button>
                            </div>
                        </div>
                        <div id="recentTxns" class="flex-1 divide-y divide-fact-border dark:divide-fact-dark-border overflow-y-auto">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <footer class="text-center text-[10px] text-fact-muted dark:text-fact-dark-muted pt-4">
                <span id="lastSync">Not synced</span> ¬∑ <button onclick="syncData()" class="underline hover:text-fact-ink dark:hover:text-fact-dark-ink">Sync Now</button>
            </footer>
        </div>
    </div>
    </div> <!-- Close mainApp -->

    <!-- MODALS -->
    
    <!-- DATE PICKER MODAL -->
    <div id="dateModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-sm overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border">
                <h3 class="font-display font-semibold">Custom Date Range</h3>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Start Date</label>
                    <input type="date" id="startDate" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">End Date</label>
                    <input type="date" id="endDate" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                </div>
            </div>
            <div class="p-5 border-t border-fact-border dark:border-fact-dark-border flex gap-3">
                <button onclick="closeDatePicker()" class="flex-1 px-4 py-2 text-sm text-fact-muted hover:text-fact-ink rounded-lg">Cancel</button>
                <button onclick="applyCustomDate()" class="flex-1 px-4 py-2 text-sm bg-fact-ink dark:bg-fact-dark-ink text-white dark:text-fact-dark-bg rounded-lg font-medium">Apply</button>
            </div>
        </div>
    </div>
    
    <!-- CATEGORY DRILL-DOWN MODAL -->
    <div id="drilldownModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold" id="drilldownTitle">Category</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="drilldownSubtitle">-- transactions</p>
                </div>
                <button onclick="closeDrilldown()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <!-- Drilldown Charts -->
            <div class="p-5 space-y-4 border-b border-fact-border dark:border-fact-dark-border">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider mb-1">Total Spent</p>
                        <p class="font-display font-bold text-2xl" id="drilldownTotal">--</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider mb-1">vs Last Period</p>
                        <p class="font-display font-bold text-2xl" id="drilldownDelta">--</p>
                    </div>
                </div>
                
                <!-- Timeline Chart -->
                <div>
                    <p class="text-xs font-medium mb-2">Spending Over Time</p>
                    <div class="h-32">
                        <canvas id="drilldownTimeline"></canvas>
                    </div>
                </div>
                
                <!-- Breakdown Section (Merchants/Subcategories/Stats) -->
                <div id="drilldownMerchants" class="space-y-2">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Transactions -->
            <div class="flex-1 overflow-y-auto">
                <div id="drilldownTxns" class="divide-y divide-fact-border dark:divide-fact-dark-border">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- UNCATEGORIZED MODAL -->
    <div id="uncatModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">Uncategorized Transactions</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Click to categorize</p>
                </div>
                <button onclick="closeUncatModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="uncatList" class="flex-1 overflow-y-auto divide-y divide-fact-border dark:divide-fact-dark-border">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
    
    <!-- CATEGORIZE MODAL -->
    <div id="catModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-sm overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border">
                <h3 class="font-display font-semibold">Categorize Transaction</h3>
            </div>
            <div class="p-5 space-y-4">
                <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Original</div>
                    <div class="text-sm font-medium break-all" id="catModalRaw">--</div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Display Name</label>
                    <input type="text" id="catModalName" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow" placeholder="e.g., Starbucks">
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Category</label>
                    <select id="catModalCat" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>
            <div class="p-5 border-t border-fact-border dark:border-fact-dark-border flex gap-3">
                <button onclick="closeCatModal()" class="flex-1 px-4 py-2 text-sm text-fact-muted hover:text-fact-ink rounded-lg">Cancel</button>
                <button onclick="saveCategorization()" class="flex-1 px-4 py-2 text-sm bg-fact-yellow text-fact-ink rounded-lg font-medium">Save</button>
            </div>
        </div>
    </div>
    
    <!-- ALL TRANSACTIONS MODAL -->
    <div id="txnModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">All Transactions</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="txnModalCount">-- transactions</p>
                </div>
                <button onclick="closeTxnModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border flex gap-3">
                <input type="text" id="txnSearch" placeholder="Search..." class="flex-1 px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                <select id="txnFilter" class="px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div id="txnModalList" class="flex-1 overflow-y-auto divide-y divide-fact-border dark:divide-fact-dark-border">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- ALL MERCHANTS MODAL -->
    <div id="merchantModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">All Merchants</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="merchantModalCount">-- merchants</p>
                </div>
                <button onclick="closeMerchantModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border flex gap-3">
                <input type="text" id="merchantSearch" placeholder="Search merchants..." class="flex-1 px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow" oninput="filterMerchantModal()">
                <select id="merchantSort" class="px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none" onchange="filterMerchantModal()">
                    <option value="amount">By Total</option>
                    <option value="count">By Count</option>
                    <option value="name">By Name</option>
                </select>
            </div>
            <div id="merchantModalList" class="flex-1 overflow-y-auto divide-y divide-fact-border dark:divide-fact-dark-border">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- AI QUERY MODAL -->
    <div id="aiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">Ask AI About Your Spending</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Powered by GPT via GAS</p>
                </div>
                <button onclick="closeAIQuery()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Quick Questions -->
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border">
                <p class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider mb-2">Quick Questions</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="askAI('What are my biggest spending categories this period?')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Top categories</button>
                    <button onclick="askAI('Find any unusual or suspicious transactions')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Anomalies</button>
                    <button onclick="askAI('Which transactions might be work expenses I could claim?')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Work expenses</button>
                    <button onclick="askAI('Summarize my night out spending patterns')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Night outs</button>
                    <button onclick="askAI('What subscriptions or recurring payments do I have?')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Subscriptions</button>
                </div>
            </div>

            <!-- Custom Query -->
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border">
                <div class="flex gap-2">
                    <input type="text" id="aiQueryInput" placeholder="Ask anything about your spending..." class="flex-1 px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow" onkeydown="if(event.key==='Enter')askAI()">
                    <button onclick="askAI()" class="px-4 py-2 bg-fact-ink dark:bg-fact-dark-ink text-white dark:text-fact-dark-bg rounded-lg text-sm font-medium">Ask</button>
                </div>
            </div>

            <!-- Response -->
            <div class="flex-1 overflow-y-auto p-5">
                <div id="aiResponse" class="prose prose-sm dark:prose-invert max-w-none">
                    <p class="text-fact-muted dark:text-fact-dark-muted text-sm">Ask a question to analyze your spending data.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- FILTERED VIEW MODAL -->
    <div id="filteredModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold" id="filteredTitle">Filtered Transactions</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="filteredSubtitle">-- transactions</p>
                </div>
                <button onclick="closeFilteredModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Stats Summary -->
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border grid grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Total</div>
                    <div class="font-display font-bold" id="filteredTotal">--</div>
                </div>
                <div class="text-center">
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Count</div>
                    <div class="font-display font-bold" id="filteredCount">--</div>
                </div>
                <div class="text-center">
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Average</div>
                    <div class="font-display font-bold" id="filteredAvg">--</div>
                </div>
            </div>

            <div id="filteredList" class="flex-1 overflow-y-auto divide-y divide-fact-border dark:divide-fact-dark-border">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-md overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <h3 class="font-display font-semibold">Settings</h3>
                <button onclick="closeSettings()" class="text-fact-muted hover:text-fact-ink">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-6">
                <!-- AI Model Selection -->
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-2">AI Model (Ask AI)</label>
                    <select id="settingsAiModel" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow text-sm">
                        <option value="gpt-4.1-mini">gpt-4.1-mini (Fast, economical)</option>
                        <option value="gpt-4.1">gpt-4.1 (Balanced)</option>
                        <option value="gpt-5-mini" selected>gpt-5-mini (Recommended)</option>
                        <option value="gpt-5.1">gpt-5.1 (Most capable)</option>
                    </select>
                    <p class="text-[10px] text-fact-muted mt-1">Deep analysis always uses gpt-5.1</p>
                </div>

                <!-- Password Change -->
                <div class="border-t border-fact-border dark:border-fact-dark-border pt-5">
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-2">Change Password</label>
                    <div class="space-y-3">
                        <input type="password" id="settingsCurrentPass" placeholder="Current password"
                            class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow text-sm">
                        <input type="password" id="settingsNewPass" placeholder="New password"
                            class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow text-sm">
                        <input type="password" id="settingsConfirmPass" placeholder="Confirm new password"
                            class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow text-sm">
                        <button onclick="changePassword()" class="w-full px-4 py-2 text-sm bg-fact-ink dark:bg-white text-white dark:text-fact-ink rounded-lg font-medium hover:opacity-90">
                            Update Password
                        </button>
                    </div>
                    <p id="settingsPassError" class="text-xs text-fact-red mt-2 hidden"></p>
                    <p id="settingsPassSuccess" class="text-xs text-fact-green mt-2 hidden"></p>
                </div>

                <!-- User Context Info -->
                <div class="border-t border-fact-border dark:border-fact-dark-border pt-5">
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-2">AI Memory</label>
                    <p class="text-xs text-fact-muted mb-3">Teach the AI about your finances using Ask AI:</p>
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 text-xs font-mono space-y-1">
                        <p>"Remember that my salary arrives on day 28"</p>
                        <p>"Remember that Aleks handles my flights"</p>
                        <p>"Remember that Ooredoo is telecom, not splurge"</p>
                    </div>
                </div>
            </div>
            <div class="p-5 border-t border-fact-border dark:border-fact-dark-border">
                <button onclick="saveSettings()" class="w-full px-4 py-2 text-sm bg-gradient-to-r from-fact-yellow via-fact-green to-fact-purple text-white rounded-lg font-medium hover:opacity-90">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- COMMAND PALETTE -->
    <div id="cmdPalette" class="cmd-palette">
        <div class="cmd-palette-backdrop" onclick="closeCmdPalette()"></div>
        <div class="cmd-palette-box">
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border">
                <input type="text" id="cmdInput" placeholder="Type a command or search..."
                    class="w-full px-3 py-2 text-sm bg-transparent border-none focus:outline-none"
                    oninput="filterCommands(this.value)" onkeydown="handleCmdKeydown(event)">
            </div>
            <div id="cmdList" class="max-h-[300px] overflow-y-auto">
                <!-- Populated by JS -->
            </div>
            <div class="p-2 border-t border-fact-border dark:border-fact-dark-border bg-gray-50 dark:bg-gray-800">
                <div class="flex items-center justify-between text-[10px] text-fact-muted dark:text-fact-dark-muted">
                    <span><kbd class="px-1 py-0.5 bg-white dark:bg-gray-700 rounded text-[9px]">‚Üë‚Üì</kbd> Navigate</span>
                    <span><kbd class="px-1 py-0.5 bg-white dark:bg-gray-700 rounded text-[9px]">‚Üµ</kbd> Select</span>
                    <span><kbd class="px-1 py-0.5 bg-white dark:bg-gray-700 rounded text-[9px]">Esc</kbd> Close</span>
                </div>
            </div>
        </div>
    </div>

    <!-- KEYBOARD SHORTCUTS HELP MODAL -->
    <div id="shortcutsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-md overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <h3 class="font-display font-semibold">Keyboard Shortcuts</h3>
                <button onclick="closeShortcuts()" class="text-fact-muted hover:text-fact-ink">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div class="space-y-3">
                    <h4 class="text-xs font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wide">Navigation</h4>
                    <div class="flex items-center justify-between py-1">
                        <span class="text-sm">Open command palette</span>
                        <div class="flex gap-1"><span class="kbd-key">‚åò</span><span class="kbd-key">K</span></div>
                    </div>
                    <div class="flex items-center justify-between py-1">
                        <span class="text-sm">Close modal</span>
                        <span class="kbd-key">Esc</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <h4 class="text-xs font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wide">Quick Actions (in palette)</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="flex items-center justify-between"><span>Ask AI</span><span class="kbd-key">A</span></div>
                        <div class="flex items-center justify-between"><span>Refresh</span><span class="kbd-key">R</span></div>
                        <div class="flex items-center justify-between"><span>Goals</span><span class="kbd-key">G</span></div>
                        <div class="flex items-center justify-between"><span>Heatmap</span><span class="kbd-key">H</span></div>
                        <div class="flex items-center justify-between"><span>Export</span><span class="kbd-key">E</span></div>
                        <div class="flex items-center justify-between"><span>Dark Mode</span><span class="kbd-key">D</span></div>
                        <div class="flex items-center justify-between"><span>Merchants</span><span class="kbd-key">M</span></div>
                        <div class="flex items-center justify-between"><span>Transactions</span><span class="kbd-key">T</span></div>
                        <div class="flex items-center justify-between"><span>Voice</span><span class="kbd-key">V</span></div>
                        <div class="flex items-center justify-between"><span>Settings</span><span class="kbd-key">S</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GOALS MODAL -->
    <div id="goalsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-md overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">Budget Goals</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Set spending limits by category</p>
                </div>
                <button onclick="closeGoals()" class="text-fact-muted hover:text-fact-ink">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="goalsList" class="p-5 space-y-4 max-h-[400px] overflow-y-auto">
                <!-- Populated by JS -->
            </div>
            <div class="p-4 border-t border-fact-border dark:border-fact-dark-border bg-gray-50 dark:bg-gray-800">
                <button onclick="addNewGoal()" class="w-full py-2 text-sm font-medium text-fact-yellow hover:bg-fact-yellow/10 rounded-lg transition">
                    + Add Category Goal
                </button>
            </div>
        </div>
    </div>

    <!-- ADD GOAL MODAL -->
    <div id="addGoalModal" class="hidden fixed inset-0 z-60 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-sm overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border">
                <h3 class="font-display font-semibold">New Budget Goal</h3>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Category</label>
                    <select id="goalCategory" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Monthly Budget (QAR)</label>
                    <input type="number" id="goalAmount" placeholder="1000"
                        class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card">
                </div>
            </div>
            <div class="p-5 border-t border-fact-border dark:border-fact-dark-border flex gap-3">
                <button onclick="closeAddGoal()" class="flex-1 px-4 py-2 text-sm text-fact-muted hover:text-fact-ink rounded-lg">Cancel</button>
                <button onclick="saveGoal()" class="flex-1 px-4 py-2 text-sm bg-fact-yellow text-fact-ink rounded-lg font-medium">Save Goal</button>
            </div>
        </div>
    </div>

    <!-- TIMELINE HEATMAP MODAL -->
    <div id="heatmapModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-2xl overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">Spending Heatmap</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Daily spending intensity</p>
                </div>
                <button onclick="closeHeatmap()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-5">
                <div id="heatmapContainer" class="overflow-x-auto">
                    <!-- Heatmap grid populated by JS -->
                </div>
                <div class="flex items-center justify-between mt-4 text-[10px] text-fact-muted">
                    <span>Less</span>
                    <div class="flex gap-1">
                        <div class="heatmap-cell" style="background: #E5E5E5"></div>
                        <div class="heatmap-cell" style="background: #C6E48B"></div>
                        <div class="heatmap-cell" style="background: #7BC96F"></div>
                        <div class="heatmap-cell" style="background: #239A3B"></div>
                        <div class="heatmap-cell" style="background: #196127"></div>
                    </div>
                    <span>More</span>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA INSTALL BANNER -->
    <div id="installBanner" class="install-banner">
        <div class="flex items-center gap-3">
            <img src="flow-icon-512.png" alt="FACT/Flow" class="w-10 h-10 rounded-lg">
            <div>
                <div class="font-medium text-sm">Install FACT/Flow</div>
                <div class="text-[11px] opacity-80">Add to home screen for quick access</div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="dismissInstall()" class="px-3 py-1.5 text-xs opacity-80 hover:opacity-100">Later</button>
            <button onclick="installPWA()" class="px-3 py-1.5 text-xs bg-white/20 rounded-lg hover:bg-white/30 font-medium">Install</button>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // CONFIG
        const CONFIG = {
            // Multi-user: Users access via ?u=<userId> in URL
            // Each user maps to their own SHEET_ID in USER_SHEETS
            USER_SHEETS: {
                'fares': '1LLpl1sH7LHqD3u3ZU4JWZJtvcHD_SGFql76llyfAIBw',
                // Add more users: 'username': 'sheet_id'
            },
            DEFAULT_SHEET_ID: '1LLpl1sH7LHqD3u3ZU4JWZJtvcHD_SGFql76llyfAIBw',
            STORAGE_KEY: 'qnb_tracker_v4',
            DEFAULT_FX: { USD: 3.65, EUR: 3.95, GBP: 4.60, SAR: 0.97 },
            // GAS URL for AI proxy - UPDATE THIS after deploying gas_enhanced.js
            GAS_URL: 'https://script.google.com/macros/s/AKfycbzyEuhcHVz0JZejwyGT2fjYfI6UAntZ5T0M0EX9eXDnHxvPW4y5Yo5WYC1jp2FdOfH0/exec'
        };

        // Get user from URL parameter
        function getCurrentUser() {
            const params = new URLSearchParams(window.location.search);
            return params.get('u') || 'default';
        }

        function getSheetId() {
            // First try session (from GAS auth)
            if (STATE.sheetId) return STATE.sheetId;

            // Fallback to URL param / config
            const user = getCurrentUser();
            return CONFIG.USER_SHEETS[user] || CONFIG.DEFAULT_SHEET_ID;
        }

        // DIMENSION-BASED CATEGORIZATION SYSTEM
        // Instead of rigid hierarchy, use computed dimensions for flexible analysis

        // DIMENSION 1: WHAT (merchant type) - the base category
        const MERCHANT_TYPES = {
            'Groceries': { color: '#4CAF50', icon: 'üõí', essential: true },
            'Dining': { color: '#E67E22', icon: 'üçΩÔ∏è', essential: false },
            'Bars & Nightlife': { color: '#AB47BC', icon: 'üç∏', essential: false },
            'Coffee': { color: '#795548', icon: '‚òï', essential: false },
            'Delivery': { color: '#FFA726', icon: 'üì¶', essential: false },
            'Shopping': { color: '#42A5F5', icon: 'üõçÔ∏è', essential: false },
            'Transport': { color: '#26C6DA', icon: 'üöó', essential: true },
            'Health': { color: '#66BB6A', icon: 'üíä', essential: true },
            'Bills': { color: '#78909C', icon: 'üìÑ', essential: true },
            'Travel': { color: '#FF7043', icon: '‚úàÔ∏è', essential: false },
            'Entertainment': { color: '#EC407A', icon: 'üé¨', essential: false },
            'Transfer': { color: '#8D6E63', icon: 'üí∏', essential: false },
            'Family': { color: '#E91E63', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', essential: false },
            'Other': { color: '#95A5A6', icon: 'üìã', essential: false },
            'Uncategorized': { color: '#E74C3C', icon: '‚ùì', essential: false }
        };

        // DIMENSION 2: WHEN (time context)
        const TIME_CONTEXTS = {
            'Work Hours': { color: '#3498DB', hours: [7, 16], days: [0, 1, 2, 3, 4], icon: 'üíº' }, // Sun-Thu in Qatar
            'Evening': { color: '#9B59B6', hours: [17, 21], icon: 'üåÜ' },
            'Late Night': { color: '#2C3E50', hours: [21, 4], icon: 'üåô' },
            'Weekend': { color: '#E74C3C', days: [5, 6], icon: 'üéâ' }, // Fri-Sat
            'Early Morning': { color: '#F39C12', hours: [5, 7], icon: 'üåÖ' }
        };

        // DIMENSION 3: SIZE (amount tier)
        const SIZE_TIERS = {
            'Micro': { max: 25, color: '#BDC3C7', icon: '‚Ä¢' },
            'Small': { max: 100, color: '#95A5A6', icon: '‚Ä¢‚Ä¢' },
            'Medium': { max: 500, color: '#7F8C8D', icon: '‚Ä¢‚Ä¢‚Ä¢' },
            'Large': { max: 2000, color: '#34495E', icon: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' },
            'Major': { max: Infinity, color: '#2C3E50', icon: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' }
        };

        // DIMENSION 4: PATTERN (AI-detected, computed from sequences)
        const PATTERNS = {
            'Routine': { color: '#3498DB', icon: 'üîÑ', description: 'Regular, repeated spending' },
            'Night Out': { color: '#9B59B6', icon: 'üéâ', description: 'Evening social spending cluster' },
            'Splurge': { color: '#E74C3C', icon: 'üí∏', description: 'Unusually large purchase' },
            'Trip': { color: '#E67E22', icon: '‚úàÔ∏è', description: 'Travel-related cluster' },
            'Subscription': { color: '#1ABC9C', icon: 'üìÖ', description: 'Recurring fixed amount' },
            'Work Expense': { color: '#3498DB', icon: 'üíº', description: 'Likely work-related' },
            'Normal': { color: '#95A5A6', icon: '‚óã', description: 'Standard transaction' }
        };

        // High-level groupings for summary view (simplified)
        const SUMMARY_GROUPS = {
            'Essentials': {
                color: '#75B876',
                icon: 'üè†',
                types: ['Groceries', 'Bills', 'Health', 'Transport']
            },
            'Food & Drinks': {
                color: '#E67E22',
                icon: 'üçΩÔ∏è',
                types: ['Dining', 'Coffee', 'Delivery', 'Bars & Nightlife']
            },
            'Shopping & Fun': {
                color: '#42A5F5',
                icon: 'üõçÔ∏è',
                types: ['Shopping', 'Entertainment', 'Travel']
            },
            'Family': {
                color: '#E91E63',
                icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                types: ['Family']
            },
            'Other': {
                color: '#95A5A6',
                icon: 'üìã',
                types: ['Transfer', 'Other', 'Uncategorized']
            }
        };

        // Build CAT_COLORS from MERCHANT_TYPES and SUMMARY_GROUPS for backwards compatibility
        const CAT_COLORS = {};
        Object.entries(MERCHANT_TYPES).forEach(([name, data]) => CAT_COLORS[name] = data.color);
        Object.entries(SUMMARY_GROUPS).forEach(([name, data]) => CAT_COLORS[name] = data.color);

        // Compute summary group from merchant type
        function getSummaryGroup(merchantType) {
            for (const [group, data] of Object.entries(SUMMARY_GROUPS)) {
                if (data.types.includes(merchantType)) return group;
            }
            return 'Other';
        }

        // Compute time context from timestamp
        function getTimeContext(date) {
            const hour = date.hour();
            const day = date.day(); // 0 = Sunday

            const contexts = [];

            // Check weekend first (Fri-Sat in Qatar)
            if (day === 5 || day === 6) {
                contexts.push('Weekend');
            }

            // Check time of day
            if (hour >= 7 && hour < 16 && day >= 0 && day <= 4) {
                contexts.push('Work Hours');
            }
            if (hour >= 17 && hour < 21) {
                contexts.push('Evening');
            }
            if (hour >= 21 || hour < 5) {
                contexts.push('Late Night');
            }
            if (hour >= 5 && hour < 7) {
                contexts.push('Early Morning');
            }

            return contexts.length > 0 ? contexts : ['Normal'];
        }

        // Compute size tier from amount
        function getSizeTier(amount) {
            for (const [tier, data] of Object.entries(SIZE_TIERS)) {
                if (amount <= data.max) return tier;
            }
            return 'Major';
        }

        // COLORS helper
        function getTypeColor(type) {
            return MERCHANT_TYPES[type]?.color || '#95A5A6';
        }

        function getGroupColor(group) {
            return SUMMARY_GROUPS[group]?.color || '#95A5A6';
        }

        // STATE
        const STATE = {
            allTxns: [],
            filtered: [],
            merchantMap: [],
            categories: new Set(),
            fxRates: { ...CONFIG.DEFAULT_FX },
            localMappings: {},
            period: 'salary',
            dateRange: { start: dayjs().subtract(60, 'day'), end: dayjs() },
            catTarget: null,
            currentUser: getCurrentUser(),
            viewMode: 'parent', // 'parent' or 'subcat'
            hasLoaded: false
        };

        // CHARTS
        const charts = {};

        // AUTH & INIT
        document.addEventListener('DOMContentLoaded', () => {
            // Check if already logged in
            const session = getSession();
            if (session && session.user && session.sheetId) {
                showApp(session);
            } else {
                // Show login screen
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        function getSession() {
            try {
                const stored = localStorage.getItem('fact_session');
                if (!stored) return null;

                const session = JSON.parse(stored);
                // Check if token expired
                if (session.expiry && new Date(session.expiry) < new Date()) {
                    clearSession();
                    return null;
                }
                return session;
            } catch (e) {
                return null;
            }
        }

        function saveSession(user, token, expiry) {
            localStorage.setItem('fact_session', JSON.stringify({
                user,
                token,
                expiry,
                ts: Date.now()
            }));
        }

        function clearSession() {
            localStorage.removeItem('fact_session');
        }

        function getAuthToken() {
            const session = getSession();
            return session?.token || null;
        }

        async function attemptLogin() {
            console.log("attemptLogin called");
            var username = document.getElementById("loginUsername").value.trim().toLowerCase();
            var password = document.getElementById("loginPassword").value;

            if (!username || !password) {
                showLoginError("Please enter username and password");
                return;
            }

            var btn = document.getElementById("loginBtn");
            btn.textContent = "Signing in...";
            btn.disabled = true;

            try {
                var response = await fetch(CONFIG.GAS_URL, {
                    method: "POST",
                    headers: {"Content-Type": "text/plain"},
                    redirect: "follow",
                    body: JSON.stringify({
                        action: "auth",
                        user: username,
                        pass: password
                    })
                });

                if (!response.ok) {
                    console.error("Auth response not ok:", response.status);
                    showLoginError("Server error: " + response.status);
                    return;
                }

                var data = await response.json();
                console.log("Auth response:", data);

                if (data.success && data.token) {
                    saveSession(data.user, data.token, data.expiry);
                    showApp({user: data.user, token: data.token});
                } else {
                    showLoginError(data.error || "Invalid credentials");
                }
            } catch (err) {
                console.error("Login error:", err);
                showLoginError("Connection error: " + err.message);
            } finally {
                btn.textContent = "Sign In";
                btn.disabled = false;
            }
        }

        function showLoginError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        function showApp(session) {
            // Hide login, show app
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            // Set user context
            STATE.currentUser = session.user;
            STATE.authToken = session.token;

            // Update display
            const userDisplay = document.getElementById('currentUserDisplay');
            userDisplay.textContent = session.user.charAt(0).toUpperCase() + session.user.slice(1);

            // Init app
            loadLocal();
            syncData();

            // Event listeners
            const txnSearch = document.getElementById('txnSearch');
            const txnFilter = document.getElementById('txnFilter');
            if (txnSearch) txnSearch.addEventListener('input', debounce(filterTxnModal, 200));
            if (txnFilter) txnFilter.addEventListener('change', filterTxnModal);
        }

        function logout() {
            clearSession();
            location.reload();
        }

        function getStorageKey() {
            return `${CONFIG.STORAGE_KEY}_${STATE.currentUser}`;
        }

        function loadLocal() {
            try {
                const stored = localStorage.getItem(getStorageKey());
                if (stored) {
                    const data = JSON.parse(stored);
                    STATE.localMappings = data.mappings || {};
                }
            } catch (e) {}
        }

        function saveLocal() {
            localStorage.setItem(getStorageKey(), JSON.stringify({
                mappings: STATE.localMappings
            }));
        }

        // DATA FETCHING - Secure via GAS proxy
        async function syncData() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');

            try {
                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'data',
                        token: getAuthToken(),
                        sheets: ['RawLedger', 'MerchantMap', 'FXRates']
                    })
                });

                const result = await response.json();

                // Handle auth expiry
                if (result.code === 'AUTH_REQUIRED') {
                    clearSession();
                    location.reload();
                    return;
                }

                if (result.error) {
                    throw new Error(result.error);
                }

                const data = result.data;

                // Process each sheet (GAS returns arrays, same format as CSV)
                if (data.FXRates) processFX(data.FXRates.slice(1)); // Skip header
                if (data.MerchantMap) processMerchantMap(data.MerchantMap);
                if (data.RawLedger) processTxns(data.RawLedger);

                document.getElementById('lastSync').textContent = `Synced ${dayjs().format('HH:mm')}`;

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

                // Default to salary period on first load, otherwise use current period
                if (STATE.period === 'salary' || !STATE.hasLoaded) {
                    STATE.hasLoaded = true;
                    setSalaryPeriod();
                } else {
                    setPeriod(STATE.period);
                }

                // Show success toast (only after initial load)
                if (STATE.hasLoaded && typeof showToast === 'function') {
                    showToast(`Synced ${STATE.allTxns.length} transactions`, 'success');
                }

                // Check for achievements after data loads
                if (typeof checkAchievements === 'function') {
                    setTimeout(() => checkAchievements(), 1000);
                }

            } catch (err) {
                console.error('Sync error:', err);
                if (typeof showToast === 'function') {
                    showToast('Sync failed: ' + err.message, 'error');
                } else {
                    alert('Sync failed. Check your connection.');
                }
            }
        }

        // Legacy CSV fetch (kept for backwards compatibility if needed)
        function fetchCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: false,
                    skipEmptyLines: true,
                    complete: res => resolve(res.data),
                    error: err => reject(err)
                });
            });
        }

        function processFX(rows) {
            rows.forEach(r => {
                const cur = clean(r[0]);
                const rate = parseFloat(r[1]);
                if (cur && !isNaN(rate)) STATE.fxRates[cur] = rate;
            });
        }

        function processMerchantMap(rows) {
            if (rows.length && rows[0][0]?.toLowerCase().includes('pattern')) rows.shift();

            STATE.merchantMap = [];
            STATE.categories.clear();

            rows.forEach(r => {
                const pattern = clean(r[0]).toLowerCase();
                const display = clean(r[1]);
                const consolidated = clean(r[2]) || display;
                const category = clean(r[3]);

                if (pattern && category) {
                    STATE.merchantMap.push({ pattern, display, consolidated, category });
                    STATE.categories.add(category);
                }
            });

            STATE.categories.add('Uncategorized');
            updateCatDropdowns();
        }

        function processTxns(rows) {
            // Detect schema: old (8 cols) vs enhanced (12 cols)
            const headers = rows[0] || [];
            const hasEnhancedSchema = headers.length >= 10 &&
                (clean(headers[7]) === 'Category' || clean(headers[8]) === 'Category');

            const data = rows.filter(r => clean(r[1]) !== 'Amount' && !isNaN(parseFloat(r[1])));

            STATE.allTxns = data.map(r => {
                const raw = clean(r[3]);
                const counterparty = clean(r[4]) || '';
                const card = clean(r[7]) || '';
                const currency = clean(r[2]) || 'QAR';
                const amount = parseFloat(r[1]);
                const rate = STATE.fxRates[currency] || 1;
                const amtQAR = currency === 'QAR' ? amount : amount * rate;
                const txnDate = dayjs(clean(r[0]));

                // Try to get AI-assigned category from enhanced schema
                let aiMerchantType = null;
                let confidence = null;
                let aiContext = null;

                if (hasEnhancedSchema) {
                    aiMerchantType = clean(r[8]) || clean(r[7]) || null;
                    confidence = clean(r[9]) || null;
                    try {
                        aiContext = r[10] ? JSON.parse(clean(r[10])) : null;
                    } catch (e) {
                        aiContext = null;
                    }
                }

                // Get merchant type and display info
                const meta = categorize(raw, aiMerchantType);

                // Check if this is a salary transaction (check multiple fields)
                const allText = `${raw} ${counterparty} ${card}`.toLowerCase();
                const isSalary = allText.includes('salary');

                // COMPUTE DIMENSIONS
                const dims = {
                    what: meta.merchantType,
                    when: getTimeContext(txnDate),
                    size: getSizeTier(amtQAR),
                    pattern: 'Normal' // Will be computed in batch by AI
                };

                return {
                    date: txnDate,
                    amount: amtQAR,
                    currency,
                    raw,
                    counterparty,
                    card,
                    display: meta.display,
                    consolidated: meta.consolidated,
                    merchantType: meta.merchantType,
                    summaryGroup: getSummaryGroup(meta.merchantType),
                    direction: clean(r[5]),
                    txnType: clean(r[6]),
                    confidence,
                    aiContext,
                    isSalary,
                    // Dimensions
                    dims,
                    // Computed flags for quick filtering
                    isWorkHours: dims.when.includes('Work Hours'),
                    isLateNight: dims.when.includes('Late Night'),
                    isWeekend: dims.when.includes('Weekend'),
                    isLarge: dims.size === 'Large' || dims.size === 'Major',
                    isEssential: MERCHANT_TYPES[meta.merchantType]?.essential || false
                };
            }).sort((a, b) => b.date - a.date);

            // After loading, detect patterns
            detectPatterns();
        }

        function categorize(raw, aiMerchantType = null) {
            const lower = raw.toLowerCase();

            // Priority 1: Local user overrides
            if (STATE.localMappings[lower]) {
                const m = STATE.localMappings[lower];
                return {
                    display: m.display,
                    consolidated: m.consolidated,
                    merchantType: m.merchantType || m.category || 'Other'
                };
            }

            // Priority 2: AI-assigned type (if provided and valid)
            if (aiMerchantType && MERCHANT_TYPES[aiMerchantType]) {
                return { display: raw, consolidated: raw, merchantType: aiMerchantType };
            }

            // Priority 3: MerchantMap patterns
            const match = STATE.merchantMap.find(m => lower.includes(m.pattern));
            if (match) {
                // Map old categories to new merchant types
                const typeMap = {
                    'Groceries': 'Groceries',
                    'Dining': 'Dining',
                    'Bars & Hotels': 'Bars & Nightlife',
                    'Delivery': 'Delivery',
                    'Shopping': 'Shopping',
                    'Hobbies': 'Entertainment',
                    'Bills': 'Bills',
                    'Transport': 'Transport',
                    'Travel': 'Travel',
                    'Health': 'Health',
                    'Family Transfers': 'Family',
                    'Family': 'Family',
                    'Transfers': 'Transfer',
                    'Fees': 'Transfer'
                };
                const merchantType = typeMap[match.category] || match.category || 'Other';
                return { display: match.display, consolidated: match.consolidated, merchantType };
            }

            return { display: raw, consolidated: raw, merchantType: 'Uncategorized' };
        }

        // PATTERN DETECTION - runs on all transactions to find clusters
        function detectPatterns() {
            const out = STATE.allTxns.filter(t => t.direction === 'OUT');

            // Detect Night Out patterns: multiple bar/dining transactions in same evening
            const byDate = {};
            out.forEach(t => {
                const dateKey = t.date.format('YYYY-MM-DD');
                if (!byDate[dateKey]) byDate[dateKey] = [];
                byDate[dateKey].push(t);
            });

            Object.values(byDate).forEach(dayTxns => {
                const lateNightSocial = dayTxns.filter(t =>
                    t.isLateNight &&
                    ['Bars & Nightlife', 'Dining', 'Coffee'].includes(t.merchantType)
                );
                if (lateNightSocial.length >= 2) {
                    lateNightSocial.forEach(t => t.dims.pattern = 'Night Out');
                }
            });

            // Detect Work Expense candidates: work hours dining/coffee
            out.forEach(t => {
                if (t.isWorkHours && ['Dining', 'Coffee'].includes(t.merchantType) && t.dims.pattern === 'Normal') {
                    t.dims.pattern = 'Work Expense';
                }
            });

            // Detect Splurges: transactions > 3x average for that merchant type
            const avgByType = {};
            out.forEach(t => {
                if (!avgByType[t.merchantType]) avgByType[t.merchantType] = { sum: 0, count: 0 };
                avgByType[t.merchantType].sum += t.amount;
                avgByType[t.merchantType].count++;
            });
            Object.keys(avgByType).forEach(type => {
                avgByType[type].avg = avgByType[type].sum / avgByType[type].count;
            });

            out.forEach(t => {
                const avg = avgByType[t.merchantType]?.avg || 0;
                if (avg > 0 && t.amount > avg * 3 && t.dims.pattern === 'Normal') {
                    t.dims.pattern = 'Splurge';
                }
            });

            // Detect Subscriptions: same merchant, similar amount, ~monthly interval
            const byMerchant = {};
            out.forEach(t => {
                if (!byMerchant[t.consolidated]) byMerchant[t.consolidated] = [];
                byMerchant[t.consolidated].push(t);
            });

            Object.values(byMerchant).forEach(txns => {
                if (txns.length < 2) return;
                txns.sort((a, b) => a.date - b.date);

                const intervals = [];
                for (let i = 1; i < txns.length; i++) {
                    intervals.push(txns[i].date.diff(txns[i-1].date, 'day'));
                }

                const avgInterval = intervals.reduce((s, i) => s + i, 0) / intervals.length;
                const amounts = txns.map(t => t.amount);
                const avgAmount = amounts.reduce((s, a) => s + a, 0) / amounts.length;
                const amountVariance = amounts.every(a => Math.abs(a - avgAmount) < avgAmount * 0.1);

                if (avgInterval >= 25 && avgInterval <= 35 && amountVariance) {
                    txns.forEach(t => t.dims.pattern = 'Subscription');
                }
            });
        }

        // SALARY DETECTION - Find transactions with SALARY keyword
        function detectSalary() {
            // Find transactions flagged as salary (checked in processTxns)
            const salaries = STATE.allTxns.filter(t =>
                t.direction === 'IN' && t.isSalary
            ).sort((a, b) => b.date - a.date);

            if (salaries.length === 0) {
                return { salaries: [], avgInterval: 30 };
            }

            // Calculate average interval between salaries
            let avgInterval = 30;
            if (salaries.length >= 2) {
                let totalInterval = 0;
                for (let i = 1; i < Math.min(salaries.length, 6); i++) {
                    totalInterval += salaries[i-1].date.diff(salaries[i].date, 'day');
                }
                avgInterval = Math.round(totalInterval / (Math.min(salaries.length, 6) - 1));
            }

            return { salaries, avgInterval };
        }

        // Get projected next salary date - detects day-of-month pattern from history
        function getNextSalaryDate() {
            const { salaries, avgInterval } = detectSalary();
            if (salaries.length === 0) return dayjs().add(30, 'day');

            const lastSalary = salaries[0].date;

            // Analyze salary dates to detect day-of-month pattern
            if (salaries.length >= 2) {
                const daysOfMonth = salaries.slice(0, 6).map(s => s.date.date());

                // Check if salaries consistently fall on similar days (within 3 days)
                // This accounts for weekend adjustments
                const avgDay = Math.round(daysOfMonth.reduce((a, b) => a + b, 0) / daysOfMonth.length);
                const allNearAvg = daysOfMonth.every(d => Math.abs(d - avgDay) <= 3);

                if (allNearAvg) {
                    // Day-of-month pattern detected (e.g., always around 28th)
                    let nextDate = dayjs().date(avgDay);

                    // If this month's date has passed, move to next month
                    if (nextDate.isBefore(dayjs(), 'day')) {
                        nextDate = nextDate.add(1, 'month');
                    }

                    // Handle end-of-month edge cases (e.g., avgDay=30 in Feb)
                    if (avgDay > 28) {
                        const daysInMonth = nextDate.daysInMonth();
                        if (avgDay > daysInMonth) {
                            nextDate = nextDate.date(daysInMonth);
                        }
                    }

                    // Adjust for Qatar weekend (Fri=5, Sat=6) - move to Thursday
                    const dow = nextDate.day();
                    if (dow === 5) nextDate = nextDate.subtract(1, 'day'); // Fri ‚Üí Thu
                    if (dow === 6) nextDate = nextDate.subtract(2, 'day'); // Sat ‚Üí Thu

                    return nextDate;
                }
            }

            // Fallback: interval-based calculation
            return lastSalary.add(avgInterval, 'day');
        }

        // Set period to include last 2 salaries
        function setSalaryPeriod() {
            const { salaries, avgInterval } = detectSalary();

            if (salaries.length >= 2) {
                // Start from the day after the 2nd-to-last salary
                STATE.dateRange = {
                    start: salaries[1].date,
                    end: dayjs()
                };
                STATE.period = 'salary';
            } else if (salaries.length === 1) {
                // One salary found - show from that date
                STATE.dateRange = {
                    start: salaries[0].date,
                    end: dayjs()
                };
                STATE.period = 'salary';
            } else {
                // No salary detected - fall back to last 60 days
                STATE.dateRange = {
                    start: dayjs().subtract(60, 'day'),
                    end: dayjs()
                };
                STATE.period = 'last90';
            }

            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === STATE.period);
            });

            updateDateRangeDisplay();
            filterAndRender();
        }

        // Calculate budget projection
        function calculateBudgetProjection() {
            const { salaries, avgInterval } = detectSalary();
            const nextSalary = getNextSalaryDate();
            const daysUntilSalary = Math.max(0, nextSalary.diff(dayjs(), 'day'));

            const income = STATE.filtered.filter(t => t.direction === 'IN').reduce((s, t) => s + t.amount, 0);
            const expenses = STATE.filtered.filter(t => t.direction === 'OUT').reduce((s, t) => s + t.amount, 0);
            const net = income - expenses;

            // Daily budget = remaining funds / days until next salary
            const dailyBudget = daysUntilSalary > 0 ? Math.max(0, net / daysUntilSalary) : 0;

            // Calculate average daily spending from filtered period
            const periodDays = STATE.dateRange.end.diff(STATE.dateRange.start, 'day') + 1;
            const avgDailySpend = periodDays > 0 ? expenses / periodDays : 0;

            // Budget status: are we on track?
            const onTrack = dailyBudget >= avgDailySpend;

            return {
                income,
                expenses,
                net,
                daysUntilSalary,
                nextSalaryDate: nextSalary,
                dailyBudget,
                avgDailySpend,
                onTrack,
                lastSalaryAmount: salaries.length > 0 ? salaries[0].amount : 0
            };
        }

        function clean(str) {
            return str ? str.toString().replace(/^"|"$/g, '').trim() : '';
        }

        // PERIOD
        function setPeriod(period) {
            STATE.period = period;
            const now = dayjs();

            switch (period) {
                case 'thisMonth':
                    STATE.dateRange = { start: now.startOf('month'), end: now };
                    break;
                case 'lastMonth':
                    STATE.dateRange = { start: now.subtract(1, 'month').startOf('month'), end: now.subtract(1, 'month').endOf('month') };
                    break;
                case 'last90':
                    STATE.dateRange = { start: now.subtract(90, 'day'), end: now };
                    break;
                case 'thisYear':
                    STATE.dateRange = { start: now.startOf('year'), end: now };
                    break;
            }

            // Update UI
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });

            updateDateRangeDisplay();
            filterAndRender();
        }

        function updateDateRangeDisplay() {
            const { start, end } = STATE.dateRange;
            const sameYear = start.year() === end.year();
            const format = sameYear ? 'MMM D' : 'MMM D, YY';
            document.getElementById('dateRangeDisplay').textContent =
                `${start.format(format)} ‚Üí ${end.format('MMM D, YYYY')}`;
        }

        function openDatePicker() {
            document.getElementById('startDate').value = STATE.dateRange.start.format('YYYY-MM-DD');
            document.getElementById('endDate').value = STATE.dateRange.end.format('YYYY-MM-DD');
            document.getElementById('dateModal').classList.remove('hidden');
        }

        function closeDatePicker() {
            document.getElementById('dateModal').classList.add('hidden');
        }

        function applyCustomDate() {
            const start = dayjs(document.getElementById('startDate').value);
            const end = dayjs(document.getElementById('endDate').value);

            if (start.isValid() && end.isValid() && start.isBefore(end)) {
                STATE.period = 'custom';
                STATE.dateRange = { start, end };

                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.period === 'custom');
                });

                closeDatePicker();
                filterAndRender();
            } else {
                alert('Please select a valid date range');
            }
        }

        // SETTINGS
        function openSettings() {
            // Load saved settings
            const savedModel = localStorage.getItem('fact_ai_model') || 'gpt-5-mini';
            document.getElementById('settingsAiModel').value = savedModel;

            // Clear password fields
            document.getElementById('settingsCurrentPass').value = '';
            document.getElementById('settingsNewPass').value = '';
            document.getElementById('settingsConfirmPass').value = '';
            document.getElementById('settingsPassError').classList.add('hidden');
            document.getElementById('settingsPassSuccess').classList.add('hidden');

            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function saveSettings() {
            const selectedModel = document.getElementById('settingsAiModel').value;
            localStorage.setItem('fact_ai_model', selectedModel);

            // Update the model display if visible
            const modelEl = document.getElementById('aiModelName');
            if (modelEl) {
                modelEl.textContent = selectedModel;
            }

            closeSettings();
        }

        function getSelectedAiModel() {
            return localStorage.getItem('fact_ai_model') || 'gpt-5-mini';
        }

        async function changePassword() {
            const currentPass = document.getElementById('settingsCurrentPass').value;
            const newPass = document.getElementById('settingsNewPass').value;
            const confirmPass = document.getElementById('settingsConfirmPass').value;

            const errorEl = document.getElementById('settingsPassError');
            const successEl = document.getElementById('settingsPassSuccess');

            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');

            if (!currentPass || !newPass || !confirmPass) {
                errorEl.textContent = 'Please fill in all password fields';
                errorEl.classList.remove('hidden');
                return;
            }

            if (newPass !== confirmPass) {
                errorEl.textContent = 'New passwords do not match';
                errorEl.classList.remove('hidden');
                return;
            }

            if (newPass.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters';
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'changePassword',
                        token: getAuthToken(),
                        currentPass: currentPass,
                        newPass: newPass
                    })
                });
                const data = await response.json();

                if (data.error) {
                    errorEl.textContent = data.error;
                    errorEl.classList.remove('hidden');
                    return;
                }

                if (data.success) {
                    successEl.textContent = 'Password updated successfully';
                    successEl.classList.remove('hidden');
                    document.getElementById('settingsCurrentPass').value = '';
                    document.getElementById('settingsNewPass').value = '';
                    document.getElementById('settingsConfirmPass').value = '';
                }
            } catch (err) {
                errorEl.textContent = 'Connection error: ' + err.message;
                errorEl.classList.remove('hidden');
            }
        }

        // FILTER & RENDER
        function filterAndRender() {
            const { start, end } = STATE.dateRange;
            STATE.filtered = STATE.allTxns.filter(t => t.date.isBetween(start, end, 'day', '[]'));
            STATE.txnSort = STATE.txnSort || 'date-desc';
            STATE.txnFilter = STATE.txnFilter || '';

            renderBudgetProjection();
            renderDonutChart();
            renderCategoryBreakdown();
            renderRecentTxns();
            renderUncatAlert();
            renderQuickInsights();
            renderTodaySection();
            checkForImpulseBursts();
        }

        // Render Today section with daily budget meter
        function renderTodaySection() {
            // Update date
            document.getElementById('todayDate').textContent = dayjs().format('dddd, MMM D');

            // Calculate today's spending
            const status = checkDailyBudget();
            document.getElementById('todaySpent').textContent = `QAR ${formatNum(status.spent)}`;
            document.getElementById('todayBudget').textContent = `QAR ${formatNum(status.budget)}`;

            // Update meter
            updateDailyBudgetMeter();

            // Update streak
            updateStreak();
            renderStreakBadge();

            // Update generosity budget (if enabled)
            if (typeof renderGenerosityBudget === 'function') {
                renderGenerosityBudget();
            }
        }

        // Check for impulse bursts and show warning
        function checkForImpulseBursts() {
            const today = dayjs().startOf('day');
            const todayTxns = STATE.allTxns.filter(t =>
                t.direction === 'OUT' &&
                t.date.isAfter(today.subtract(1, 'day'))
            );

            const bursts = detectImpulseBurst(todayTxns);

            if (bursts.length > 0 && !STATE.impulseBannerDismissed) {
                const latest = bursts[bursts.length - 1];
                document.getElementById('impulseMessage').textContent =
                    `${latest.count} purchases (QAR ${formatNum(latest.total)}) in 30 minutes`;
                document.getElementById('impulseBanner').style.display = 'block';
            }
        }

        function dismissImpulseBanner() {
            document.getElementById('impulseBanner').style.display = 'none';
            STATE.impulseBannerDismissed = true;
        }

        // Category breakdown for left panel
        function renderCategoryBreakdown() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const container = document.getElementById('categoryBreakdown');

            if (STATE.viewMode === 'parent') {
                // Group by summary group
                const byGroup = {};
                out.forEach(t => {
                    if (!byGroup[t.summaryGroup]) byGroup[t.summaryGroup] = { total: 0, count: 0 };
                    byGroup[t.summaryGroup].total += t.amount;
                    byGroup[t.summaryGroup].count++;
                });

                const total = out.reduce((s, t) => s + t.amount, 0);
                const sorted = Object.entries(byGroup).sort((a, b) => b[1].total - a[1].total);

                container.innerHTML = sorted.map(([group, data]) => {
                    const pct = total > 0 ? (data.total / total * 100).toFixed(0) : 0;
                    const color = SUMMARY_GROUPS[group]?.color || '#999';
                    const icon = SUMMARY_GROUPS[group]?.icon || 'üìã';
                    return `
                        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition" onclick="openParentDrilldown('${group}')">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: ${color}20">
                                <span>${icon}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium truncate">${group}</span>
                                    <span class="text-sm font-bold">${formatNum(data.total)}</span>
                                </div>
                                <div class="flex items-center gap-2 mt-1">
                                    <div class="flex-1 h-1.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full rounded-full" style="width: ${pct}%; background: ${color}"></div>
                                    </div>
                                    <span class="text-[10px] text-fact-muted">${pct}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // Group by merchant type
                const byType = {};
                out.forEach(t => {
                    if (!byType[t.merchantType]) byType[t.merchantType] = { total: 0, count: 0 };
                    byType[t.merchantType].total += t.amount;
                    byType[t.merchantType].count++;
                });

                const total = out.reduce((s, t) => s + t.amount, 0);
                const sorted = Object.entries(byType).sort((a, b) => b[1].total - a[1].total);

                container.innerHTML = sorted.slice(0, 10).map(([type, data]) => {
                    const pct = total > 0 ? (data.total / total * 100).toFixed(0) : 0;
                    const color = MERCHANT_TYPES[type]?.color || '#999';
                    const icon = MERCHANT_TYPES[type]?.icon || 'üìã';
                    return `
                        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition" onclick="openDrilldown('${type}')">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs" style="background: ${color}20">
                                ${icon}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs font-medium truncate">${type}</span>
                                    <span class="text-xs font-bold">${formatNum(data.total)}</span>
                                </div>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <div class="flex-1 h-1 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full rounded-full" style="width: ${pct}%; background: ${color}"></div>
                                    </div>
                                    <span class="text-[9px] text-fact-muted">${data.count}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Transaction sorting
        function sortTransactions(sortBy) {
            STATE.txnSort = sortBy;
            renderRecentTxns();
        }

        // Transaction filtering
        function filterTransactions(query) {
            STATE.txnFilter = query.toLowerCase();
            renderRecentTxns();
        }

        // VIEW MODE TOGGLE
        function setViewMode(mode) {
            STATE.viewMode = mode;

            const parentBtn = document.getElementById('viewParent');
            const subcatBtn = document.getElementById('viewSubcat');

            if (mode === 'parent') {
                parentBtn.classList.add('bg-fact-ink', 'dark:bg-fact-dark-ink', 'text-white', 'dark:text-fact-dark-bg');
                parentBtn.classList.remove('text-fact-muted', 'dark:text-fact-dark-muted');
                subcatBtn.classList.remove('bg-fact-ink', 'dark:bg-fact-dark-ink', 'text-white', 'dark:text-fact-dark-bg');
                subcatBtn.classList.add('text-fact-muted', 'dark:text-fact-dark-muted');
            } else {
                subcatBtn.classList.add('bg-fact-ink', 'dark:bg-fact-dark-ink', 'text-white', 'dark:text-fact-dark-bg');
                subcatBtn.classList.remove('text-fact-muted', 'dark:text-fact-dark-muted');
                parentBtn.classList.remove('bg-fact-ink', 'dark:bg-fact-dark-ink', 'text-white', 'dark:text-fact-dark-bg');
                parentBtn.classList.add('text-fact-muted', 'dark:text-fact-dark-muted');
            }

            renderCategoryBreakdown();
            renderDonutChart();
        }

        // METRICS
        function renderMetrics() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const inc = STATE.filtered.filter(t => t.direction === 'IN');

            const totalSpend = out.reduce((s, t) => s + t.amount, 0);
            const totalIncome = inc.reduce((s, t) => s + t.amount, 0);
            const net = totalIncome - totalSpend;

            const daysTotal = STATE.dateRange.end.diff(STATE.dateRange.start, 'day') + 1;
            const daysPassed = dayjs().diff(STATE.dateRange.start, 'day') + 1;
            const daysLeft = Math.max(0, daysTotal - daysPassed);
            const dailyBudget = daysLeft > 0 ? net / daysLeft : 0;

            document.getElementById('metricIncome').textContent = formatNum(totalIncome);
            document.getElementById('metricSpent').textContent = formatNum(totalSpend);
            document.getElementById('metricNet').textContent = (net >= 0 ? '+' : '') + formatNum(net);
            document.getElementById('metricDaily').textContent = formatNum(Math.max(0, dailyBudget));
            document.getElementById('metricDaysLeft').textContent = `${daysLeft} days left`;

            const netDot = document.getElementById('netDot');
            netDot.classList.toggle('bg-fact-green', net >= 0);
            netDot.classList.toggle('bg-fact-red', net < 0);
        }

        // DONUT CHART
        function renderDonutChart() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');

            let labels, data, colors;

            if (STATE.viewMode === 'parent') {
                // Group by summary group (dimension-based)
                const parentSpend = {};
                out.forEach(t => {
                    const parent = t.summaryGroup;
                    parentSpend[parent] = (parentSpend[parent] || 0) + t.amount;
                });

                // Sort by priority order (matches SUMMARY_GROUPS)
                const parentOrder = ['Essentials', 'Food & Drinks', 'Shopping & Fun', 'Family', 'Other'];
                labels = parentOrder.filter(p => parentSpend[p] > 0);
                data = labels.map(p => parentSpend[p]);
                colors = labels.map(l => CAT_COLORS[l] || '#999');
            } else {
                // Original subcategory view
                const catSpend = {};
                out.forEach(t => catSpend[t.merchantType] = (catSpend[t.merchantType] || 0) + t.amount);

                const sorted = Object.entries(catSpend).sort((a, b) => b[1] - a[1]);
                labels = sorted.map(c => c[0]);
                data = sorted.map(c => c[1]);
                colors = labels.map(l => CAT_COLORS[l] || '#999');
            }

            const total = data.reduce((s, v) => s + v, 0);
            document.getElementById('donutTotal').textContent = formatNum(total);

            const ctx = document.getElementById('donutChart');
            if (charts.donut) charts.donut.destroy();

            charts.donut = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            if (STATE.viewMode === 'parent') {
                                openParentDrilldown(labels[idx]);
                            } else {
                                openDrilldown(labels[idx]);
                            }
                        }
                    }
                }
            });
        }

        // INCOME VS EXPENSE BAR
        function renderBudgetProjection() {
            const proj = calculateBudgetProjection();

            // Days until salary
            document.getElementById('daysUntilSalary').textContent = proj.daysUntilSalary;
            document.getElementById('nextSalaryDate').textContent = `~${proj.nextSalaryDate.format('MMM D')}`;

            // IN - OUT = NET
            document.getElementById('projIncome').textContent = formatNum(proj.income);
            document.getElementById('projExpense').textContent = formatNum(proj.expenses);
            const netEl = document.getElementById('projNet');
            netEl.textContent = formatNum(proj.net);
            netEl.className = `font-display font-bold text-lg ${proj.net >= 0 ? 'text-fact-green' : 'text-fact-red'}`;

            // Daily budget (compact format)
            document.getElementById('suggestedDaily').textContent = `${formatNum(proj.dailyBudget)}/day`;
            document.getElementById('avgDailySpend').textContent = formatNum(proj.avgDailySpend);

            // Budget status
            const statusEl = document.getElementById('budgetStatus');
            if (proj.onTrack) {
                statusEl.textContent = 'On Track';
                statusEl.className = 'text-[10px] px-2 py-0.5 rounded-full bg-fact-green/20 text-fact-green font-medium';
            } else {
                statusEl.textContent = 'Over Budget';
                statusEl.className = 'text-[10px] px-2 py-0.5 rounded-full bg-fact-red/20 text-fact-red font-medium';
            }
        }

        // DAILY CHART
        function renderDailyChart() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const dailySpend = {};

            out.forEach(t => {
                const key = t.date.format('YYYY-MM-DD');
                dailySpend[key] = (dailySpend[key] || 0) + t.amount;
            });

            const days = [];
            let d = STATE.dateRange.start;
            while (d.isBefore(STATE.dateRange.end) || d.isSame(STATE.dateRange.end, 'day')) {
                days.push(d.format('YYYY-MM-DD'));
                d = d.add(1, 'day');
            }

            const labels = days.map(d => dayjs(d).format('MMM D'));
            const data = days.map(d => dailySpend[d] || 0);

            const ctx = document.getElementById('dailyChart');
            if (charts.daily) charts.daily.destroy();

            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            charts.daily = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: '#F4C44E',
                        borderRadius: 3,
                        barThickness: Math.min(16, Math.max(4, 400 / days.length))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: isDark ? '#888' : '#666',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            grid: { color: isDark ? '#2A2A2A' : '#E5E5E5' },
                            ticks: { color: isDark ? '#888' : '#666' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // CUMULATIVE CHART
        function renderCumulativeChart() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT').sort((a, b) => a.date - b.date);
            const dailySpend = {};

            out.forEach(t => {
                const key = t.date.format('YYYY-MM-DD');
                dailySpend[key] = (dailySpend[key] || 0) + t.amount;
            });

            const days = [];
            let d = STATE.dateRange.start;
            while (d.isBefore(STATE.dateRange.end) || d.isSame(STATE.dateRange.end, 'day')) {
                days.push(d.format('YYYY-MM-DD'));
                d = d.add(1, 'day');
            }

            let cumulative = 0;
            const data = days.map(d => {
                cumulative += (dailySpend[d] || 0);
                return cumulative;
            });

            const labels = days.map(d => dayjs(d).format('MMM D'));

            const ctx = document.getElementById('cumulativeChart');
            if (charts.cumulative) charts.cumulative.destroy();

            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            charts.cumulative = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data,
                        borderColor: '#B593C6',
                        backgroundColor: 'rgba(181, 147, 198, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: isDark ? '#888' : '#666',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            grid: { color: isDark ? '#2A2A2A' : '#E5E5E5' },
                            ticks: { color: isDark ? '#888' : '#666' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // COMPARISON CHART
        function renderComparisonChart() {
            const now = dayjs();
            const thisMonthStart = now.startOf('month');
            const thisMonthEnd = now;
            const lastMonthStart = now.subtract(1, 'month').startOf('month');
            const lastMonthEnd = now.subtract(1, 'month').endOf('month');

            const thisMonthTxns = STATE.allTxns.filter(t => t.direction === 'OUT' && t.date.isBetween(thisMonthStart, thisMonthEnd, 'day', '[]'));
            const lastMonthTxns = STATE.allTxns.filter(t => t.direction === 'OUT' && t.date.isBetween(lastMonthStart, lastMonthEnd, 'day', '[]'));

            const thisMonthSpend = {};
            const lastMonthSpend = {};

            thisMonthTxns.forEach(t => thisMonthSpend[t.merchantType] = (thisMonthSpend[t.merchantType] || 0) + t.amount);
            lastMonthTxns.forEach(t => lastMonthSpend[t.merchantType] = (lastMonthSpend[t.merchantType] || 0) + t.amount);

            const allCats = [...new Set([...Object.keys(thisMonthSpend), ...Object.keys(lastMonthSpend)])];
            const sortedCats = allCats.sort((a, b) => (thisMonthSpend[b] || 0) - (thisMonthSpend[a] || 0)).slice(0, 8);

            const ctx = document.getElementById('comparisonChart');
            if (charts.comparison) charts.comparison.destroy();

            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            charts.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCats,
                    datasets: [
                        {
                            label: 'This Month',
                            data: sortedCats.map(c => thisMonthSpend[c] || 0),
                            backgroundColor: '#F4C44E',
                            borderRadius: 4
                        },
                        {
                            label: 'Last Month',
                            data: sortedCats.map(c => lastMonthSpend[c] || 0),
                            backgroundColor: isDark ? '#555' : '#D1D1D1',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: isDark ? '#888' : '#666', maxRotation: 45 }
                        },
                        y: {
                            grid: { color: isDark ? '#2A2A2A' : '#E5E5E5' },
                            ticks: { color: isDark ? '#888' : '#666' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // CATEGORIES LIST (Dimension-based)
        function renderCategories() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const container = document.getElementById('categoryList');

            if (STATE.viewMode === 'parent') {
                // Group by summary group
                const groupSpend = {};
                const groupCount = {};
                const typeBreakdown = {};

                out.forEach(t => {
                    const group = t.summaryGroup || 'Other';
                    groupSpend[group] = (groupSpend[group] || 0) + t.amount;
                    groupCount[group] = (groupCount[group] || 0) + 1;
                    if (!typeBreakdown[group]) typeBreakdown[group] = {};
                    typeBreakdown[group][t.merchantType] = (typeBreakdown[group][t.merchantType] || 0) + t.amount;
                });

                // Sort groups by defined order
                const groupOrder = ['Essentials', 'Food & Drinks', 'Shopping & Fun', 'Family', 'Other'];
                const total = Object.values(groupSpend).reduce((s, v) => s + v, 0) || 1;

                container.innerHTML = groupOrder
                    .filter(g => groupSpend[g] > 0)
                    .map(group => {
                        const amount = groupSpend[group];
                        const count = groupCount[group];
                        const pct = (amount / total * 100).toFixed(1);
                        const color = SUMMARY_GROUPS[group]?.color || '#95A5A6';
                        const icon = SUMMARY_GROUPS[group]?.icon || 'üìã';

                        // Top merchant types
                        const types = Object.entries(typeBreakdown[group] || {})
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 3)
                            .map(([type]) => type)
                            .join(', ');

                        return `
                            <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition" onclick="openGroupDrilldown('${group}')">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg" style="background:${color}20">${icon}</div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="font-semibold text-sm">${group}</span>
                                            <span class="font-display font-bold text-sm">${formatNum(amount)}</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="flex-1 h-2 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                                <div class="h-full rounded-full transition-all" style="width:${pct}%;background:${color}"></div>
                                            </div>
                                            <span class="text-[10px] text-fact-muted dark:text-fact-dark-muted w-12 text-right">${pct}%</span>
                                        </div>
                                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mt-1">${types} ¬∑ ${count} txns</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
            } else {
                // Detailed merchant type view
                const typeSpend = {};
                out.forEach(t => typeSpend[t.merchantType] = (typeSpend[t.merchantType] || 0) + t.amount);

                const sorted = Object.entries(typeSpend).sort((a, b) => b[1] - a[1]);
                const total = sorted.reduce((s, c) => s + c[1], 0) || 1;

                container.innerHTML = sorted.map(([type, amount]) => {
                    const pct = (amount / total * 100).toFixed(1);
                    const color = getTypeColor(type);
                    const icon = MERCHANT_TYPES[type]?.icon || 'üìã';
                    const count = out.filter(t => t.merchantType === type).length;
                    const group = getSummaryGroup(type);

                    return `
                        <div class="p-4 flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition" onclick="openTypeDrilldown('${type}')">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm" style="background:${color}20">${icon}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-1">
                                    <div>
                                        <span class="font-medium text-sm truncate">${type}</span>
                                        <span class="text-[10px] text-fact-muted dark:text-fact-dark-muted ml-2">${group}</span>
                                    </div>
                                    <span class="font-display font-semibold text-sm">${formatNum(amount)}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 h-1.5 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                        <div class="h-full rounded-full" style="width:${pct}%;background:${color}"></div>
                                    </div>
                                    <span class="text-[10px] text-fact-muted dark:text-fact-dark-muted w-12 text-right">${pct}%</span>
                                </div>
                            </div>
                            <span class="text-xs text-fact-muted dark:text-fact-dark-muted">${count}x</span>
                        </div>
                    `;
                }).join('');
            }
        }

        // Drilldown for summary group
        function openGroupDrilldown(group) {
            const types = SUMMARY_GROUPS[group]?.types || [];
            const out = STATE.filtered.filter(t => t.direction === 'OUT' && types.includes(t.merchantType));
            showFilteredResults(out, `${SUMMARY_GROUPS[group]?.icon || 'üìã'} ${group}`);
        }

        // Drilldown for merchant type
        function openTypeDrilldown(type) {
            const out = STATE.filtered.filter(t => t.direction === 'OUT' && t.merchantType === type);
            showFilteredResults(out, `${MERCHANT_TYPES[type]?.icon || 'üìã'} ${type}`);
        }

        // MERCHANTS LIST
        function renderMerchants() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const merchants = {};

            out.forEach(t => {
                if (!merchants[t.consolidated]) {
                    merchants[t.consolidated] = { count: 0, total: 0, merchantType: t.merchantType };
                }
                merchants[t.consolidated].count++;
                merchants[t.consolidated].total += t.amount;
            });

            const sorted = Object.entries(merchants)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 8);

            const container = document.getElementById('merchantList');
            const maxTotal = sorted[0]?.total || 1;

            container.innerHTML = sorted.map(m => {
                const color = getTypeColor(m.merchantType);
                const icon = MERCHANT_TYPES[m.merchantType]?.icon || 'üìã';
                const pct = (m.total / maxTotal * 100);

                return `
                    <div class="p-4 flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition" onclick="openMerchantDrilldown('${m.name.replace(/'/g, "\\'")}')">
                        <div class="w-2 h-2 rounded-full flex-shrink-0" style="background:${color}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-medium text-sm truncate">${m.name}</span>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-800 rounded-full text-fact-muted dark:text-fact-dark-muted">${m.count}x</span>
                                    <span class="font-display font-semibold text-sm">${formatNum(m.total)}</span>
                                </div>
                            </div>
                            <div class="h-1 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full rounded-full" style="width:${pct}%;background:${color}"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (sorted.length === 0) {
                container.innerHTML = '<div class="p-4 text-sm text-fact-muted dark:text-fact-dark-muted text-center">No transactions in this period</div>';
            }
        }

        // RECURRING
        function renderRecurring() {
            const out = STATE.allTxns.filter(t => t.direction === 'OUT');
            const byMerch = {};

            out.forEach(t => {
                if (!byMerch[t.consolidated]) byMerch[t.consolidated] = [];
                byMerch[t.consolidated].push(t);
            });

            const subs = [];
            Object.entries(byMerch).forEach(([name, arr]) => {
                if (arr.length < 2) return;
                arr.sort((a, b) => a.date - b.date);
                const intervals = [];
                for (let i = 1; i < arr.length; i++) {
                    intervals.push(arr[i].date.diff(arr[i-1].date, 'day'));
                }
                const avg = intervals.reduce((s, i) => s + i, 0) / intervals.length;
                if (avg >= 25 && avg <= 35) {
                    const avgAmount = arr.reduce((s, t) => s + t.amount, 0) / arr.length;
                    subs.push({ name, amount: avgAmount, freq: Math.round(avg), count: arr.length, cat: arr[0].category });
                }
            });

            const container = document.getElementById('recurringList');
            if (!subs.length) {
                container.innerHTML = '<div class="p-4 text-sm text-fact-muted dark:text-fact-dark-muted text-center">No recurring payments detected</div>';
                return;
            }

            container.innerHTML = subs.sort((a, b) => b.amount - a.amount).slice(0, 6).map(s => {
                const color = CAT_COLORS[s.cat] || '#999';
                return `
                    <div class="p-4 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full" style="background:${color}"></div>
                            <div>
                                <div class="font-medium text-sm">${s.name}</div>
                                <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">~${s.freq} days ¬∑ ${s.count} payments</div>
                            </div>
                        </div>
                        <div class="font-display font-semibold text-sm">${formatNum(s.amount)}</div>
                    </div>
                `;
            }).join('');
        }

        // RECENT TRANSACTIONS
        function renderRecentTxns() {
            let txns = [...STATE.filtered];

            // Apply filter
            if (STATE.txnFilter) {
                txns = txns.filter(t =>
                    t.display.toLowerCase().includes(STATE.txnFilter) ||
                    t.merchantType.toLowerCase().includes(STATE.txnFilter) ||
                    t.raw.toLowerCase().includes(STATE.txnFilter)
                );
            }

            // Apply sort
            switch (STATE.txnSort) {
                case 'date-asc':
                    txns.sort((a, b) => a.date - b.date);
                    break;
                case 'amount-desc':
                    txns.sort((a, b) => b.amount - a.amount);
                    break;
                case 'amount-asc':
                    txns.sort((a, b) => a.amount - b.amount);
                    break;
                default: // date-desc
                    txns.sort((a, b) => b.date - a.date);
            }

            const recent = txns.slice(0, 15);
            document.getElementById('txnCountLabel').textContent = `${txns.length} of ${STATE.filtered.length}`;

            const container = document.getElementById('recentTxns');
            container.innerHTML = recent.map(t => renderTxnRow(t)).join('');
        }

        function renderTxnRow(t) {
            const isOut = t.direction === 'OUT';
            const isUncat = t.merchantType === 'Uncategorized';
            const color = CAT_COLORS[t.merchantType] || '#999';
            // Use data attribute for raw text (safely escaped via base64)
            const safeRawData = btoa(unescape(encodeURIComponent(t.raw)));

            return `
                <div class="txn-row ${isUncat ? 'uncat' : ''} p-3 flex items-center justify-between cursor-pointer" data-raw="${safeRawData}" onclick="openCatModalSafe(this)">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-2 h-2 rounded-full flex-shrink-0" style="background:${escapeHtml(color)}"></div>
                        <div class="min-w-0">
                            <div class="font-medium text-sm truncate">${escapeHtml(t.display)}</div>
                            <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">${t.date.format('MMM D, HH:mm')}</div>
                        </div>
                    </div>
                    <div class="font-display font-semibold text-sm ${isOut ? '' : 'text-fact-green'}">${isOut ? '' : '+'}${formatNum(t.amount)}</div>
                </div>
            `;
        }

        // Safe onclick handler that reads from data attribute
        function openCatModalSafe(el) {
            const rawData = el.dataset.raw;
            if (rawData) {
                const raw = decodeURIComponent(escape(atob(rawData)));
                openCatModal(raw);
            }
        }

        // UNCATEGORIZED ALERT
        function renderUncatAlert() {
            const uncat = STATE.filtered.filter(t => t.merchantType === 'Uncategorized' && t.direction === 'OUT');
            const count = uncat.length;
            const amount = uncat.reduce((s, t) => s + t.amount, 0);

            const alert = document.getElementById('uncatAlert');
            alert.classList.toggle('hidden', count === 0);
            document.getElementById('uncatCount').textContent = count;
            document.getElementById('uncatAmount').textContent = formatNum(amount);
        }

        // DRILLDOWN MODAL
        function openDrilldown(category) {
            const out = STATE.filtered.filter(t => t.direction === 'OUT' && t.merchantType === category);
            const total = out.reduce((s, t) => s + t.amount, 0);

            // Calculate delta vs previous period
            const periodDays = STATE.dateRange.end.diff(STATE.dateRange.start, 'day');
            const prevStart = STATE.dateRange.start.subtract(periodDays + 1, 'day');
            const prevEnd = STATE.dateRange.start.subtract(1, 'day');
            const prevTxns = STATE.allTxns.filter(t => t.direction === 'OUT' && t.merchantType === category && t.date.isBetween(prevStart, prevEnd, 'day', '[]'));
            const prevTotal = prevTxns.reduce((s, t) => s + t.amount, 0);
            const delta = prevTotal > 0 ? ((total - prevTotal) / prevTotal * 100) : 0;

            document.getElementById('drilldownTitle').textContent = category;
            document.getElementById('drilldownSubtitle').textContent = `${out.length} transactions`;
            document.getElementById('drilldownTotal').textContent = `QAR ${formatNum(total)}`;
            document.getElementById('drilldownDelta').textContent = (delta >= 0 ? '+' : '') + delta.toFixed(0) + '%';
            document.getElementById('drilldownDelta').className = `font-display font-bold text-2xl ${delta <= 0 ? 'text-fact-green' : 'text-fact-red'}`;

            // Timeline
            const dailySpend = {};
            out.forEach(t => {
                const key = t.date.format('YYYY-MM-DD');
                dailySpend[key] = (dailySpend[key] || 0) + t.amount;
            });

            const days = [];
            let d = STATE.dateRange.start;
            while (d.isBefore(STATE.dateRange.end) || d.isSame(STATE.dateRange.end, 'day')) {
                days.push(d.format('YYYY-MM-DD'));
                d = d.add(1, 'day');
            }

            const ctx = document.getElementById('drilldownTimeline');
            if (charts.drilldownTimeline) charts.drilldownTimeline.destroy();

            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const color = CAT_COLORS[category] || '#999';

            charts.drilldownTimeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days.map(d => dayjs(d).format('D')),
                    datasets: [{
                        data: days.map(d => dailySpend[d] || 0),
                        backgroundColor: color,
                        borderRadius: 2,
                        barThickness: Math.min(10, Math.max(2, 300 / days.length))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, beginAtZero: true }
                    }
                }
            });

            // Merchants with count
            const merchants = {};
            out.forEach(t => {
                if (!merchants[t.consolidated]) {
                    merchants[t.consolidated] = { total: 0, count: 0 };
                }
                merchants[t.consolidated].total += t.amount;
                merchants[t.consolidated].count++;
            });
            const sortedMerch = Object.entries(merchants)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);
            const maxMerch = sortedMerch[0]?.total || 1;

            document.getElementById('drilldownMerchants').innerHTML = `
                <p class="text-xs font-medium mb-2">Top Merchants</p>
                ${sortedMerch.map(m => `
                    <div class="flex items-center gap-2 cursor-pointer hover:opacity-80" onclick="closeDrilldown(); openMerchantDrilldown('${m.name.replace(/'/g, "\\'")}')">
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between text-xs mb-0.5">
                                <span class="truncate">${m.name}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] text-fact-muted dark:text-fact-dark-muted">${m.count}x</span>
                                    <span class="font-medium">${formatNum(m.total)}</span>
                                </div>
                            </div>
                            <div class="h-1.5 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full rounded-full" style="width:${(m.total/maxMerch*100)}%;background:${color}"></div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;

            // Transactions
            document.getElementById('drilldownTxns').innerHTML = out.slice(0, 20).map(t => renderTxnRow(t)).join('');

            document.getElementById('drilldownModal').classList.remove('hidden');
        }

        function closeDrilldown() {
            document.getElementById('drilldownModal').classList.add('hidden');
        }

        // PARENT CATEGORY DRILLDOWN
        function openParentDrilldown(parentCategory) {
            const subcats = CATEGORY_HIERARCHY[parentCategory]?.subcategories || [];
            const out = STATE.filtered.filter(t => t.direction === 'OUT' && subcats.includes(t.merchantType));
            const total = out.reduce((s, t) => s + t.amount, 0);

            // Calculate delta vs previous period
            const periodDays = STATE.dateRange.end.diff(STATE.dateRange.start, 'day');
            const prevStart = STATE.dateRange.start.subtract(periodDays + 1, 'day');
            const prevEnd = STATE.dateRange.start.subtract(1, 'day');
            const prevTxns = STATE.allTxns.filter(t => t.direction === 'OUT' && subcats.includes(t.merchantType) && t.date.isBetween(prevStart, prevEnd, 'day', '[]'));
            const prevTotal = prevTxns.reduce((s, t) => s + t.amount, 0);
            const delta = prevTotal > 0 ? ((total - prevTotal) / prevTotal * 100) : 0;

            const icon = CATEGORY_HIERARCHY[parentCategory]?.icon || 'üì¶';
            document.getElementById('drilldownTitle').textContent = `${icon} ${parentCategory}`;
            document.getElementById('drilldownSubtitle').textContent = `${out.length} transactions ¬∑ ${subcats.length} subcategories`;
            document.getElementById('drilldownTotal').textContent = `QAR ${formatNum(total)}`;
            document.getElementById('drilldownDelta').textContent = (delta >= 0 ? '+' : '') + delta.toFixed(0) + '%';
            document.getElementById('drilldownDelta').className = `font-display font-bold text-2xl ${delta <= 0 ? 'text-fact-green' : 'text-fact-red'}`;

            // Timeline by subcategory
            const color = CAT_COLORS[parentCategory];
            const dailySpend = {};
            out.forEach(t => {
                const key = t.date.format('YYYY-MM-DD');
                dailySpend[key] = (dailySpend[key] || 0) + t.amount;
            });

            const days = [];
            let d = STATE.dateRange.start;
            while (d.isBefore(STATE.dateRange.end) || d.isSame(STATE.dateRange.end, 'day')) {
                days.push(d.format('YYYY-MM-DD'));
                d = d.add(1, 'day');
            }

            const ctx = document.getElementById('drilldownTimeline');
            if (charts.drilldownTimeline) charts.drilldownTimeline.destroy();

            charts.drilldownTimeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days.map(d => dayjs(d).format('D')),
                    datasets: [{
                        data: days.map(d => dailySpend[d] || 0),
                        backgroundColor: color,
                        borderRadius: 2,
                        barThickness: Math.min(10, Math.max(2, 300 / days.length))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, beginAtZero: true }
                    }
                }
            });

            // Subcategory breakdown (instead of merchants)
            const subcatSpend = {};
            out.forEach(t => {
                subcatSpend[t.merchantType] = (subcatSpend[t.merchantType] || 0) + t.amount;
            });
            const sortedSubs = Object.entries(subcatSpend).sort((a, b) => b[1] - a[1]);
            const maxSub = sortedSubs[0]?.[1] || 1;

            document.getElementById('drilldownMerchants').innerHTML = `
                <p class="text-xs font-medium mb-2 -mt-2">Subcategories</p>
                ${sortedSubs.map(([name, amt]) => {
                    const subColor = CAT_COLORS[name] || color;
                    return `
                        <div class="flex items-center gap-2 cursor-pointer hover:opacity-80" onclick="closeDrilldown(); openDrilldown('${name}')">
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between text-xs mb-0.5">
                                    <span class="truncate">${name}</span>
                                    <span class="font-medium">${formatNum(amt)}</span>
                                </div>
                                <div class="h-1.5 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full" style="width:${(amt/maxSub*100)}%;background:${subColor}"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;

            // Transactions
            document.getElementById('drilldownTxns').innerHTML = out.slice(0, 20).map(t => renderTxnRow(t)).join('');

            document.getElementById('drilldownModal').classList.remove('hidden');
        }

        // MERCHANT DRILLDOWN
        function openMerchantDrilldown(merchantName) {
            const out = STATE.filtered.filter(t => t.direction === 'OUT' && t.consolidated === merchantName);
            const total = out.reduce((s, t) => s + t.amount, 0);
            const avgTxn = out.length > 0 ? total / out.length : 0;

            document.getElementById('drilldownTitle').textContent = merchantName;
            document.getElementById('drilldownSubtitle').textContent = `${out.length} transactions ¬∑ Avg: QAR ${formatNum(avgTxn)}`;
            document.getElementById('drilldownTotal').textContent = `QAR ${formatNum(total)}`;

            // Calculate delta vs previous period
            const periodDays = STATE.dateRange.end.diff(STATE.dateRange.start, 'day');
            const prevStart = STATE.dateRange.start.subtract(periodDays + 1, 'day');
            const prevEnd = STATE.dateRange.start.subtract(1, 'day');
            const prevTxns = STATE.allTxns.filter(t => t.direction === 'OUT' && t.consolidated === merchantName && t.date.isBetween(prevStart, prevEnd, 'day', '[]'));
            const prevTotal = prevTxns.reduce((s, t) => s + t.amount, 0);
            const delta = prevTotal > 0 ? ((total - prevTotal) / prevTotal * 100) : 0;

            document.getElementById('drilldownDelta').textContent = (delta >= 0 ? '+' : '') + delta.toFixed(0) + '%';
            document.getElementById('drilldownDelta').className = `font-display font-bold text-2xl ${delta <= 0 ? 'text-fact-green' : 'text-fact-red'}`;

            const category = out[0]?.category || 'Other';
            const color = CAT_COLORS[category] || '#999';

            // Timeline
            const dailySpend = {};
            out.forEach(t => {
                const key = t.date.format('YYYY-MM-DD');
                dailySpend[key] = (dailySpend[key] || 0) + t.amount;
            });

            const days = [];
            let d = STATE.dateRange.start;
            while (d.isBefore(STATE.dateRange.end) || d.isSame(STATE.dateRange.end, 'day')) {
                days.push(d.format('YYYY-MM-DD'));
                d = d.add(1, 'day');
            }

            const ctx = document.getElementById('drilldownTimeline');
            if (charts.drilldownTimeline) charts.drilldownTimeline.destroy();

            charts.drilldownTimeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days.map(d => dayjs(d).format('D')),
                    datasets: [{
                        data: days.map(d => dailySpend[d] || 0),
                        backgroundColor: color,
                        borderRadius: 2,
                        barThickness: Math.min(10, Math.max(2, 300 / days.length))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, beginAtZero: true }
                    }
                }
            });

            // Show category & stats instead of merchants
            document.getElementById('drilldownMerchants').innerHTML = `
                <div class="grid grid-cols-3 gap-3">
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Transactions</div>
                        <div class="font-display font-bold">${out.length}</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Average</div>
                        <div class="font-display font-bold">${formatNum(avgTxn)}</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Category</div>
                        <div class="font-display font-bold text-sm truncate">${category}</div>
                    </div>
                </div>
            `;

            // Transactions
            document.getElementById('drilldownTxns').innerHTML = out.slice(0, 30).map(t => renderTxnRow(t)).join('');

            document.getElementById('drilldownModal').classList.remove('hidden');
        }

        // MERCHANT MODAL
        function openMerchantModal() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const merchants = {};

            out.forEach(t => {
                if (!merchants[t.consolidated]) {
                    merchants[t.consolidated] = { count: 0, total: 0, category: t.merchantType };
                }
                merchants[t.consolidated].count++;
                merchants[t.consolidated].total += t.amount;
            });

            STATE.allMerchants = Object.entries(merchants)
                .map(([name, data]) => ({ name, ...data }));

            document.getElementById('merchantModalCount').textContent = `${STATE.allMerchants.length} merchants`;
            document.getElementById('merchantSearch').value = '';
            document.getElementById('merchantSort').value = 'amount';
            filterMerchantModal();
            document.getElementById('merchantModal').classList.remove('hidden');
        }

        function closeMerchantModal() {
            document.getElementById('merchantModal').classList.add('hidden');
        }

        function filterMerchantModal() {
            const search = document.getElementById('merchantSearch').value.toLowerCase();
            const sortBy = document.getElementById('merchantSort').value;

            let merchants = STATE.allMerchants || [];
            if (search) {
                merchants = merchants.filter(m => m.name.toLowerCase().includes(search));
            }

            merchants.sort((a, b) => {
                if (sortBy === 'amount') return b.total - a.total;
                if (sortBy === 'count') return b.count - a.count;
                return a.name.localeCompare(b.name);
            });

            const maxTotal = merchants[0]?.total || 1;

            document.getElementById('merchantModalList').innerHTML = merchants.slice(0, 50).map(m => {
                const color = CAT_COLORS[m.category] || '#999';
                const pct = (m.total / maxTotal * 100);

                return `
                    <div class="p-4 flex items-center gap-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition" onclick="closeMerchantModal(); openMerchantDrilldown('${m.name.replace(/'/g, "\\'")}')">
                        <div class="w-2 h-2 rounded-full flex-shrink-0" style="background:${color}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-medium text-sm truncate">${m.name}</span>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-800 rounded-full text-fact-muted dark:text-fact-dark-muted">${m.count}x</span>
                                    <span class="font-display font-semibold text-sm w-20 text-right">${formatNum(m.total)}</span>
                                </div>
                            </div>
                            <div class="h-1 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full rounded-full" style="width:${pct}%;background:${color}"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // UNCATEGORIZED MODAL
        function openUncatModal() {
            const uncat = STATE.filtered.filter(t => t.merchantType === 'Uncategorized' && t.direction === 'OUT');

            document.getElementById('uncatList').innerHTML = uncat.map(t => {
                const safeRawData = btoa(unescape(encodeURIComponent(t.raw)));
                return `
                    <div class="p-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer" data-raw="${safeRawData}" onclick="closeUncatModal(); openCatModalSafe(this)">
                        <div class="min-w-0">
                            <div class="font-medium text-sm truncate">${escapeHtml(t.raw)}</div>
                            <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">${t.date.format('MMM D, HH:mm')}</div>
                        </div>
                        <div class="font-display font-semibold text-sm">${formatNum(t.amount)}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('uncatModal').classList.remove('hidden');
        }

        function closeUncatModal() {
            document.getElementById('uncatModal').classList.add('hidden');
        }

        // CATEGORIZE MODAL
        function openCatModal(raw) {
            STATE.catTarget = raw;
            // Store previous category for learning feedback loop
            const existingTxn = STATE.allTxns.find(t => t.raw.toLowerCase() === raw.toLowerCase());
            STATE.catTargetPreviousType = existingTxn?.merchantType || null;

            document.getElementById('catModalRaw').textContent = raw;
            document.getElementById('catModalName').value = '';
            document.getElementById('catModal').classList.remove('hidden');
        }

        function closeCatModal() {
            document.getElementById('catModal').classList.add('hidden');
        }

        async function saveCategorization() {
            const raw = STATE.catTarget;
            const name = document.getElementById('catModalName').value || raw;
            const cat = document.getElementById('catModalCat').value;

            if (!cat) {
                alert('Please select a category');
                return;
            }

            // Save locally first (for immediate UI update)
            STATE.localMappings[raw.toLowerCase()] = { display: name, consolidated: name, category: cat };
            saveLocal();

            STATE.allTxns.forEach(t => {
                if (t.raw.toLowerCase() === raw.toLowerCase()) {
                    t.display = name;
                    t.consolidated = name;
                    t.merchantType = cat;
                }
            });

            closeCatModal();
            filterAndRender();

            // Sync to MerchantMap via GAS (fire and forget, but log errors)
            // Include previousType for learning feedback loop
            try {
                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'learn',
                        token: getAuthToken(),
                        counterparty: raw,
                        merchantType: cat,
                        consolidated: name,
                        previousType: STATE.catTargetPreviousType || null
                    })
                });
                const result = await response.json();
                if (result.success) {
                    console.log('Categorization synced to MerchantMap:', result.action);
                    // Clear the previous type after successful sync
                    STATE.catTargetPreviousType = null;
                } else if (result.code === 'AUTH_REQUIRED') {
                    clearSession();
                    location.reload();
                }
            } catch (err) {
                console.warn('Failed to sync categorization to GAS:', err.message);
            }
        }

        function updateCatDropdowns() {
            const cats = Array.from(STATE.categories).filter(c => c !== 'Uncategorized').sort();

            document.getElementById('catModalCat').innerHTML = cats.map(c =>
                `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`
            ).join('');
            document.getElementById('txnFilter').innerHTML = '<option value="">All Categories</option>' +
                Array.from(STATE.categories).sort().map(c =>
                    `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`
                ).join('');
        }

        // ALL TRANSACTIONS MODAL
        function openTxnModal() {
            document.getElementById('txnModalCount').textContent = `${STATE.filtered.length} transactions`;
            document.getElementById('txnSearch').value = '';
            document.getElementById('txnFilter').value = '';
            renderTxnModal(STATE.filtered);
            document.getElementById('txnModal').classList.remove('hidden');
        }

        function closeTxnModal() {
            document.getElementById('txnModal').classList.add('hidden');
        }

        function filterTxnModal() {
            const search = document.getElementById('txnSearch').value.toLowerCase();
            const cat = document.getElementById('txnFilter').value;

            let txns = STATE.filtered;
            if (search) txns = txns.filter(t => t.display.toLowerCase().includes(search) || t.raw.toLowerCase().includes(search));
            if (cat) txns = txns.filter(t => t.merchantType === cat);

            document.getElementById('txnModalCount').textContent = `${txns.length} transactions`;
            renderTxnModal(txns);
        }

        function renderTxnModal(txns) {
            document.getElementById('txnModalList').innerHTML = txns.slice(0, 100).map(t => renderTxnRow(t)).join('');
        }

        // ============== FRONTEND AI INTEGRATION (via GAS proxy) ==============

        function openAIQuery() {
            // Scroll to and focus the AI chat input
            const chatInput = document.getElementById('aiChatInput');
            chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => chatInput.focus(), 300);
        }

        function closeAIQuery() {
            // No-op - kept for backwards compatibility
        }

        async function askAI(question) {
            const query = question || document.getElementById('aiQueryInput').value.trim();
            if (!query) return;

            if (CONFIG.GAS_URL === 'YOUR_GAS_DEPLOYMENT_URL_HERE') {
                document.getElementById('aiResponse').innerHTML = '<p class="text-fact-red">Please update CONFIG.GAS_URL in flow.html with your deployed GAS URL</p>';
                return;
            }

            const responseDiv = document.getElementById('aiResponse');
            responseDiv.innerHTML = '<p class="text-fact-muted animate-pulse">Analyzing your spending...</p>';

            // Prepare transaction summary and encode it
            const txnSummary = prepareTransactionSummary();

            try {
                // Secure POST-based AI query with user-selected model
                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'ai',
                        token: getAuthToken(),
                        q: query,
                        data: txnSummary,
                        model: getSelectedAiModel()
                    })
                });
                const data = await response.json();

                // Handle auth expiry
                if (data.code === 'AUTH_REQUIRED') {
                    clearSession();
                    location.reload();
                    return;
                }

                if (data.error) {
                    throw new Error(data.error);
                }

                // Handle "remember" responses specially
                if (data.remembered) {
                    responseDiv.innerHTML = `
                        <div class="bg-fact-green/10 border border-fact-green/30 rounded-lg p-4">
                            <div class="flex items-center gap-2 text-fact-green font-medium mb-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Noted!
                            </div>
                            <p class="text-sm">${sanitizeHTML(data.message)}</p>
                        </div>`;
                    return;
                }

                const answer = data.answer;
                responseDiv.innerHTML = sanitizeHTML(marked ? marked.parse(answer) : answer.replace(/\n/g, '<br>'));

                // Track AI usage achievement
                trackAchievement('fact_asked_ai');

            } catch (err) {
                responseDiv.innerHTML = `<p class="text-fact-red">Error: ${err.message}</p>`;
            }

            document.getElementById('aiQueryInput').value = '';
        }

        // Conversational AI Chat
        const aiChatHistory = [];

        async function askAIChat(question) {
            const query = question || document.getElementById('aiChatInput').value.trim();
            if (!query) return;

            const messagesDiv = document.getElementById('aiChatMessages');
            const inputEl = document.getElementById('aiChatInput');
            inputEl.value = '';

            // Add user message to chat
            messagesDiv.innerHTML += `
                <div class="flex justify-end">
                    <div class="bg-fact-yellow/20 rounded-lg px-3 py-2 max-w-[85%]">
                        <p class="text-sm">${escapeHtml(query)}</p>
                    </div>
                </div>
            `;

            // Add to history
            aiChatHistory.push({ role: 'user', content: query });

            // Show loading
            const loadingId = 'loading-' + Date.now();
            messagesDiv.innerHTML += `
                <div id="${loadingId}" class="flex justify-start">
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-lg px-3 py-2">
                        <p class="text-sm text-fact-muted animate-pulse">Thinking...</p>
                    </div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            if (CONFIG.GAS_URL === 'YOUR_GAS_DEPLOYMENT_URL_HERE') {
                document.getElementById(loadingId).innerHTML = `
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-lg px-3 py-2">
                        <p class="text-sm text-fact-red">Please set CONFIG.GAS_URL</p>
                    </div>
                `;
                return;
            }

            try {
                // Prepare context with transaction data + conversation history
                const txnSummary = prepareTransactionSummary();
                const historyContext = aiChatHistory.slice(-6).map(m =>
                    `${m.role === 'user' ? 'User' : 'Assistant'}: ${m.content}`
                ).join('\n');

                const fullContext = `Transaction Data:\n${txnSummary}\n\nConversation:\n${historyContext}`;

                // Secure POST-based AI query with user-selected model
                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'ai',
                        token: getAuthToken(),
                        q: query,
                        data: fullContext,
                        model: getSelectedAiModel()
                    })
                });
                const data = await response.json();

                // Handle auth expiry
                if (data.code === 'AUTH_REQUIRED') {
                    clearSession();
                    location.reload();
                    return;
                }

                if (data.error) throw new Error(data.error);

                // Handle "remember" responses specially
                if (data.remembered) {
                    aiChatHistory.push({ role: 'assistant', content: data.message });
                    document.getElementById(loadingId).innerHTML = `
                        <div class="bg-fact-green/10 border border-fact-green/30 rounded-lg px-3 py-2 max-w-[85%]">
                            <div class="flex items-center gap-1 text-fact-green text-xs font-medium mb-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Noted
                            </div>
                            <p class="text-sm">${sanitizeHTML(data.message)}</p>
                        </div>
                    `;
                    return;
                }

                const answer = data.answer;
                aiChatHistory.push({ role: 'assistant', content: answer });

                // Update model name and mode indicator
                if (data.model) {
                    const modelEl = document.getElementById('aiModelName');
                    const modeIndicator = data.mode === 'deep' ? ' <span class="text-fact-green">‚óè</span>' : '';
                    // Show context indicator if context is loaded
                    const ctx = data.contextLoaded;
                    const hasContext = ctx && (ctx.income + ctx.payees + ctx.corrections + ctx.preferences + (ctx.rules || 0) > 0);
                    const ctxIndicator = hasContext ? ' <span class="text-fact-purple" title="Using your context">‚óÜ</span>' : '';
                    modelEl.innerHTML = escapeHtml(data.model) + modeIndicator + ctxIndicator;
                }

                // Replace loading with answer (with mode badge for deep analysis)
                const ctx = data.contextLoaded;
                const hasContext = ctx && (ctx.income + ctx.payees + ctx.corrections + ctx.preferences + (ctx.rules || 0) > 0);
                const modeBadge = data.mode === 'deep'
                    ? '<div class="text-[9px] text-fact-green font-medium mb-1">‚ú¶ DEEP ANALYSIS</div>'
                    : '';
                // Build context description
                const ctxParts = [];
                if (ctx?.income) ctxParts.push(`${ctx.income} income`);
                if (ctx?.payees) ctxParts.push(`${ctx.payees} payees`);
                if (ctx?.corrections) ctxParts.push(`${ctx.corrections} corrections`);
                if (ctx?.rules) ctxParts.push(`${ctx.rules} rules`);
                if (ctx?.merchants) ctxParts.push(`${ctx.merchants} merchants`);
                const ctxBadge = hasContext
                    ? `<div class="text-[9px] text-fact-purple font-medium mb-1">‚óÜ Using ${ctxParts.join(', ')}</div>`
                    : '';
                document.getElementById(loadingId).innerHTML = `
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-lg px-3 py-2 max-w-[85%]">
                        ${modeBadge}${ctxBadge}
                        <div class="text-sm prose prose-sm dark:prose-invert">${sanitizeHTML(marked ? marked.parse(answer) : answer.replace(/\n/g, '<br>'))}</div>
                    </div>
                `;

            } catch (err) {
                document.getElementById(loadingId).innerHTML = `
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-lg px-3 py-2">
                        <p class="text-sm text-fact-red">Error: ${err.message}</p>
                    </div>
                `;
            }

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function clearAIChat() {
            aiChatHistory.length = 0;
            document.getElementById('aiChatMessages').innerHTML = `
                <div class="text-fact-muted dark:text-fact-dark-muted text-xs">Ask me anything about your spending...</div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Sanitize HTML (for markdown output) using DOMPurify
        function sanitizeHTML(html) {
            if (typeof DOMPurify !== 'undefined') {
                return DOMPurify.sanitize(html, {
                    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'b', 'i', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'code', 'pre', 'blockquote', 'a', 'span', 'div'],
                    ALLOWED_ATTR: ['href', 'target', 'class'],
                    ALLOW_DATA_ATTR: false
                });
            }
            // Fallback: escape everything
            return escapeHtml(html);
        }

        function prepareTransactionSummary() {
            const txns = STATE.filtered.filter(t => t.direction === 'OUT');

            // Group by merchant type
            const byType = {};
            txns.forEach(t => {
                if (!byType[t.merchantType]) byType[t.merchantType] = { total: 0, count: 0, txns: [] };
                byType[t.merchantType].total += t.amount;
                byType[t.merchantType].count++;
                byType[t.merchantType].txns.push(t);
            });

            // Build summary
            let summary = `Period: ${STATE.dateRange.start.format('MMM D')} - ${STATE.dateRange.end.format('MMM D, YYYY')}\n`;
            summary += `Total Transactions: ${txns.length}\n`;
            summary += `Total Spent: QAR ${formatNum(txns.reduce((s, t) => s + t.amount, 0))}\n\n`;

            summary += `By Type:\n`;
            Object.entries(byType)
                .sort((a, b) => b[1].total - a[1].total)
                .forEach(([type, data]) => {
                    summary += `- ${type}: QAR ${formatNum(data.total)} (${data.count} txns)\n`;
                });

            summary += `\nRecent transactions (last 30):\n`;
            txns.slice(0, 30).forEach(t => {
                summary += `${t.date.format('MMM D HH:mm')} | ${t.display} | QAR ${formatNum(t.amount)} | ${t.merchantType} | ${t.dims.when.join(', ')} | ${t.dims.pattern}\n`;
            });

            return summary;
        }

        // Quick insights generation
        function renderQuickInsights() {
            const out = STATE.filtered.filter(t => t.direction === 'OUT');
            const insights = [];

            // Night out patterns
            const nightOuts = out.filter(t => t.dims.pattern === 'Night Out');
            if (nightOuts.length > 0) {
                const total = nightOuts.reduce((s, t) => s + t.amount, 0);
                insights.push({
                    icon: 'üéâ',
                    text: `${nightOuts.length} Night Out transactions totaling QAR ${formatNum(total)}`,
                    filter: 'nightOut'
                });
            }

            // Work expense candidates
            const workExpenses = out.filter(t => t.dims.pattern === 'Work Expense');
            if (workExpenses.length > 0) {
                const total = workExpenses.reduce((s, t) => s + t.amount, 0);
                insights.push({
                    icon: 'üíº',
                    text: `${workExpenses.length} potential work expenses (QAR ${formatNum(total)})`,
                    filter: 'workHours'
                });
            }

            // Splurges
            const splurges = out.filter(t => t.dims.pattern === 'Splurge');
            if (splurges.length > 0) {
                const total = splurges.reduce((s, t) => s + t.amount, 0);
                insights.push({
                    icon: 'üí∏',
                    text: `${splurges.length} splurge purchases (QAR ${formatNum(total)})`,
                    filter: 'splurge'
                });
            }

            // Subscriptions
            const subs = out.filter(t => t.dims.pattern === 'Subscription');
            if (subs.length > 0) {
                const merchants = [...new Set(subs.map(t => t.consolidated))];
                insights.push({
                    icon: 'üìÖ',
                    text: `${merchants.length} detected subscriptions`,
                    filter: 'subscription'
                });
            }

            // Late night spending
            const lateNight = out.filter(t => t.isLateNight);
            if (lateNight.length >= 3) {
                const total = lateNight.reduce((s, t) => s + t.amount, 0);
                insights.push({
                    icon: 'üåô',
                    text: `QAR ${formatNum(total)} spent late at night (${lateNight.length} txns)`,
                    filter: 'lateNight'
                });
            }

            // Large purchases
            const large = out.filter(t => t.isLarge);
            if (large.length > 0) {
                insights.push({
                    icon: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
                    text: `${large.length} large purchases (500+ QAR each)`,
                    filter: 'large'
                });
            }

            // Render insights as styled tags in the insights section
            const tagsContainer = document.getElementById('insightsTags');
            const insightsSection = document.getElementById('insightsSection');

            // Update insights count badge
            const countEl = document.getElementById('insightsCount');
            if (countEl) countEl.textContent = insights.length;

            if (insights.length === 0) {
                insightsSection.classList.add('hidden');
            } else {
                insightsSection.classList.remove('hidden');

                // Color mapping for different insight types
                const colorMap = {
                    'nightOut': 'bg-fact-purple/15 text-fact-purple border-fact-purple/30',
                    'workHours': 'bg-fact-yellow/15 text-fact-ink border-fact-yellow/50',
                    'splurge': 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 border-red-200 dark:border-red-800',
                    'subscription': 'bg-fact-green/15 text-fact-green border-fact-green/30',
                    'lateNight': 'bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 border-indigo-200 dark:border-indigo-800',
                    'large': 'bg-gray-100 dark:bg-gray-800 text-fact-ink dark:text-fact-dark-ink border-fact-border dark:border-fact-dark-border'
                };

                tagsContainer.innerHTML = insights.map(i => {
                    const colors = colorMap[i.filter] || 'bg-gray-100 dark:bg-gray-800 text-fact-muted border-fact-border';
                    return `<button onclick="filterByDimension('${i.filter}')"
                        class="inline-flex items-center gap-1.5 px-2.5 py-1 text-[11px] font-medium rounded-full border ${colors} hover:scale-105 transition-transform cursor-pointer">
                        <span>${i.icon}</span>
                        <span>${i.text}</span>
                    </button>`;
                }).join('');
            }
        }

        // Refresh insights using AI with user context
        async function refreshInsights() {
            const btn = document.getElementById('refreshInsightsBtn');
            const tagsContainer = document.getElementById('insightsTags');

            // Show loading state
            btn.disabled = true;
            btn.innerHTML = `
                <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Analyzing...
            `;

            try {
                // Prepare summary of current filtered transactions
                const txnSummary = prepareTransactionSummary();

                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'ai',
                        token: getAuthToken(),
                        q: 'Give me 3-5 quick bullet-point insights about this spending data. Be specific with numbers. Focus on patterns, anomalies, and actionable observations. Use emojis for each point. Keep each insight to one short sentence.',
                        data: txnSummary,
                        model: 'gpt-5.1' // Best model for insights analysis
                    })
                });

                const data = await response.json();

                if (data.error) throw new Error(data.error);

                // Parse the AI response and display as insights
                const aiInsights = data.answer
                    .split('\n')
                    .filter(line => line.trim().length > 0)
                    .map(line => line.replace(/^[-*‚Ä¢]\s*/, '').trim())
                    .filter(line => line.length > 0)
                    .slice(0, 5);

                if (aiInsights.length > 0) {
                    document.getElementById('insightsCount').textContent = aiInsights.length;
                    tagsContainer.innerHTML = aiInsights.map(insight => `
                        <div class="w-full px-2.5 py-1.5 text-[11px] bg-gradient-to-r from-fact-yellow/10 to-fact-green/10 border border-fact-yellow/20 rounded-lg text-fact-ink dark:text-fact-dark-ink">
                            ${sanitizeHTML(insight)}
                        </div>
                    `).join('');
                }

            } catch (err) {
                tagsContainer.innerHTML = `<div class="text-[11px] text-fact-red">Error: ${err.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Refresh
                `;
            }
        }

        // ============== DIMENSION FILTERING ==============

        function filterByDimension(dimension) {
            let filtered = [];
            let title = '';

            const out = STATE.filtered.filter(t => t.direction === 'OUT');

            switch (dimension) {
                case 'workHours':
                    filtered = out.filter(t => t.isWorkHours);
                    title = 'üíº Work Hours Spending';
                    break;
                case 'lateNight':
                    filtered = out.filter(t => t.isLateNight);
                    title = 'üåô Late Night Spending';
                    break;
                case 'nightOut':
                    filtered = out.filter(t => t.dims.pattern === 'Night Out');
                    title = 'üéâ Night Out Sessions';
                    break;
                case 'splurge':
                    filtered = out.filter(t => t.dims.pattern === 'Splurge');
                    title = 'üí∏ Splurge Purchases';
                    break;
                case 'large':
                    filtered = out.filter(t => t.isLarge);
                    title = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ Large Purchases (500+ QAR)';
                    break;
                case 'subscription':
                    filtered = out.filter(t => t.dims.pattern === 'Subscription');
                    title = 'üìÖ Detected Subscriptions';
                    break;
                case 'clear':
                    closeFilteredModal();
                    return;
                default:
                    return;
            }

            showFilteredResults(filtered, title);
        }

        function showFilteredResults(txns, title) {
            const total = txns.reduce((s, t) => s + t.amount, 0);
            const avg = txns.length > 0 ? total / txns.length : 0;

            document.getElementById('filteredTitle').textContent = title;
            document.getElementById('filteredSubtitle').textContent = `${txns.length} transactions`;
            document.getElementById('filteredTotal').textContent = `QAR ${formatNum(total)}`;
            document.getElementById('filteredCount').textContent = txns.length;
            document.getElementById('filteredAvg').textContent = `QAR ${formatNum(avg)}`;

            document.getElementById('filteredList').innerHTML = txns.map(t => renderTxnRowEnhanced(t)).join('');

            document.getElementById('filteredModal').classList.remove('hidden');
        }

        function closeFilteredModal() {
            document.getElementById('filteredModal').classList.add('hidden');
        }

        function renderTxnRowEnhanced(t) {
            const isOut = t.direction === 'OUT';
            const color = getTypeColor(t.merchantType);
            const icon = MERCHANT_TYPES[t.merchantType]?.icon || 'üìã';
            const patternBadge = t.dims.pattern !== 'Normal' ?
                `<span class="text-[10px] px-1.5 py-0.5 rounded-full bg-gray-100 dark:bg-gray-800">${PATTERNS[t.dims.pattern]?.icon || ''} ${t.dims.pattern}</span>` : '';

            return `
                <div class="txn-row p-3 flex items-center justify-between">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm" style="background:${color}20">${icon}</div>
                        <div class="min-w-0">
                            <div class="font-medium text-sm truncate">${t.display}</div>
                            <div class="flex items-center gap-2 text-[10px] text-fact-muted dark:text-fact-dark-muted">
                                <span>${t.date.format('MMM D, HH:mm')}</span>
                                <span>¬∑</span>
                                <span>${t.dims.when.join(', ')}</span>
                                ${patternBadge}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-display font-semibold text-sm ${isOut ? '' : 'text-fact-green'}">${isOut ? '' : '+'}${formatNum(t.amount)}</div>
                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">${t.dims.size}</div>
                    </div>
                </div>
            `;
        }

        // ============== UTILS ==============

        function formatNum(n) {
            return Math.round(n).toLocaleString();
        }

        function debounce(fn, wait) {
            let t;
            return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
        }

        // Simple markdown parser fallback (if marked.js not loaded)
        const marked = window.marked || {
            parse: (text) => text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
        };

        // ============== PWA & SERVICE WORKER ==============

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('[PWA] Service worker registered'))
                    .catch(err => console.log('[PWA] Service worker registration failed:', err));
            });
        }

        // PWA Install handling
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install banner if not dismissed before
            if (!localStorage.getItem('pwa_install_dismissed')) {
                setTimeout(() => {
                    document.getElementById('installBanner').style.display = 'flex';
                }, 3000);
            }
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choice) => {
                    if (choice.outcome === 'accepted') {
                        console.log('[PWA] User accepted install');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBanner').style.display = 'none';
                });
            }
        }

        function dismissInstall() {
            document.getElementById('installBanner').style.display = 'none';
            localStorage.setItem('pwa_install_dismissed', 'true');
        }

        // ============== VOICE INPUT (Web Speech API) ==============

        let recognition = null;
        let isListening = false;

        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');
                    document.getElementById('aiChatInput').value = transcript;
                };

                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('voiceBtn').classList.remove('listening');
                    document.getElementById('voiceStatus').classList.add('hidden');
                    // Auto-submit if we have text
                    const input = document.getElementById('aiChatInput');
                    if (input.value.trim()) {
                        askAIChat();
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Voice recognition error:', event.error);
                    isListening = false;
                    document.getElementById('voiceBtn').classList.remove('listening');
                    document.getElementById('voiceStatus').classList.add('hidden');
                };
            }
        }

        function toggleVoiceInput() {
            if (!recognition) {
                initVoiceRecognition();
            }

            if (!recognition) {
                alert('Voice input is not supported in this browser');
                return;
            }

            if (isListening) {
                recognition.stop();
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
                document.getElementById('voiceStatus').classList.add('hidden');
            } else {
                recognition.start();
                isListening = true;
                document.getElementById('voiceBtn').classList.add('listening');
                document.getElementById('voiceStatus').classList.remove('hidden');
                trackAchievement('fact_used_voice');
                document.getElementById('aiChatInput').value = '';
            }
        }

        // ============== COMMAND PALETTE ==============

        const COMMANDS = [
            { id: 'ai', icon: 'ü§ñ', label: 'Ask AI', shortcut: 'A', action: () => { closeCmdPalette(); openAIQuery(); } },
            { id: 'sync', icon: 'üîÑ', label: 'Sync Data', shortcut: 'R', action: () => { closeCmdPalette(); syncData(); } },
            { id: 'goals', icon: 'üéØ', label: 'Budget Goals', shortcut: 'G', action: () => { closeCmdPalette(); openGoals(); } },
            { id: 'heatmap', icon: 'üìä', label: 'Spending Heatmap', shortcut: 'H', action: () => { closeCmdPalette(); openHeatmap(); } },
            { id: 'export', icon: 'üì•', label: 'Export CSV', shortcut: 'E', action: () => { closeCmdPalette(); exportCSV(); } },
            { id: 'darkmode', icon: 'üåô', label: 'Toggle Dark Mode', shortcut: 'D', action: () => { closeCmdPalette(); toggleDarkMode(); } },
            { id: 'merchants', icon: 'üè™', label: 'All Merchants', shortcut: 'M', action: () => { closeCmdPalette(); openMerchantModal(); } },
            { id: 'txns', icon: 'üìã', label: 'All Transactions', shortcut: 'T', action: () => { closeCmdPalette(); openTxnModal(); } },
            { id: 'uncat', icon: '‚ùì', label: 'Uncategorized', shortcut: 'U', action: () => { closeCmdPalette(); openUncatModal(); } },
            { id: 'settings', icon: '‚öôÔ∏è', label: 'Settings', shortcut: 'S', action: () => { closeCmdPalette(); openSettings(); } },
            { id: 'period-salary', icon: 'üí∞', label: 'Salary Period', action: () => { closeCmdPalette(); setSalaryPeriod(); } },
            { id: 'period-month', icon: 'üìÖ', label: 'This Month', action: () => { closeCmdPalette(); setPeriod('thisMonth'); } },
            { id: 'period-last', icon: 'üìÖ', label: 'Last Month', action: () => { closeCmdPalette(); setPeriod('lastMonth'); } },
            { id: 'voice', icon: 'üé§', label: 'Voice Input', shortcut: 'V', action: () => { closeCmdPalette(); toggleVoiceInput(); } },
            { id: 'achievements', icon: 'üèÜ', label: 'Achievements', shortcut: 'W', action: () => { closeCmdPalette(); openAchievements(); } },
            { id: 'generosity', icon: 'üíú', label: 'Generosity Budget', shortcut: 'Y', action: () => { closeCmdPalette(); openGenerositySettings(); } },
            { id: 'shortcuts', icon: '‚å®Ô∏è', label: 'Keyboard Shortcuts', shortcut: '?', action: () => { closeCmdPalette(); openShortcuts(); } },
            { id: 'logout', icon: 'üö™', label: 'Logout', action: () => { closeCmdPalette(); logout(); } },
        ];

        let cmdSelectedIndex = 0;
        let filteredCommands = [...COMMANDS];

        function openCmdPalette() {
            const palette = document.getElementById('cmdPalette');
            palette.classList.add('active');
            document.getElementById('cmdInput').value = '';
            document.getElementById('cmdInput').focus();
            filteredCommands = [...COMMANDS];
            cmdSelectedIndex = 0;
            renderCommands();
        }

        function closeCmdPalette() {
            document.getElementById('cmdPalette').classList.remove('active');
        }

        function filterCommands(query) {
            const q = query.toLowerCase();
            filteredCommands = COMMANDS.filter(cmd =>
                cmd.label.toLowerCase().includes(q) || cmd.id.includes(q)
            );
            cmdSelectedIndex = 0;
            renderCommands();
        }

        function renderCommands() {
            const list = document.getElementById('cmdList');
            list.innerHTML = filteredCommands.map((cmd, i) => `
                <div class="cmd-item ${i === cmdSelectedIndex ? 'selected' : ''}" onclick="${cmd.action.name ? cmd.action.name + '()' : ''}" data-index="${i}">
                    <div class="cmd-item-icon">${cmd.icon}</div>
                    <div class="flex-1">
                        <div class="text-sm font-medium">${cmd.label}</div>
                    </div>
                    ${cmd.shortcut ? `<div class="cmd-item-shortcut">${cmd.shortcut}</div>` : ''}
                </div>
            `).join('');

            // Add click handlers
            list.querySelectorAll('.cmd-item').forEach((item, i) => {
                item.onclick = () => filteredCommands[i].action();
            });
        }

        function handleCmdKeydown(event) {
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                cmdSelectedIndex = Math.min(cmdSelectedIndex + 1, filteredCommands.length - 1);
                renderCommands();
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                cmdSelectedIndex = Math.max(cmdSelectedIndex - 1, 0);
                renderCommands();
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (filteredCommands[cmdSelectedIndex]) {
                    filteredCommands[cmdSelectedIndex].action();
                }
            } else if (event.key === 'Escape') {
                closeCmdPalette();
            }
        }

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Cmd/Ctrl + K - Open command palette
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                openCmdPalette();
            }
            // Escape - Close modals
            if (e.key === 'Escape') {
                closeCmdPalette();
            }
        });

        // ============== GOALS SYSTEM ==============

        function getGoals() {
            try {
                return JSON.parse(localStorage.getItem(`fact_goals_${STATE.currentUser}`)) || [];
            } catch (e) {
                return [];
            }
        }

        function saveGoals(goals) {
            localStorage.setItem(`fact_goals_${STATE.currentUser}`, JSON.stringify(goals));
        }

        function openGoals() {
            renderGoalsList();
            document.getElementById('goalsModal').classList.remove('hidden');
        }

        function closeGoals() {
            document.getElementById('goalsModal').classList.add('hidden');
        }

        function renderGoalsList() {
            const goals = getGoals();
            const container = document.getElementById('goalsList');

            if (goals.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-3xl mb-2">üéØ</div>
                        <p class="text-sm text-fact-muted dark:text-fact-dark-muted">No budget goals set yet</p>
                        <p class="text-xs text-fact-muted dark:text-fact-dark-muted mt-1">Set spending limits to track your progress</p>
                    </div>
                `;
                return;
            }

            // Calculate spending for current month
            const now = dayjs();
            const monthStart = now.startOf('month');
            const monthTxns = STATE.allTxns.filter(t =>
                t.direction === 'OUT' &&
                t.date.isAfter(monthStart) &&
                t.date.isBefore(now.add(1, 'day'))
            );

            const spendByCategory = {};
            monthTxns.forEach(t => {
                spendByCategory[t.merchantType] = (spendByCategory[t.merchantType] || 0) + t.amount;
            });

            // Calculate days progress
            const daysInMonth = now.daysInMonth();
            const daysPassed = now.date();
            const dayProgress = (daysPassed / daysInMonth) * 100;

            container.innerHTML = goals.map((goal, i) => {
                const spent = spendByCategory[goal.category] || 0;
                const pct = Math.min(100, (spent / goal.amount) * 100);
                const remaining = Math.max(0, goal.amount - spent);
                const color = pct > 100 ? '#E57373' : pct > 80 ? '#F4C44E' : '#75B876';
                const typeInfo = MERCHANT_TYPES[goal.category] || {};

                return `
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${typeInfo.icon || 'üìã'}</span>
                                <span class="font-medium text-sm">${goal.category}</span>
                            </div>
                            <button onclick="deleteGoal(${i})" class="text-fact-muted hover:text-fact-red text-xs">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-baseline justify-between mb-2">
                            <div class="font-display">
                                <span class="text-xl font-bold">${formatNum(spent)}</span>
                                <span class="text-sm text-fact-muted dark:text-fact-dark-muted">/ ${formatNum(goal.amount)}</span>
                            </div>
                            <span class="text-xs ${pct > 100 ? 'text-fact-red' : 'text-fact-green'}">${formatNum(remaining)} left</span>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-bar" style="width: ${pct}%; background: ${color}"></div>
                            <div class="goal-progress-marker" style="left: ${dayProgress}%" title="Expected pace"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-[10px] text-fact-muted dark:text-fact-dark-muted">
                            <span>${pct.toFixed(0)}% used</span>
                            <span>${pct > dayProgress ? '‚ö†Ô∏è Ahead of pace' : '‚úì On track'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addNewGoal() {
            // Populate category dropdown
            const categories = Object.keys(MERCHANT_TYPES).filter(c => c !== 'Uncategorized');
            document.getElementById('goalCategory').innerHTML = categories.map(c =>
                `<option value="${c}">${MERCHANT_TYPES[c]?.icon || ''} ${c}</option>`
            ).join('');
            document.getElementById('goalAmount').value = '';
            document.getElementById('addGoalModal').classList.remove('hidden');
        }

        function closeAddGoal() {
            document.getElementById('addGoalModal').classList.add('hidden');
        }

        function saveGoal() {
            const category = document.getElementById('goalCategory').value;
            const amount = parseFloat(document.getElementById('goalAmount').value);

            if (!category || !amount || amount <= 0) {
                alert('Please select a category and enter a valid amount');
                return;
            }

            const goals = getGoals();
            // Update existing or add new
            const existing = goals.findIndex(g => g.category === category);
            if (existing >= 0) {
                goals[existing].amount = amount;
            } else {
                goals.push({ category, amount });
            }
            saveGoals(goals);

            closeAddGoal();
            renderGoalsList();
        }

        async function deleteGoal(index) {
            const goals = getGoals();
            const goal = goals[index];

            const confirmed = await showConfirm({
                title: 'Delete Budget Goal',
                message: `Remove the ${goal.category} budget of QAR ${formatNum(goal.amount)}?`,
                confirmText: 'Delete',
                cancelText: 'Keep',
                type: 'danger'
            });

            if (confirmed) {
                goals.splice(index, 1);
                saveGoals(goals);
                renderGoalsList();
                showToast(`Removed ${goal.category} goal`, 'info');
            }
        }

        // ============== TIMELINE HEATMAP ==============

        function openHeatmap() {
            renderHeatmap();
            document.getElementById('heatmapModal').classList.remove('hidden');
            trackAchievement('fact_viewed_heatmap');
        }

        function closeHeatmap() {
            document.getElementById('heatmapModal').classList.add('hidden');
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmapContainer');
            const out = STATE.allTxns.filter(t => t.direction === 'OUT');

            // Get last 90 days of data
            const endDate = dayjs();
            const startDate = endDate.subtract(90, 'day');

            // Calculate daily spending
            const dailySpend = {};
            out.forEach(t => {
                if (t.date.isAfter(startDate) && t.date.isBefore(endDate.add(1, 'day'))) {
                    const key = t.date.format('YYYY-MM-DD');
                    dailySpend[key] = (dailySpend[key] || 0) + t.amount;
                }
            });

            // Calculate max for color scaling
            const amounts = Object.values(dailySpend);
            const maxSpend = Math.max(...amounts, 1);
            const avgSpend = amounts.length > 0 ? amounts.reduce((a, b) => a + b, 0) / amounts.length : 0;

            // Build grid (7 rows for days of week, columns for weeks)
            const weeks = [];
            let currentWeek = [];
            let d = startDate;

            // Fill in empty days at start
            const startDow = d.day();
            for (let i = 0; i < startDow; i++) {
                currentWeek.push(null);
            }

            while (d.isBefore(endDate) || d.isSame(endDate, 'day')) {
                const key = d.format('YYYY-MM-DD');
                const amount = dailySpend[key] || 0;
                currentWeek.push({ date: d, amount, key });

                if (d.day() === 6) { // Saturday
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                d = d.add(1, 'day');
            }
            if (currentWeek.length > 0) {
                weeks.push(currentWeek);
            }

            // Color scale (GitHub-style greens, but using FACT colors)
            const getColor = (amount) => {
                if (amount === 0) return '#E5E5E5';
                const ratio = amount / maxSpend;
                if (ratio < 0.25) return '#C6E48B';
                if (ratio < 0.5) return '#7BC96F';
                if (ratio < 0.75) return '#239A3B';
                return '#196127';
            };

            // Render
            const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            container.innerHTML = `
                <div class="flex gap-1">
                    <div class="flex flex-col gap-1 text-[9px] text-fact-muted dark:text-fact-dark-muted mr-1">
                        ${dayLabels.map((l, i) => `<div class="h-3 flex items-center">${i % 2 === 1 ? l : ''}</div>`).join('')}
                    </div>
                    ${weeks.map((week, wi) => `
                        <div class="flex flex-col gap-1">
                            ${[0,1,2,3,4,5,6].map(dow => {
                                const cell = week[dow];
                                if (!cell) return '<div class="heatmap-cell" style="background: transparent"></div>';
                                const color = getColor(cell.amount);
                                const tooltip = `${cell.date.format('MMM D')}: QAR ${formatNum(cell.amount)}`;
                                return `<div class="heatmap-cell" style="background: ${color}" title="${tooltip}" onclick="drilldownDate('${cell.key}')"></div>`;
                            }).join('')}
                        </div>
                    `).join('')}
                </div>
                <div class="mt-4 grid grid-cols-3 gap-4 text-center text-xs">
                    <div>
                        <div class="text-lg font-display font-bold">${formatNum(amounts.reduce((a, b) => a + b, 0))}</div>
                        <div class="text-fact-muted dark:text-fact-dark-muted">Total (90 days)</div>
                    </div>
                    <div>
                        <div class="text-lg font-display font-bold">${formatNum(avgSpend)}</div>
                        <div class="text-fact-muted dark:text-fact-dark-muted">Daily Avg</div>
                    </div>
                    <div>
                        <div class="text-lg font-display font-bold">${formatNum(maxSpend)}</div>
                        <div class="text-fact-muted dark:text-fact-dark-muted">Max Day</div>
                    </div>
                </div>
            `;
        }

        function drilldownDate(dateKey) {
            const date = dayjs(dateKey);
            const txns = STATE.allTxns.filter(t =>
                t.direction === 'OUT' &&
                t.date.format('YYYY-MM-DD') === dateKey
            );
            showFilteredResults(txns, `üìÖ ${date.format('MMM D, YYYY')}`);
            closeHeatmap();
        }

        // ============== TOUCH GESTURES ==============

        function initSwipeGestures() {
            let touchStartX = 0;
            let touchStartY = 0;
            let currentTarget = null;

            document.addEventListener('touchstart', (e) => {
                if (e.target.closest('.txn-row')) {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    currentTarget = e.target.closest('.txn-row');
                }
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (!currentTarget) return;
                const deltaX = e.touches[0].clientX - touchStartX;
                const deltaY = e.touches[0].clientY - touchStartY;

                // Only handle horizontal swipes
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 30) {
                    currentTarget.style.transform = `translateX(${Math.max(-100, Math.min(0, deltaX))}px)`;
                }
            }, { passive: true });

            document.addEventListener('touchend', (e) => {
                if (!currentTarget) return;
                const deltaX = e.changedTouches[0].clientX - touchStartX;

                if (deltaX < -60) {
                    // Swipe left - quick categorize
                    const rawData = currentTarget.dataset.raw;
                    if (rawData) {
                        currentTarget.style.transform = '';
                        const raw = decodeURIComponent(escape(atob(rawData)));
                        openCatModal(raw);
                    }
                } else {
                    currentTarget.style.transform = '';
                }
                currentTarget = null;
            }, { passive: true });
        }

        // Initialize touch gestures on mobile
        if ('ontouchstart' in window) {
            initSwipeGestures();
        }

        // ============== DARK MODE TOGGLE ==============

        function initDarkMode() {
            const saved = localStorage.getItem('fact_dark_mode');
            const toggle = document.getElementById('themeToggle');

            if (saved === 'true') {
                document.body.classList.add('dark-mode');
                toggle.classList.add('dark');
            } else if (saved === 'false') {
                document.body.classList.remove('dark-mode');
                toggle.classList.remove('dark');
            } else {
                // Auto from system
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    toggle.classList.add('dark');
                }
            }
        }

        function toggleDarkMode() {
            const body = document.body;
            const toggle = document.getElementById('themeToggle');

            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                toggle.classList.remove('dark');
                localStorage.setItem('fact_dark_mode', 'false');
            } else {
                body.classList.add('dark-mode');
                toggle.classList.add('dark');
                localStorage.setItem('fact_dark_mode', 'true');
            }
        }

        // ============== CSV EXPORT ==============

        function exportCSV() {
            const icon = document.getElementById('exportIcon');
            icon.classList.add('export-spin');

            try {
                // Prepare data
                const headers = ['Date', 'Time', 'Amount', 'Currency', 'Merchant', 'Category', 'Direction', 'Pattern'];
                const rows = STATE.filtered.map(t => [
                    t.date.format('YYYY-MM-DD'),
                    t.date.format('HH:mm'),
                    t.amount.toFixed(2),
                    t.currency,
                    `"${t.display.replace(/"/g, '""')}"`,
                    t.merchantType,
                    t.direction,
                    t.dims.pattern
                ]);

                const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');

                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `fact-flow-${STATE.dateRange.start.format('YYYY-MM-DD')}-to-${STATE.dateRange.end.format('YYYY-MM-DD')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showToast(`Exported ${rows.length} transactions`, 'success');
                trackAchievement('fact_exported');
            } catch (err) {
                showToast('Export failed: ' + err.message, 'error');
            } finally {
                setTimeout(() => icon.classList.remove('export-spin'), 500);
            }
        }

        // ============== SPENDING FORECAST ==============

        function calculateForecast() {
            const proj = calculateBudgetProjection();
            const out = STATE.filtered.filter(t => t.direction === 'OUT');

            // Calculate daily spending trend
            const periodDays = STATE.dateRange.end.diff(STATE.dateRange.start, 'day') + 1;
            const daysPassed = Math.min(periodDays, dayjs().diff(STATE.dateRange.start, 'day') + 1);
            const avgDaily = daysPassed > 0 ? proj.expenses / daysPassed : 0;

            // Project to end of period
            const projectedTotal = avgDaily * periodDays;
            const daysRemaining = Math.max(0, periodDays - daysPassed);
            const projectedRemaining = avgDaily * daysRemaining;

            return {
                currentSpend: proj.expenses,
                projectedTotal,
                projectedRemaining,
                avgDaily,
                daysRemaining,
                pace: proj.onTrack ? 'on-track' : 'over-budget'
            };
        }

        // ============== TOAST NOTIFICATIONS ==============

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '‚úì',
                error: '‚úï',
                info: '‚Ñπ'
            };

            toast.innerHTML = `
                <span>${icons[type] || icons.info}</span>
                <span>${escapeHtml(message)}</span>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ============== KEYBOARD SHORTCUTS HELP ==============

        function openShortcuts() {
            document.getElementById('shortcutsModal').classList.remove('hidden');
        }

        function closeShortcuts() {
            document.getElementById('shortcutsModal').classList.add('hidden');
        }

        // Add ? key to open shortcuts help
        document.addEventListener('keydown', (e) => {
            if (e.key === '?' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                openShortcuts();
            }
        });

        // ============== ACHIEVEMENTS SYSTEM ==============

        const ACHIEVEMENTS = {
            'first-login': { icon: 'üöÄ', name: 'First Steps', desc: 'Opened FACT/Flow for the first time', check: () => true },
            'first-categorize': { icon: 'üè∑Ô∏è', name: 'Organizer', desc: 'Categorized your first transaction', check: () => Object.keys(STATE.localMappings || {}).length > 0 },
            'ten-categorize': { icon: 'üìã', name: 'Sorting Pro', desc: 'Categorized 10 transactions', check: () => Object.keys(STATE.localMappings || {}).length >= 10 },
            'first-goal': { icon: 'üéØ', name: 'Goal Setter', desc: 'Set your first budget goal', check: () => getGoals().length > 0 },
            'three-goals': { icon: 'üé™', name: 'Triple Threat', desc: 'Set 3 budget goals', check: () => getGoals().length >= 3 },
            'streak-3': { icon: 'üî•', name: 'On Fire', desc: '3-day under-budget streak', check: () => getStreakData().longestStreak >= 3 },
            'streak-7': { icon: '‚ö°', name: 'Week Warrior', desc: '7-day under-budget streak', check: () => getStreakData().longestStreak >= 7 },
            'streak-30': { icon: 'üíé', name: 'Diamond Discipline', desc: '30-day under-budget streak', check: () => getStreakData().longestStreak >= 30 },
            'ask-ai': { icon: 'ü§ñ', name: 'AI Explorer', desc: 'Asked AI for spending advice', check: () => localStorage.getItem('fact_asked_ai') === 'true' },
            'voice-input': { icon: 'üé§', name: 'Voice Commander', desc: 'Used voice input', check: () => localStorage.getItem('fact_used_voice') === 'true' },
            'dark-mode': { icon: 'üåô', name: 'Night Owl', desc: 'Switched to dark mode', check: () => localStorage.getItem('fact_dark_mode') === 'true' },
            'export-data': { icon: 'üìä', name: 'Data Analyst', desc: 'Exported your data to CSV', check: () => localStorage.getItem('fact_exported') === 'true' },
            'under-budget-day': { icon: '‚úÖ', name: 'Budget Boss', desc: 'Stayed under daily budget', check: () => checkDailyBudget().status === 'safe' },
            'heatmap-view': { icon: 'üóìÔ∏è', name: 'Pattern Seeker', desc: 'Viewed the spending heatmap', check: () => localStorage.getItem('fact_viewed_heatmap') === 'true' },
            'generosity-set': { icon: 'üíú', name: 'Generous Heart', desc: 'Set a generosity budget', check: () => localStorage.getItem(`fact_generosity_${STATE.currentUser}`) !== null }
        };

        function getUnlockedAchievements() {
            try {
                return JSON.parse(localStorage.getItem(`fact_achievements_${STATE.currentUser}`)) || [];
            } catch (e) {
                return [];
            }
        }

        function saveUnlockedAchievements(achievements) {
            localStorage.setItem(`fact_achievements_${STATE.currentUser}`, JSON.stringify(achievements));
        }

        function checkAchievements() {
            const unlocked = getUnlockedAchievements();
            const newUnlocks = [];

            Object.entries(ACHIEVEMENTS).forEach(([id, achievement]) => {
                if (!unlocked.includes(id) && achievement.check()) {
                    unlocked.push(id);
                    newUnlocks.push({ id, ...achievement });
                }
            });

            if (newUnlocks.length > 0) {
                saveUnlockedAchievements(unlocked);
                // Celebrate the first new unlock
                setTimeout(() => celebrate(newUnlocks[0]), 500);
            }

            return unlocked;
        }

        function celebrate(achievement) {
            const overlay = document.getElementById('celebrationOverlay');

            // Generate confetti
            const confettiColors = ['#F4C44E', '#75B876', '#B593C6', '#E57373', '#64B5F6'];
            let confettiHtml = '';
            for (let i = 0; i < 50; i++) {
                const color = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                const left = Math.random() * 100;
                const delay = Math.random() * 2;
                const size = 5 + Math.random() * 10;
                confettiHtml += `<div class="confetti" style="left: ${left}%; background: ${color}; width: ${size}px; height: ${size}px; animation-delay: ${delay}s; border-radius: ${Math.random() > 0.5 ? '50%' : '0'}"></div>`;
            }

            overlay.innerHTML = `
                <div class="celebration-overlay" onclick="closeCelebration()">
                    ${confettiHtml}
                    <div class="celebration-box" onclick="event.stopPropagation()">
                        <div class="celebration-icon">${achievement.icon}</div>
                        <h2 class="font-display font-bold text-xl text-fact-ink mt-2">Achievement Unlocked!</h2>
                        <h3 class="font-display font-semibold text-lg text-fact-ink mt-1">${achievement.name}</h3>
                        <p class="text-sm text-fact-ink/70 mt-2">${achievement.desc}</p>
                        <button onclick="closeCelebration()" class="mt-4 px-6 py-2 bg-fact-ink text-white rounded-full font-medium">
                            Awesome! üéâ
                        </button>
                    </div>
                </div>
            `;
            overlay.classList.remove('hidden');

            // Auto close after 5 seconds
            setTimeout(closeCelebration, 5000);
        }

        function closeCelebration() {
            const overlay = document.getElementById('celebrationOverlay');
            overlay.classList.add('hidden');
            overlay.innerHTML = '';
        }

        function openAchievements() {
            const unlocked = getUnlockedAchievements();
            const container = document.getElementById('achievementsList');

            document.getElementById('achievementProgress').textContent =
                `${unlocked.length} of ${Object.keys(ACHIEVEMENTS).length} unlocked`;

            container.innerHTML = Object.entries(ACHIEVEMENTS).map(([id, a]) => {
                const isUnlocked = unlocked.includes(id);
                return `
                    <div class="achievement-badge ${isUnlocked ? '' : 'locked'}">
                        <div class="badge-icon">${a.icon}</div>
                        <div class="text-xs font-medium">${a.name}</div>
                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mt-1">${isUnlocked ? a.desc : '???'}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('achievementsModal').classList.remove('hidden');
        }

        function closeAchievements() {
            document.getElementById('achievementsModal').classList.add('hidden');
        }

        // Track specific actions for achievements
        function trackAchievement(key) {
            localStorage.setItem(key, 'true');
            setTimeout(checkAchievements, 100);
        }

        // ============== CONFIRMATION DIALOG ==============

        function showConfirm(options) {
            return new Promise((resolve) => {
                const { title, message, confirmText = 'Confirm', cancelText = 'Cancel', type = 'warning' } = options;
                const modal = document.getElementById('confirmModal');

                const colors = {
                    warning: { bg: 'bg-fact-yellow', icon: '‚ö†Ô∏è' },
                    danger: { bg: 'bg-fact-red', icon: 'üóëÔ∏è' },
                    info: { bg: 'bg-fact-purple', icon: '‚ÑπÔ∏è' }
                };
                const color = colors[type] || colors.warning;

                modal.innerHTML = `
                    <div class="confirm-overlay" onclick="event.target === this && confirmResolve(false)">
                        <div class="confirm-box">
                            <div class="text-4xl mb-4">${color.icon}</div>
                            <h3 class="font-display font-semibold text-lg mb-2">${escapeHtml(title)}</h3>
                            <p class="text-sm text-fact-muted dark:text-fact-dark-muted mb-6">${escapeHtml(message)}</p>
                            <div class="flex gap-3">
                                <button onclick="confirmResolve(false)" class="flex-1 px-4 py-2 text-sm rounded-lg border border-fact-border dark:border-fact-dark-border hover:bg-gray-50 dark:hover:bg-gray-800">${cancelText}</button>
                                <button onclick="confirmResolve(true)" class="flex-1 px-4 py-2 text-sm rounded-lg ${color.bg} text-white font-medium">${confirmText}</button>
                            </div>
                        </div>
                    </div>
                `;
                modal.classList.remove('hidden');

                window.confirmResolve = (result) => {
                    modal.classList.add('hidden');
                    modal.innerHTML = '';
                    resolve(result);
                };
            });
        }

        // ============== IMPULSE CONTROL ==============

        // Detect impulse burst (multiple transactions in short time)
        function detectImpulseBurst(transactions) {
            const bursts = [];
            const sorted = [...transactions].sort((a, b) => a.date.unix() - b.date.unix());

            for (let i = 0; i < sorted.length; i++) {
                const windowStart = sorted[i].date;
                const windowTxns = [sorted[i]];

                for (let j = i + 1; j < sorted.length; j++) {
                    const diff = sorted[j].date.diff(windowStart, 'minute');
                    if (diff <= 30) { // 30 minute window
                        windowTxns.push(sorted[j]);
                    } else {
                        break;
                    }
                }

                if (windowTxns.length >= 3) {
                    bursts.push({
                        time: windowStart,
                        count: windowTxns.length,
                        total: windowTxns.reduce((s, t) => s + t.amount, 0),
                        transactions: windowTxns
                    });
                    i += windowTxns.length - 1; // Skip processed transactions
                }
            }

            return bursts;
        }

        // Check if user is over daily budget
        function checkDailyBudget() {
            const today = dayjs().startOf('day');
            const todayTxns = STATE.allTxns.filter(t =>
                t.direction === 'OUT' &&
                t.date.isAfter(today) &&
                t.date.isBefore(today.add(1, 'day'))
            );
            const todaySpent = todayTxns.reduce((s, t) => s + t.amount, 0);

            const proj = calculateBudgetProjection();
            const dailyBudget = proj.recommended || 300; // Default 300 QAR

            const percentage = (todaySpent / dailyBudget) * 100;

            return {
                spent: todaySpent,
                budget: dailyBudget,
                remaining: Math.max(0, dailyBudget - todaySpent),
                percentage,
                status: percentage < 50 ? 'safe' : percentage < 80 ? 'warning' : 'danger'
            };
        }

        // Show pause modal for large purchases
        function showPauseModal(amount, merchant, callback) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                let countdown = 5;

                modal.innerHTML = `
                    <div class="confirm-overlay">
                        <div class="confirm-box pause-modal">
                            <div class="text-4xl mb-2">‚è∏Ô∏è</div>
                            <h3 class="font-display font-semibold text-lg mb-2">Large Purchase</h3>
                            <p class="text-sm text-fact-muted dark:text-fact-dark-muted">
                                ${escapeHtml(merchant)}: <strong>QAR ${formatNum(amount)}</strong>
                            </p>
                            <div class="pause-countdown" id="pauseCountdown">${countdown}</div>
                            <p class="text-xs text-fact-muted dark:text-fact-dark-muted mb-4">
                                Take a breath. Do you really need this?
                            </p>
                            <div class="flex gap-3">
                                <button onclick="pauseResolve(false)" class="flex-1 px-4 py-2 text-sm rounded-lg bg-fact-green text-white font-medium">Skip (I needed it)</button>
                                <button id="pauseConfirmBtn" disabled class="flex-1 px-4 py-2 text-sm rounded-lg bg-gray-200 dark:bg-gray-700 text-fact-muted font-medium">Wait ${countdown}s</button>
                            </div>
                        </div>
                    </div>
                `;
                modal.classList.remove('hidden');

                const interval = setInterval(() => {
                    countdown--;
                    const countEl = document.getElementById('pauseCountdown');
                    const btnEl = document.getElementById('pauseConfirmBtn');
                    if (countEl) countEl.textContent = countdown;

                    if (countdown <= 0) {
                        clearInterval(interval);
                        if (btnEl) {
                            btnEl.disabled = false;
                            btnEl.className = 'flex-1 px-4 py-2 text-sm rounded-lg bg-fact-yellow text-fact-ink font-medium';
                            btnEl.textContent = 'Categorize anyway';
                            btnEl.onclick = () => pauseResolve(true);
                        }
                    } else if (btnEl) {
                        btnEl.textContent = `Wait ${countdown}s`;
                    }
                }, 1000);

                window.pauseResolve = (result) => {
                    clearInterval(interval);
                    modal.classList.add('hidden');
                    modal.innerHTML = '';
                    resolve(result);
                };
            });
        }

        // Check for large purchase before categorizing
        async function checkLargePurchase(amount, merchant) {
            const LARGE_THRESHOLD = 500; // QAR
            if (amount >= LARGE_THRESHOLD) {
                const proceed = await showPauseModal(amount, merchant);
                return proceed;
            }
            return true;
        }

        // Track and warn about daily budget
        function updateDailyBudgetMeter() {
            const status = checkDailyBudget();
            const meterEl = document.getElementById('dailyBudgetMeter');
            if (!meterEl) return;

            const fillEl = meterEl.querySelector('.budget-meter-fill');
            if (fillEl) {
                fillEl.style.width = `${Math.min(100, status.percentage)}%`;
                fillEl.className = `budget-meter-fill ${status.status}`;
            }

            const labelEl = document.getElementById('dailyBudgetLabel');
            if (labelEl) {
                labelEl.textContent = `${formatNum(status.remaining)} left today`;
                labelEl.className = status.status === 'danger' ? 'text-fact-red' : 'text-fact-muted dark:text-fact-dark-muted';
            }

            // Show warning toast if over 80%
            if (status.percentage >= 80 && status.percentage < 100 && !STATE.dailyWarningShown) {
                showToast(`‚ö†Ô∏è You've used ${status.percentage.toFixed(0)}% of today's budget`, 'info');
                STATE.dailyWarningShown = true;
            } else if (status.percentage >= 100 && !STATE.dailyOverShown) {
                showToast(`üö® Over budget today! Spent ${formatNum(status.spent)} of ${formatNum(status.budget)}`, 'error');
                STATE.dailyOverShown = true;
            }
        }

        // ============== STREAK TRACKING ==============

        function getStreakData() {
            try {
                return JSON.parse(localStorage.getItem(`fact_streak_${STATE.currentUser}`)) || {
                    currentStreak: 0,
                    longestStreak: 0,
                    lastGoodDay: null
                };
            } catch (e) {
                return { currentStreak: 0, longestStreak: 0, lastGoodDay: null };
            }
        }

        function saveStreakData(data) {
            localStorage.setItem(`fact_streak_${STATE.currentUser}`, JSON.stringify(data));
        }

        function updateStreak() {
            const status = checkDailyBudget();
            const streak = getStreakData();
            const today = dayjs().format('YYYY-MM-DD');
            const yesterday = dayjs().subtract(1, 'day').format('YYYY-MM-DD');

            // Only update at end of day or when checking previous days
            if (status.status !== 'danger') {
                if (streak.lastGoodDay === yesterday) {
                    streak.currentStreak++;
                } else if (streak.lastGoodDay !== today) {
                    streak.currentStreak = 1;
                }
                streak.lastGoodDay = today;
                streak.longestStreak = Math.max(streak.longestStreak, streak.currentStreak);
            } else if (streak.lastGoodDay !== today && streak.lastGoodDay !== yesterday) {
                streak.currentStreak = 0;
            }

            saveStreakData(streak);
            return streak;
        }

        function renderStreakBadge() {
            const streak = getStreakData();
            const container = document.getElementById('streakContainer');
            if (!container) return;

            if (streak.currentStreak > 0) {
                container.innerHTML = `
                    <div class="streak-badge">
                        <span>üî•</span>
                        <span>${streak.currentStreak} day${streak.currentStreak > 1 ? 's' : ''}</span>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="text-xs text-fact-muted dark:text-fact-dark-muted">
                        Stay under budget to start a streak!
                    </div>
                `;
            }
        }

        // ============== GENEROSITY BUDGET SYSTEM ==============

        // Categories that count as "generosity" - user can customize
        const DEFAULT_GENEROSITY_CATEGORIES = [
            { id: 'gifts', name: 'Gifts & Presents', default: true },
            { id: 'charity', name: 'Charity & Donations', default: true },
            { id: 'treats', name: 'Treating Others (meals, drinks)', default: true },
            { id: 'social', name: 'Social Outings (I paid for everyone)', default: false },
            { id: 'family', name: 'Family Support', default: false },
            { id: 'loans', name: 'Loans to Friends', default: false }
        ];

        function getGenerositySettings() {
            try {
                const stored = localStorage.getItem(`fact_generosity_${STATE.currentUser}`);
                if (stored) {
                    return JSON.parse(stored);
                }
            } catch (e) {}
            return null;
        }

        function saveGenerositySettings() {
            const budgetInput = document.getElementById('generosityBudgetInput');
            const budget = parseFloat(budgetInput.value) || 0;

            // Get selected categories
            const selectedCategories = [];
            document.querySelectorAll('#generosityCategories input[type="checkbox"]:checked').forEach(cb => {
                selectedCategories.push(cb.value);
            });

            const settings = {
                budget: budget,
                categories: selectedCategories,
                enabled: budget > 0
            };

            localStorage.setItem(`fact_generosity_${STATE.currentUser}`, JSON.stringify(settings));

            // Trigger achievement check
            if (typeof checkAchievements === 'function') {
                setTimeout(() => checkAchievements(), 500);
            }

            closeGenerositySettings();
            renderGenerosityBudget();
            showToast('Generosity budget saved! üíú', 'success');
        }

        function openGenerositySettings() {
            const settings = getGenerositySettings() || { budget: 0, categories: ['gifts', 'charity', 'treats'], enabled: false };

            // Set budget input
            document.getElementById('generosityBudgetInput').value = settings.budget || '';

            // Render category checkboxes
            const container = document.getElementById('generosityCategories');
            container.innerHTML = DEFAULT_GENEROSITY_CATEGORIES.map(cat => {
                const checked = settings.categories?.includes(cat.id) || (!settings.categories && cat.default);
                return `
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" value="${cat.id}" ${checked ? 'checked' : ''}
                            class="w-4 h-4 rounded border-fact-border text-fact-purple focus:ring-fact-purple">
                        <span>${cat.name}</span>
                    </label>
                `;
            }).join('');

            document.getElementById('generosityModal').classList.remove('hidden');
        }

        function closeGenerositySettings() {
            document.getElementById('generosityModal').classList.add('hidden');
        }

        function calcGenerositySpending() {
            const settings = getGenerositySettings();
            if (!settings || !settings.enabled) return { spent: 0, budget: 0, transactions: [] };

            // Get current month's transactions
            const now = dayjs();
            const monthStart = now.startOf('month');
            const monthEnd = now.endOf('month');

            // Keywords that indicate generosity based on selected categories
            const categoryKeywords = {
                'gifts': ['gift', 'present', 'birthday', 'anniversary', 'wedding'],
                'charity': ['charity', 'donation', 'donate', 'zakat', 'sadaqah', 'ngo', 'red cross', 'unicef'],
                'treats': ['coffee', 'starbucks', 'costa', 'restaurant', 'cafe', 'dinner', 'lunch'],
                'social': ['night out', 'club', 'bar', 'pub', 'party'],
                'family': ['transfer', 'family', 'mom', 'dad', 'sister', 'brother', 'parent'],
                'loans': ['loan', 'lend', 'borrow']
            };

            // Build keywords list based on selected categories
            let keywords = [];
            settings.categories.forEach(catId => {
                if (categoryKeywords[catId]) {
                    keywords = keywords.concat(categoryKeywords[catId]);
                }
            });

            // Also check for "Gifts" or "Social" category assignments
            const generosityCategories = ['Gifts', 'Charity', 'Social'];

            const generosityTxns = STATE.txns.filter(txn => {
                const txnDate = dayjs(txn.date);
                if (!txnDate.isBetween(monthStart, monthEnd, 'day', '[]')) return false;

                // Check if category matches
                if (generosityCategories.some(c => txn.category?.toLowerCase().includes(c.toLowerCase()))) {
                    return true;
                }

                // Check if description contains generosity keywords
                const desc = (txn.description || '').toLowerCase();
                const merchant = (txn.merchant || '').toLowerCase();
                return keywords.some(kw => desc.includes(kw) || merchant.includes(kw));
            });

            const spent = generosityTxns.reduce((sum, txn) => sum + Math.abs(txn.qar), 0);

            return {
                spent: spent,
                budget: settings.budget,
                transactions: generosityTxns.slice(0, 5), // Last 5 for display
                percentage: settings.budget > 0 ? Math.min((spent / settings.budget) * 100, 100) : 0,
                remaining: Math.max(settings.budget - spent, 0),
                over: spent > settings.budget
            };
        }

        function renderGenerosityBudget() {
            const settings = getGenerositySettings();
            const card = document.getElementById('generosityCard');

            if (!settings || !settings.enabled) {
                card.classList.add('hidden');
                return;
            }

            card.classList.remove('hidden');

            const data = calcGenerositySpending();

            // Update spent amount
            document.getElementById('generositySpent').textContent = `QAR ${Math.round(data.spent).toLocaleString()}`;

            // Update budget display
            document.getElementById('generosityBudget').textContent = `QAR ${Math.round(data.budget).toLocaleString()}`;

            // Update meter
            const fill = document.getElementById('generosityMeterFill');
            fill.style.width = `${data.percentage}%`;
            fill.className = `generosity-meter-fill ${data.over ? 'over' : ''}`;

            // Update status message
            const status = document.getElementById('generosityStatus');
            if (data.over) {
                status.textContent = `Over budget by QAR ${Math.round(data.spent - data.budget).toLocaleString()}`;
                status.className = 'text-xs text-fact-red';
            } else if (data.percentage >= 80) {
                status.textContent = `QAR ${Math.round(data.remaining).toLocaleString()} left to give`;
                status.className = 'text-xs text-fact-yellow';
            } else {
                status.textContent = `QAR ${Math.round(data.remaining).toLocaleString()} left to give üíú`;
                status.className = 'text-xs text-fact-muted dark:text-fact-dark-muted';
            }

            // Render recent generosity transactions
            const recentDiv = document.getElementById('recentGenerosity');
            if (data.transactions.length === 0) {
                recentDiv.innerHTML = '<div class="text-xs text-fact-muted dark:text-fact-dark-muted italic">No giving this month yet</div>';
            } else {
                recentDiv.innerHTML = data.transactions.map(txn => `
                    <div class="flex items-center justify-between text-xs">
                        <span class="truncate flex-1">${escapeHtml(txn.merchant || txn.description)}</span>
                        <span class="text-fact-purple font-medium ml-2">QAR ${Math.abs(txn.qar).toFixed(0)}</span>
                    </div>
                `).join('');
            }
        }

        // Add generosity budget to command palette
        function addGenerosityToCommandPalette() {
            const cmdInput = document.getElementById('cmdInput');
            if (!cmdInput) return;

            // The command palette already listens for input
            // We'll add generosity as a command in the existing handler
        }

        // ============== INIT ENHANCEMENTS ==============

        // Initialize all enhancements on load
        document.addEventListener('DOMContentLoaded', () => {
            initVoiceRecognition();
            initDarkMode();
        });
    </script>
</body>
</html>
