<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F4C44E" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1A1A1A" media="(prefers-color-scheme: dark)">
    <meta name="description" content="FACT/Flow - Personal Finance Intelligence">
    <title>FACT/Flow</title>
    <link rel="icon" type="image/png" sizes="512x512" href="/flow/assets/icon-512-BaCJW5bY.png">
    <link rel="apple-touch-icon" href="/flow/assets/icon-512-BaCJW5bY.png">
    <link rel="manifest" href="/flow/assets/manifest-C1ecP5vc.json">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    colors: {
                        'fact-yellow': '#F4C44E',
                        'fact-green': '#75B876',
                        'fact-purple': '#B593C6',
                        'fact-gold': '#D4A853',
                        'fact-red': '#E74C3C',
                        'fact-ink': '#111111',
                        'fact-muted': '#6B7280',
                        'fact-border': '#E5E5E5',
                        'fact-dark-bg': '#0F0F0F',
                        'fact-dark-card': '#1A1A1A',
                        'fact-dark-ink': '#F5F5F5',
                        'fact-dark-muted': '#9CA3AF',
                        'fact-dark-border': '#2A2A2A'
                    }
                }
            }
        }
    </script>
  <!-- Auth-aware pre-render: hide everything, then show the right screen instantly -->
  <style id="authGuardCSS">
    #loginScreen, #mainApp { display: none !important; }
  </style>
  <script>
    // Synchronous check before first paint ‚Äî no flash at all
    // NOTE: This key is derived from the Supabase project ref (fihxypjmvizgwinozjsf).
    // If the project changes, update this to match: sb-{project-ref}-auth-token
    (function(){
      var key = 'sb-fihxypjmvizgwinozjsf-auth-token';
      var hasSession = false;
      try { hasSession = !!localStorage.getItem(key); } catch(e){}
      // If returning from OAuth with ?code= param, treat as "logging in" (show nothing until JS handles it)
      var hasCode = window.location.search.indexOf('code=') !== -1;
      var style = document.getElementById('authGuardCSS');
      if (hasCode) {
        // PKCE flow in progress ‚Äî keep both hidden, JS will resolve it
        // Safety: if JS hasn't resolved after 8s, show login
        setTimeout(function(){
          var guard = document.getElementById('authGuardCSS');
          if (guard && guard.textContent.indexOf('loginScreen') !== -1 && guard.textContent.indexOf('mainApp') !== -1) {
            guard.textContent = '#mainApp { display: none !important; }';
          }
        }, 8000);
      } else if (hasSession) {
        style.textContent = '#loginScreen { display: none !important; }';
      } else {
        style.textContent = '#mainApp { display: none !important; }';
      }
    })();
  </script>
  <script type="module" src="/src/main.js"></script>
</head>
<body class="text-fact-ink dark:text-fact-dark-ink">
    <!-- Skip to main content for accessibility -->
    <a href="#mainContent" class="skip-link" style="position: absolute; top: -40px; left: 0; z-index: 1000;">Skip to main content</a>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="toast-container" role="status" aria-live="polite" aria-atomic="true"></div>

    <!-- Confirmation Modal (dynamic) -->
    <div id="confirmModal" class="hidden">
        <!-- Rendered dynamically by showConfirm() -->
    </div>

    <!-- Celebration Overlay (dynamic) -->
    <div id="celebrationOverlay" class="hidden">
        <!-- Rendered dynamically by celebrate() -->
    </div>

    <!-- ACHIEVEMENTS MODAL -->
    <div id="achievementsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="achievementsTitle">
        <div class="modal-box card rounded-2xl w-full max-w-lg overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 id="achievementsTitle" class="font-display font-semibold">Achievements</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="achievementProgress">0 of 0 unlocked</p>
                </div>
                <button onclick="closeAchievements()" class="text-fact-muted hover:text-fact-ink">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="achievementsList" class="p-5 grid grid-cols-3 gap-3 max-h-[400px] overflow-y-auto">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- FINANCIAL HEALTH SCORE MODAL -->
    <div id="healthScoreModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" onclick="if(event.target === this) closeHealthScore()">
        <div class="modal-box card rounded-2xl w-full max-w-md overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">Financial Health</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Your personalized wellness score</p>
                </div>
                <button onclick="closeHealthScore()" class="text-fact-muted hover:text-fact-ink">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-5">
                <!-- Score Ring -->
                <div class="flex justify-center mb-4">
                    <div class="health-score-ring">
                        <svg width="120" height="120" viewBox="0 0 120 120">
                            <circle class="ring-bg" cx="60" cy="60" r="50" />
                            <circle id="healthRingProgress" class="ring-progress excellent" cx="60" cy="60" r="50"
                                stroke-dasharray="314.16" stroke-dashoffset="314.16" />
                        </svg>
                        <div class="health-score-value">
                            <div id="healthScoreNumber" class="health-score-number">--</div>
                            <div class="health-score-label">Health Score</div>
                        </div>
                    </div>
                </div>

                <!-- Score Status -->
                <div id="healthScoreStatus" class="text-center mb-4">
                    <div class="font-display font-semibold text-lg" id="healthStatusLabel">Calculating...</div>
                    <div class="text-sm text-fact-muted dark:text-fact-dark-muted" id="healthStatusDesc">Analyzing your spending patterns</div>
                </div>

                <!-- Factors Breakdown -->
                <div class="border-t border-fact-border dark:border-fact-dark-border pt-4">
                    <div class="text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-3">CONTRIBUTING FACTORS</div>
                    <div id="healthFactors" class="space-y-1">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Actionable Insight -->
                <div id="healthInsight" class="mt-4 bg-fact-yellow/10 border border-fact-yellow/30 rounded-lg p-3">
                    <div class="flex items-start gap-2">
                        <span class="text-lg">üí°</span>
                        <div>
                            <div class="text-sm font-medium" id="healthInsightTitle">Loading insight...</div>
                            <div class="text-xs text-fact-muted dark:text-fact-dark-muted" id="healthInsightText">Please wait</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="card rounded-2xl p-8 w-full max-w-sm relative overflow-hidden">
            <!-- Brand color accent bar -->
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-fact-yellow via-fact-green to-fact-purple"></div>

            <div class="text-center mb-6">
                <div class="w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4 bg-[#0a0a0a]">
                    <img src="/flow/assets/icon-512-BaCJW5bY.png" alt="/" class="w-12 h-12 object-contain">
                </div>
                <h1 class="font-display font-bold text-2xl">FACT/Flow</h1>
                <p class="text-fact-muted dark:text-fact-dark-muted text-sm mt-1">Personal Finance Intelligence</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Email</label>
                    <input type="text" id="loginUsername" placeholder="you@example.com"
                        class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:border-fact-yellow"
                        onkeypress="if(event.key==='Enter')attemptLogin()">
                </div>
                <button type="button" onclick="attemptLogin()" id="loginBtn"
                    class="w-full py-3 bg-gradient-to-r from-fact-yellow via-fact-green to-fact-purple text-white rounded-lg font-medium hover:opacity-90 transition shadow-sm">
                    Send magic link
                </button>
                <button type="button" onclick="loginWithGoogle()"
                    class="w-full py-2 border border-fact-border dark:border-fact-dark-border rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                    Continue with Google
                </button>
                <p id="loginError" class="text-center text-sm text-fact-red hidden">Invalid credentials</p>
            </div>

            <p class="text-center text-[10px] text-fact-muted dark:text-fact-dark-muted mt-6">FACT/Flow ¬∑ Secure Access</p>
        </div>
    </div>

    <!-- MAIN APP (hidden until logged in) -->
    <div id="mainApp" class="hidden">
    <div class="max-w-5xl mx-auto px-4 py-6 md:py-10">

        <!-- HEADER -->
        <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded flex items-center justify-center bg-[#0a0a0a]">
                    <img src="/flow/assets/icon-512-BaCJW5bY.png" alt="/" class="w-8 h-8 object-contain">
                </div>
                <div>
                    <h1 class="font-display font-bold text-xl tracking-tight">FACT<span class="text-fact-yellow">/</span><span class="text-fact-muted font-normal text-sm">Flow</span></h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="currentUserDisplay" class="text-[10px] text-fact-muted dark:text-fact-dark-muted">Personal Intelligence</span>
                        <span class="text-fact-muted/50">¬∑</span>
                        <button onclick="openGoals()" class="inline-flex items-center gap-1 px-2 py-0.5 text-[10px] font-medium rounded-full bg-fact-green/10 text-fact-green hover:bg-fact-green/20 transition">
                            üéØ Goals
                        </button>
                        <button onclick="openHeatmap()" class="inline-flex items-center gap-1 px-2 py-0.5 text-[10px] font-medium rounded-full bg-fact-purple/10 text-fact-purple hover:bg-fact-purple/20 transition">
                            üìä Heatmap
                        </button>
                        <button onclick="openSettings()" class="inline-flex items-center gap-1 px-2 py-0.5 text-[10px] font-medium rounded-full bg-fact-yellow/10 text-fact-yellow hover:bg-fact-yellow/20 transition">
                            ‚öôÔ∏è Settings
                        </button>
                        <button onclick="logout()" class="text-[10px] text-fact-muted hover:text-fact-red transition">Logout</button>
                        <kbd class="hidden md:inline text-[9px] opacity-40 px-1 rounded bg-gray-100 dark:bg-gray-800">‚åòK</kbd>
                    </div>
                </div>
            </div>

            <!-- Period Selector + Controls -->
            <div class="flex flex-col items-end gap-2">
                <div class="flex items-center gap-2">
                    <!-- Focus Mode Toggle -->
                    <button id="focusToggle" onclick="toggleFocusMode()" title="Focus Mode - simplified view" class="focus-toggle">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        <span>Focus</span>
                    </button>
                    <!-- Export Button -->
                    <button onclick="exportCSV()" title="Export CSV" class="w-8 h-8 flex items-center justify-center rounded-lg border border-fact-border dark:border-fact-dark-border hover:bg-gray-50 dark:hover:bg-gray-800 transition hide-in-focus">
                        <svg id="exportIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                    </button>
                    <!-- Dark Mode Toggle -->
                    <div id="themeToggle" onclick="toggleDarkMode()" class="theme-toggle" title="Toggle dark mode"></div>
                    <!-- Sync Button -->
                    <button onclick="syncData()" title="Sync data" class="w-8 h-8 flex items-center justify-center rounded-lg border border-fact-border dark:border-fact-dark-border hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                </div>
                <div class="flex flex-wrap items-center gap-1 bg-white dark:bg-fact-dark-card border border-fact-border dark:border-fact-dark-border rounded-lg p-1">
                    <button onclick="setSalaryPeriod()" data-period="salary" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">Salary</button>
                    <button onclick="setPeriod('thisMonth')" data-period="thisMonth" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">Month</button>
                    <button onclick="setPeriod('lastMonth')" data-period="lastMonth" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">Last</button>
                    <button onclick="setPeriod('last90')" data-period="last90" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">90d</button>
                    <button onclick="openDatePicker()" data-period="custom" class="period-btn px-3 py-1.5 text-xs font-medium rounded-md">Custom</button>
                </div>
                <div class="flex items-center gap-2">
                    <span id="dateRangeDisplay" class="text-[10px] text-fact-muted dark:text-fact-dark-muted">--</span>
                    <span id="lastSync" class="text-[10px] text-fact-muted dark:text-fact-dark-muted">--</span>
                </div>
            </div>
        </header>

        <!-- LOADING STATE -->
        <div id="loadingState" class="space-y-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="skeleton h-24"></div>
                <div class="skeleton h-24"></div>
                <div class="skeleton h-24"></div>
                <div class="skeleton h-24"></div>
            </div>
            <div class="skeleton h-80"></div>
        </div>

        <!-- MAIN CONTENT -->
        <main id="mainContent" class="hidden space-y-4" role="main" aria-label="Financial dashboard">

            <!-- FOCUS MODE HERO - Shows only in focus mode -->
            <div id="focusHero" class="focus-hero hidden">
                <div class="text-sm text-fact-muted dark:text-fact-dark-muted mb-2">
                    You can spend today
                </div>
                <div id="focusHeroNumber" class="focus-hero-number positive breathe">
                    QAR 150
                </div>
                <div class="focus-hero-label">remaining today</div>
                <div class="mt-4 flex items-center justify-center gap-4 text-sm">
                    <div class="text-center">
                        <div id="focusDaysToSalary" class="font-display font-bold text-fact-purple">--</div>
                        <div class="text-xs text-fact-muted dark:text-fact-dark-muted">days to salary</div>
                    </div>
                    <div class="w-px h-8 bg-fact-border dark:bg-fact-dark-border"></div>
                    <div class="text-center">
                        <div id="focusStreak" class="font-display font-bold text-fact-yellow">--</div>
                        <div class="text-xs text-fact-muted dark:text-fact-dark-muted">day streak</div>
                    </div>
                </div>
            </div>

            <!-- QUICK INSIGHT - One actionable item (shows in focus mode) -->
            <div id="quickInsight" class="quick-insight hidden">
                <div class="flex items-center">
                    <span class="quick-insight-icon">üí°</span>
                    <div class="flex-1">
                        <div class="text-sm font-medium" id="quickInsightText">You're doing great today!</div>
                        <div class="text-xs text-fact-muted dark:text-fact-dark-muted" id="quickInsightSubtext">Tap for more details</div>
                    </div>
                    <button onclick="toggleFocusMode()" class="text-xs text-fact-yellow hover:underline">See all ‚Üí</button>
                </div>
            </div>

            <!-- BUDGET HERO - Consolidated overview (hidden in focus mode) -->
            <div class="card rounded-xl p-4 hide-in-focus">
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 items-center">
                    <!-- Days until salary -->
                    <div class="flex items-center gap-3">
                        <div class="w-14 h-14 rounded-full bg-fact-purple/20 flex items-center justify-center">
                            <span class="font-display font-bold text-xl text-fact-purple" id="daysUntilSalary">--</span>
                        </div>
                        <div>
                            <div class="text-xs font-medium">days to salary</div>
                            <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted" id="nextSalaryDate">~--</div>
                        </div>
                    </div>

                    <!-- In / Out / Net -->
                    <div class="col-span-2 lg:col-span-3 flex items-center justify-center gap-3 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                        <div class="text-center">
                            <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">IN</div>
                            <div class="font-display font-bold text-lg text-fact-green" id="projIncome">--</div>
                        </div>
                        <div class="text-xl text-fact-muted">‚àí</div>
                        <div class="text-center">
                            <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">OUT</div>
                            <div class="font-display font-bold text-lg text-fact-yellow" id="projExpense">--</div>
                        </div>
                        <div class="text-xl text-fact-muted">=</div>
                        <div class="text-center">
                            <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">NET</div>
                            <div class="font-display font-bold text-lg" id="projNet">--</div>
                        </div>
                    </div>

                    <!-- Daily budget -->
                    <div class="text-right">
                        <div class="flex items-center justify-end gap-2">
                            <span id="budgetStatus" class="text-[10px] px-2 py-0.5 rounded-full bg-fact-green/20 text-fact-green font-medium">On Track</span>
                        </div>
                        <div class="font-display font-bold text-lg text-fact-purple mt-1" id="suggestedDaily">--/day</div>
                        <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">avg: <span id="avgDailySpend">--</span>/day</div>
                    </div>
                </div>
            </div>

            <!-- TODAY'S FOCUS - Simple daily view for ADHD -->
            <div class="card rounded-xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <h2 class="font-display font-semibold text-sm">Today</h2>
                        <div id="streakContainer">
                            <!-- Streak badge rendered by JS -->
                        </div>
                    </div>
                    <div class="text-xs text-fact-muted dark:text-fact-dark-muted" id="todayDate">--</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-fact-muted dark:text-fact-dark-muted">Spent today</span>
                        <span class="font-display font-bold" id="todaySpent">--</span>
                    </div>
                    <div id="dailyBudgetMeter" class="budget-meter">
                        <div class="budget-meter-fill safe" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-fact-muted dark:text-fact-dark-muted" id="dailyBudgetLabel">-- left today</span>
                        <span class="text-xs text-fact-muted dark:text-fact-dark-muted">Budget: <span id="todayBudget">--</span></span>
                    </div>
                </div>
            </div>

            <!-- IMPULSE WARNING BANNER (shown when burst detected) -->
            <div id="impulseBanner" class="impulse-banner">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">‚ö°</span>
                        <div>
                            <div class="font-semibold text-sm">Impulse Alert</div>
                            <div class="text-xs opacity-80" id="impulseMessage">Multiple purchases detected</div>
                        </div>
                    </div>
                    <button onclick="dismissImpulseBanner()" class="text-white/80 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>

            <!-- GENEROSITY BUDGET - For those who give generously -->
            <div id="generosityCard" class="generosity-card rounded-xl p-4 hidden">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="text-xl heart-pulse">üíú</span>
                        <h2 class="font-display font-semibold text-sm">Generosity Budget</h2>
                    </div>
                    <button onclick="openGenerositySettings()" class="text-fact-purple hover:text-fact-purple/80 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </button>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-fact-muted dark:text-fact-dark-muted">Given this month</span>
                        <span class="generosity-amount" id="generositySpent">QAR 0</span>
                    </div>
                    <div class="generosity-meter">
                        <div class="generosity-meter-fill" id="generosityMeterFill" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-fact-muted dark:text-fact-dark-muted" id="generosityStatus">You can still give!</span>
                        <span class="text-xs text-fact-muted dark:text-fact-dark-muted">Budget: <span id="generosityBudget">QAR 0</span></span>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-fact-border dark:border-fact-dark-border">
                    <div class="text-xs text-fact-muted dark:text-fact-dark-muted mb-2">Recent giving:</div>
                    <div id="recentGenerosity" class="space-y-1 max-h-24 overflow-y-auto">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>

            <!-- GENEROSITY SETTINGS MODAL -->
            <div id="generosityModal" class="modal-backdrop hidden" onclick="if(event.target === this) closeGenerositySettings()">
                <div class="modal-content max-w-md" onclick="event.stopPropagation()">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-display font-semibold text-lg flex items-center gap-2">
                            <span class="heart-pulse">üíú</span> Generosity Budget
                        </h3>
                        <button onclick="closeGenerositySettings()" class="text-fact-muted hover:text-fact-ink dark:hover:text-fact-dark-ink">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>

                    <p class="text-sm text-fact-muted dark:text-fact-dark-muted mb-4">
                        It's wonderful to be generous! Setting a giving budget helps you be intentionally generous without guilt or financial strain.
                    </p>

                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-1 block">Monthly Generosity Budget (QAR)</label>
                            <input type="number" id="generosityBudgetInput" placeholder="e.g., 500" min="0" step="50"
                                class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card">
                        </div>

                        <div>
                            <label class="text-sm font-medium mb-2 block">What counts as "generosity"?</label>
                            <div id="generosityCategories" class="space-y-2 text-sm">
                                <!-- Checkboxes rendered by JS -->
                            </div>
                        </div>

                        <div class="bg-fact-purple/10 rounded-lg p-3">
                            <div class="text-xs font-medium text-fact-purple mb-1">üí° Why set a giving budget?</div>
                            <ul class="text-xs text-fact-muted dark:text-fact-dark-muted space-y-1">
                                <li>‚Ä¢ Give without guilt (you planned for it!)</li>
                                <li>‚Ä¢ Say "not this time" without feeling bad</li>
                                <li>‚Ä¢ Be generous sustainably, not impulsively</li>
                            </ul>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button onclick="closeGenerositySettings()" class="flex-1 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg text-sm font-medium">
                            Cancel
                        </button>
                        <button onclick="saveGenerositySettings()" class="flex-1 py-2 bg-fact-purple text-white rounded-lg text-sm font-medium">
                            Save Budget
                        </button>
                    </div>
                </div>
            </div>

            <!-- UNCATEGORIZED ALERT -->
            <div id="uncatAlert" class="hidden card rounded-xl p-3 border-l-4 border-fact-yellow bg-yellow-50 dark:bg-yellow-900/20 cursor-pointer hover:bg-yellow-100 dark:hover:bg-yellow-900/30 transition" onclick="openUncatModal()">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">‚ö†Ô∏è</span>
                        <span class="text-sm"><span id="uncatCount">0</span> uncategorized (QAR <span id="uncatAmount">0</span>)</span>
                    </div>
                    <span class="text-xs font-medium text-fact-yellow">Fix ‚Üí</span>
                </div>
            </div>

            <!-- MAIN GRID: Breakdown (left) | AI Chat + Transactions (right) - Hidden in focus mode -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 hide-in-focus" style="min-height: 500px;">

                <!-- SPENDING BREAKDOWN (Full left - 2 cols) -->
                <div class="lg:col-span-2 card rounded-xl p-4 relative flex flex-col">
                    <div class="corner-mark corner-tl"></div>
                    <div class="corner-mark corner-tr"></div>
                    <div class="corner-mark corner-bl"></div>
                    <div class="corner-mark corner-br"></div>

                    <div class="flex items-center justify-between mb-3">
                        <h2 class="font-display font-semibold text-sm">Spending Breakdown</h2>
                        <div class="flex items-center gap-1 bg-gray-100 dark:bg-gray-800 rounded-lg p-0.5">
                            <button onclick="setViewMode('parent')" id="viewParent" class="px-2 py-1 text-[10px] font-medium rounded-md bg-fact-ink dark:bg-fact-dark-ink text-white dark:text-fact-dark-bg">Groups</button>
                            <button onclick="setViewMode('subcat')" id="viewSubcat" class="px-2 py-1 text-[10px] font-medium rounded-md text-fact-muted dark:text-fact-dark-muted">Details</button>
                        </div>
                    </div>

                    <!-- Donut Chart -->
                    <div class="relative h-44 flex items-center justify-center">
                        <canvas id="donutChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="text-center">
                                <div class="font-display font-bold text-2xl" id="donutTotal">--</div>
                                <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted">Total Spent</div>
                            </div>
                        </div>
                    </div>

                    <!-- INSIGHTS (between donut and categories) -->
                    <div id="insightsSection" class="mt-3 py-3 px-3 bg-gradient-to-br from-gray-50 to-white dark:from-gray-800 dark:to-gray-900 rounded-lg border border-fact-border dark:border-fact-dark-border">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-semibold text-fact-ink dark:text-fact-dark-ink">Insights</span>
                                <span id="insightsCount" class="text-[9px] bg-fact-yellow/20 text-fact-yellow px-1.5 py-0.5 rounded-full font-medium">0</span>
                            </div>
                            <button onclick="refreshInsights()" id="refreshInsightsBtn" class="text-[10px] text-fact-muted hover:text-fact-yellow transition flex items-center gap-1" title="Refresh insights using your context">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                        <div id="insightsTags" class="flex flex-wrap gap-1.5">
                            <!-- Populated by JS -->
                        </div>
                        <!-- AI-powered additional insights -->
                        <div id="aiInsightsContainer" class="hidden mt-3 pt-3 border-t border-fact-border/50 dark:border-fact-dark-border/50">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-[10px] font-medium text-fact-purple">‚ú® AI Analysis</span>
                                <button onclick="closeAiInsights()" class="text-[10px] text-fact-muted hover:text-fact-red transition">‚úï Close</button>
                            </div>
                            <div id="aiInsightsList" class="space-y-1.5">
                                <!-- AI insights added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Category List (expanded breakdown) -->
                    <div class="flex-1 mt-3 overflow-y-auto">
                        <div id="categoryBreakdown" class="space-y-2">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Quick dimension filters -->
                    <div class="mt-3 pt-3 border-t border-fact-border dark:border-fact-dark-border">
                        <div class="flex flex-wrap gap-1.5">
                            <button onclick="filterByDimension('workHours')" class="dim-filter px-2 py-1 text-[10px] rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">üíº Work</button>
                            <button onclick="filterByDimension('lateNight')" class="dim-filter px-2 py-1 text-[10px] rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">üåô Night</button>
                            <button onclick="filterByDimension('nightOut')" class="dim-filter px-2 py-1 text-[10px] rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">üéâ Out</button>
                            <button onclick="filterByDimension('splurge')" class="dim-filter px-2 py-1 text-[10px] rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-fact-yellow hover:border-fact-yellow hover:text-fact-ink transition">üí∏ Splurge</button>
                            <button onclick="filterByDimension('clear')" class="dim-filter px-2 py-1 text-[10px] rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: AI Chat (top 2/3) + Transactions (bottom 1/3) -->
                <div class="lg:col-span-3 flex flex-col gap-4">

                    <!-- AI CHAT PANEL -->
                    <div class="card rounded-xl overflow-hidden flex flex-col flex-[2]" style="min-height: 300px;">
                        <div class="p-3 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                            <div>
                                <h2 class="font-display font-semibold text-sm">Ask AI</h2>
                                <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted">using <span class="text-fact-purple" id="aiModelName">claude-sonnet</span></p>
                            </div>
                            <button onclick="clearAIChat()" class="text-[10px] text-fact-muted hover:text-fact-ink dark:hover:text-fact-dark-ink">Clear</button>
                        </div>

                        <!-- Chat messages -->
                        <div id="aiChatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm">
                            <div class="text-fact-muted dark:text-fact-dark-muted text-xs">Ask me anything about your spending...</div>
                        </div>

                        <!-- Quick questions -->
                        <div class="px-4 py-2 border-t border-fact-border dark:border-fact-dark-border">
                            <div class="flex flex-wrap gap-1.5">
                                <button onclick="askAIChat('What are my biggest spending categories?')" class="text-[10px] px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-fact-yellow hover:text-fact-ink transition">Top categories</button>
                                <button onclick="askAIChat('Are there any unusual transactions?')" class="text-[10px] px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-fact-yellow hover:text-fact-ink transition">Unusual?</button>
                                <button onclick="askAIChat('How can I save money?')" class="text-[10px] px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-fact-yellow hover:text-fact-ink transition">Save tips</button>
                                <button onclick="askAIChat('What are my salary payments?')" class="text-[10px] px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-fact-yellow hover:text-fact-ink transition">Salary info</button>
                            </div>
                        </div>

                        <!-- Input with Voice -->
                        <div class="p-3 border-t border-fact-border dark:border-fact-dark-border">
                            <div class="flex gap-2">
                                <input type="text" id="aiChatInput" placeholder="Ask about your spending..."
                                    class="flex-1 px-3 py-2 text-sm border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:border-fact-yellow"
                                    onkeypress="if(event.key==='Enter')askAIChat()">
                                <button id="voiceBtn" onclick="toggleVoiceInput()" title="Voice input"
                                    class="voice-btn w-10 h-10 flex items-center justify-center rounded-lg border border-fact-border dark:border-fact-dark-border hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                                    </svg>
                                </button>
                                <button onclick="askAIChat()" class="px-4 py-2 text-sm font-medium rounded-lg bg-fact-yellow text-fact-ink hover:bg-fact-yellow/80 transition">Send</button>
                            </div>
                            <div id="voiceStatus" class="hidden mt-2 text-xs text-fact-muted dark:text-fact-dark-muted text-center">
                                <span class="animate-pulse">Listening...</span>
                            </div>
                        </div>
                    </div>

                    <!-- TRANSACTIONS (bottom 1/3) -->
                    <div class="card rounded-xl overflow-hidden flex flex-col flex-1" style="min-height: 180px;">
                        <div class="p-3 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                            <div>
                                <h2 class="font-display font-semibold text-sm">Transactions</h2>
                                <p class="text-[10px] text-fact-muted dark:text-fact-dark-muted" id="txnCountLabel">--</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <select id="txnSortSelect" onchange="sortTransactions(this.value)" class="text-[10px] px-2 py-1 border border-fact-border dark:border-fact-dark-border rounded bg-white dark:bg-fact-dark-card">
                                    <option value="date-desc">Newest</option>
                                    <option value="date-asc">Oldest</option>
                                    <option value="amount-desc">Highest</option>
                                    <option value="amount-asc">Lowest</option>
                                </select>
                                <input type="text" id="txnFilterInput" placeholder="Filter..." oninput="filterTransactions(this.value)"
                                    class="text-[10px] w-20 px-2 py-1 border border-fact-border dark:border-fact-dark-border rounded bg-white dark:bg-fact-dark-card">
                                <button onclick="openTxnModal()" class="text-xs font-medium text-fact-yellow">All</button>
                            </div>
                        </div>
                        <div id="recentTxns" class="flex-1 divide-y divide-fact-border dark:divide-fact-dark-border overflow-y-auto">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <footer class="text-center text-[10px] text-fact-muted dark:text-fact-dark-muted pt-4">
                <span id="lastSyncFooter">Not synced</span> ¬∑ <button onclick="syncData()" class="underline hover:text-fact-ink dark:hover:text-fact-dark-ink">Sync Now</button>
            </footer>
        </main>
    </div>
    </div> <!-- Close mainApp -->

    <!-- MODALS -->

    <!-- DATE PICKER MODAL -->
    <div id="dateModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-sm overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border">
                <h3 class="font-display font-semibold">Custom Date Range</h3>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Start Date</label>
                    <input type="date" id="startDate" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">End Date</label>
                    <input type="date" id="endDate" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                </div>
            </div>
            <div class="p-5 border-t border-fact-border dark:border-fact-dark-border flex gap-3">
                <button onclick="closeDatePicker()" class="flex-1 px-4 py-2 text-sm text-fact-muted hover:text-fact-ink rounded-lg">Cancel</button>
                <button onclick="applyCustomDate()" class="flex-1 px-4 py-2 text-sm bg-fact-ink dark:bg-fact-dark-ink text-white dark:text-fact-dark-bg rounded-lg font-medium">Apply</button>
            </div>
        </div>
    </div>

    <!-- CATEGORY DRILL-DOWN MODAL -->
    <div id="drilldownModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold" id="drilldownTitle">Category</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="drilldownSubtitle">-- transactions</p>
                </div>
                <button onclick="closeDrilldown()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Drilldown Charts -->
            <div class="p-5 space-y-4 border-b border-fact-border dark:border-fact-dark-border">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider mb-1">Total Spent</p>
                        <p class="font-display font-bold text-2xl" id="drilldownTotal">--</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider mb-1">vs Last Period</p>
                        <p class="font-display font-bold text-2xl" id="drilldownDelta">--</p>
                    </div>
                </div>

                <!-- Timeline Chart -->
                <div>
                    <p class="text-xs font-medium mb-2">Spending Over Time</p>
                    <div class="h-32">
                        <canvas id="drilldownTimeline"></canvas>
                    </div>
                </div>

                <!-- Breakdown Section (Merchants/Subcategories/Stats) -->
                <div id="drilldownMerchants" class="space-y-2">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Transactions -->
            <div class="flex-1 overflow-y-auto">
                <div id="drilldownTxns" class="divide-y divide-fact-border dark:divide-fact-dark-border">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- UNCATEGORIZED MODAL -->
    <div id="uncatModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">Uncategorized Transactions</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Click to categorize</p>
                </div>
                <button onclick="closeUncatModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="uncatList" class="flex-1 overflow-y-auto divide-y divide-fact-border dark:divide-fact-dark-border">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- CATEGORIZE MODAL -->
    <div id="catModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-sm overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border">
                <h3 class="font-display font-semibold">Categorize Transaction</h3>
            </div>
            <div class="p-5 space-y-4">
                <!-- Recipient info (shown when matched) -->
                <div id="catModalRecipient" class="hidden p-3 bg-fact-gold/10 border border-fact-gold/30 rounded-lg">
                    <div class="text-[10px] text-fact-gold mb-1">üë§ Matched Recipient</div>
                    <div class="text-sm font-medium" id="catModalRecipientName">--</div>
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted" id="catModalRecipientDetails">--</div>
                </div>
                <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Original</div>
                    <div class="text-sm font-medium break-all" id="catModalRaw">--</div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Display Name</label>
                    <input type="text" id="catModalName" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow" placeholder="e.g., Starbucks">
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Category</label>
                    <select id="catModalCat" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>
            <div class="p-5 border-t border-fact-border dark:border-fact-dark-border flex gap-3">
                <button onclick="closeCatModal()" class="flex-1 px-4 py-2 text-sm text-fact-muted hover:text-fact-ink rounded-lg">Cancel</button>
                <button onclick="saveCategorization()" class="flex-1 px-4 py-2 text-sm bg-fact-yellow text-fact-ink rounded-lg font-medium">Save</button>
            </div>
        </div>
    </div>

    <!-- ALL TRANSACTIONS MODAL -->
    <div id="txnModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">All Transactions</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="txnModalCount">-- transactions</p>
                </div>
                <button onclick="closeTxnModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border flex gap-3">
                <input type="text" id="txnSearch" placeholder="Search..." class="flex-1 px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                <select id="txnFilter" class="px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div id="txnModalList" class="flex-1 overflow-y-auto divide-y divide-fact-border dark:divide-fact-dark-border">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- ALL MERCHANTS MODAL -->
    <div id="merchantModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">All Merchants</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="merchantModalCount">-- merchants</p>
                </div>
                <button onclick="closeMerchantModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border flex gap-3">
                <input type="text" id="merchantSearch" placeholder="Search merchants..." class="flex-1 px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow" oninput="filterMerchantModal()">
                <select id="merchantSort" class="px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none" onchange="filterMerchantModal()">
                    <option value="amount">By Total</option>
                    <option value="count">By Count</option>
                    <option value="name">By Name</option>
                </select>
            </div>
            <div id="merchantModalList" class="flex-1 overflow-y-auto divide-y divide-fact-border dark:divide-fact-dark-border">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- AI QUERY MODAL -->
    <div id="aiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">Ask AI About Your Spending</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Powered by Claude via Supabase</p>
                </div>
                <button onclick="closeAskAI()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Quick Questions -->
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border">
                <p class="text-[10px] font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wider mb-2">Quick Questions</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="askAI('What are my biggest spending categories this period?')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Top categories</button>
                    <button onclick="askAI('Find any unusual or suspicious transactions')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Anomalies</button>
                    <button onclick="askAI('Which transactions might be work expenses I could claim?')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Work expenses</button>
                    <button onclick="askAI('Summarize my night out spending patterns')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Night outs</button>
                    <button onclick="askAI('What subscriptions or recurring payments do I have?')" class="px-3 py-1.5 text-xs rounded-full border border-fact-border dark:border-fact-dark-border hover:bg-gray-100 dark:hover:bg-gray-800 transition">Subscriptions</button>
                </div>
            </div>

            <!-- Custom Query -->
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border">
                <div class="flex gap-2">
                    <input type="text" id="aiQueryInput" placeholder="Ask anything about your spending..." class="flex-1 px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow" onkeydown="if(event.key==='Enter')askAI()">
                    <button onclick="askAI()" class="px-4 py-2 bg-fact-ink dark:bg-fact-dark-ink text-white dark:text-fact-dark-bg rounded-lg text-sm font-medium">Ask</button>
                </div>
            </div>

            <!-- Response -->
            <div class="flex-1 overflow-y-auto p-5">
                <div id="aiResponse" class="prose prose-sm dark:prose-invert max-w-none">
                    <p class="text-fact-muted dark:text-fact-dark-muted text-sm">Ask a question to analyze your spending data.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- FILTERED VIEW MODAL -->
    <div id="filteredModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold" id="filteredTitle">Filtered Transactions</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted" id="filteredSubtitle">-- transactions</p>
                </div>
                <button onclick="closeFilteredModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Stats Summary -->
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border grid grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Total</div>
                    <div class="font-display font-bold" id="filteredTotal">--</div>
                </div>
                <div class="text-center">
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Count</div>
                    <div class="font-display font-bold" id="filteredCount">--</div>
                </div>
                <div class="text-center">
                    <div class="text-[10px] text-fact-muted dark:text-fact-dark-muted mb-1">Average</div>
                    <div class="font-display font-bold" id="filteredAvg">--</div>
                </div>
            </div>

            <div id="filteredList" class="flex-1 overflow-y-auto divide-y divide-fact-border dark:divide-fact-dark-border">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL (Tabbed) -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between flex-shrink-0">
                <h3 class="font-display font-semibold text-lg">Settings</h3>
                <button onclick="closeSettings()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center" aria-label="Close settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Tab Navigation -->
            <div class="flex border-b border-fact-border dark:border-fact-dark-border flex-shrink-0" role="tablist">
                <button onclick="switchSettingsTab('general')" id="tabGeneral" role="tab" aria-selected="true" aria-controls="panelGeneral"
                    class="settings-tab flex-1 flex items-center justify-center gap-2 py-3 text-sm font-medium border-b-2 border-fact-yellow text-fact-ink dark:text-fact-dark-ink min-h-[48px] transition-colors">
                    <span class="text-base">‚öôÔ∏è</span>
                    <span>General</span>
                </button>
                <button onclick="switchSettingsTab('goals')" id="tabGoals" role="tab" aria-selected="false" aria-controls="panelGoals"
                    class="settings-tab flex-1 flex items-center justify-center gap-2 py-3 text-sm font-medium border-b-2 border-transparent text-fact-muted hover:text-fact-ink dark:hover:text-fact-dark-ink min-h-[48px] transition-colors">
                    <span class="text-base">üéØ</span>
                    <span>Goals</span>
                </button>
                <button onclick="switchSettingsTab('contacts')" id="tabContacts" role="tab" aria-selected="false" aria-controls="panelContacts"
                    class="settings-tab flex-1 flex items-center justify-center gap-2 py-3 text-sm font-medium border-b-2 border-transparent text-fact-muted hover:text-fact-ink dark:hover:text-fact-dark-ink min-h-[48px] transition-colors">
                    <span class="text-base">üë•</span>
                    <span>Contacts</span>
                </button>
                <button onclick="switchSettingsTab('profile')" id="tabProfile" role="tab" aria-selected="false" aria-controls="panelProfile"
                    class="settings-tab flex-1 flex items-center justify-center gap-2 py-3 text-sm font-medium border-b-2 border-transparent text-fact-muted hover:text-fact-ink dark:hover:text-fact-dark-ink min-h-[48px] transition-colors">
                    <span class="text-base">üë§</span>
                    <span>Profile</span>
                </button>
            </div>

            <!-- Tab Panels Container (scrollable) -->
            <div class="flex-1 overflow-y-auto">

                <!-- General Panel -->
                <div id="panelGeneral" role="tabpanel" aria-labelledby="tabGeneral" class="settings-panel p-5 space-y-6">
                    <!-- AI Model Selection -->
                    <div>
                        <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-2" for="settingsAiModel">
                            AI Model (Ask AI)
                        </label>
                        <select id="settingsAiModel"
                            class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow text-sm min-h-[48px]">
                            <option value="claude-sonnet" selected>Claude Sonnet (Recommended)</option>
                            <option value="claude-haiku">Claude Haiku (Faster)</option>
                        </select>
                        <p class="text-[10px] text-fact-muted mt-1.5">Deep analysis and insights always use Claude Sonnet</p>
                    </div>

                    <!-- Password Change -->
                    <div class="border-t border-fact-border dark:border-fact-dark-border pt-5">
                        <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-3">Change Password</label>
                        <div class="space-y-3">
                            <input type="password" id="settingsCurrentPass" placeholder="Current password" autocomplete="current-password"
                                class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow text-sm">
                            <input type="password" id="settingsNewPass" placeholder="New password" autocomplete="new-password"
                                class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow text-sm">
                            <input type="password" id="settingsConfirmPass" placeholder="Confirm new password" autocomplete="new-password"
                                class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card focus:outline-none focus:ring-2 focus:ring-fact-yellow text-sm">
                            <button onclick="changePassword()"
                                class="w-full px-4 py-3 text-sm bg-fact-ink dark:bg-white text-white dark:text-fact-ink rounded-xl font-medium hover:opacity-90 transition min-h-[48px]">
                                Update Password
                            </button>
                        </div>
                        <p id="settingsPassError" class="text-xs text-fact-red mt-2 hidden"></p>
                        <p id="settingsPassSuccess" class="text-xs text-fact-green mt-2 hidden"></p>
                    </div>

                    <!-- iOS Shortcut Key -->
                    <div class="border-t border-fact-border dark:border-fact-dark-border pt-5">
                        <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-2">iOS Shortcut Key</label>
                        <p class="text-xs text-fact-muted mb-3">Generate a key to paste into your iOS Shortcut. The key is shown once.</p>
                        <div class="flex gap-2">
                            <button onclick="generateShortcutKey()"
                                class="flex-1 px-4 py-3 text-sm bg-fact-ink dark:bg-white text-white dark:text-fact-ink rounded-xl font-medium hover:opacity-90 transition min-h-[48px]">
                                Generate Key
                            </button>
                            <button onclick="revokeShortcutKey()"
                                class="px-4 py-3 text-sm border border-fact-border dark:border-fact-dark-border rounded-xl font-medium hover:bg-gray-50 dark:hover:bg-gray-800 transition min-h-[48px]">
                                Revoke
                            </button>
                        </div>
                        <button onclick="openShortcutSetup()"
                            class="mt-2 w-full px-4 py-2 text-xs border border-fact-border dark:border-fact-dark-border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                            Open Shortcuts Setup
                        </button>
                        <div id="shortcutKeyBox" class="hidden mt-3 flex items-center gap-2 bg-gray-50 dark:bg-gray-800 rounded-xl p-3">
                            <input id="shortcutKeyValue" readonly
                                class="flex-1 bg-transparent text-xs font-mono outline-none"
                                value="">
                            <button onclick="copyShortcutKey()" class="text-xs text-fact-ink dark:text-fact-dark-ink">Copy</button>
                        </div>
                        <p id="shortcutKeyStatus" class="text-xs text-fact-muted mt-2"></p>
                    </div>

                    <!-- AI Memory Info -->
                    <div class="border-t border-fact-border dark:border-fact-dark-border pt-5">
                        <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-2">AI Memory</label>
                        <p class="text-xs text-fact-muted mb-3">Teach the AI about your finances using Ask AI:</p>
                        <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-4 text-xs font-mono space-y-2">
                            <p class="text-fact-ink dark:text-fact-dark-ink">"Remember that my salary arrives on day 28"</p>
                            <p class="text-fact-ink dark:text-fact-dark-ink">"Remember that Aleks handles my flights"</p>
                            <p class="text-fact-ink dark:text-fact-dark-ink">"Remember that Ooredoo is telecom, not splurge"</p>
                        </div>
                    </div>
                </div>

                <!-- Goals Panel -->
                <div id="panelGoals" role="tabpanel" aria-labelledby="tabGoals" class="settings-panel p-5 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="font-medium text-sm">Budget Goals</h4>
                            <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Set spending limits by category</p>
                        </div>
                        <button onclick="addNewGoal()"
                            class="px-4 py-2 text-sm font-medium text-fact-ink bg-fact-yellow rounded-xl hover:bg-fact-yellow/80 transition min-h-[44px]">
                            + Add Goal
                        </button>
                    </div>
                    <div id="settingsGoalsList" class="space-y-3 max-h-[350px] overflow-y-auto">
                        <!-- Populated by renderSettingsGoalsList() -->
                    </div>
                </div>

                <!-- Contacts Panel -->
                <div id="panelContacts" role="tabpanel" aria-labelledby="tabContacts" class="settings-panel p-5 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="font-medium text-sm">Transfer Contacts</h4>
                            <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Manage phone/account name mappings</p>
                        </div>
                        <button onclick="addNewRecipient()"
                            class="px-4 py-2 text-sm font-medium text-fact-ink bg-fact-yellow rounded-xl hover:bg-fact-yellow/80 transition min-h-[44px]">
                            + Add Contact
                        </button>
                    </div>

                    <!-- Search/Filter -->
                    <div class="mb-4">
                        <input type="text" id="recipientSearch" placeholder="Search contacts..."
                            class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow"
                            oninput="filterRecipientsList()">
                    </div>

                    <!-- Recipients List -->
                    <div id="recipientsList" class="space-y-2 max-h-[300px] overflow-y-auto">
                        <!-- Populated by renderRecipientsList() -->
                    </div>
                </div>

                <!-- Profile Panel -->
                <div id="panelProfile" role="tabpanel" aria-labelledby="tabProfile" class="settings-panel p-5 hidden">
                    <h4 class="font-medium text-sm mb-4">Financial Profile</h4>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted mb-4">Set your financial details for smarter budgeting and AI advice.</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1" for="profileSalaryDay">Salary Day (1-31)</label>
                            <input type="number" id="profileSalaryDay" min="1" max="31" placeholder="e.g. 28"
                                class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1" for="profileSalaryAmount">Monthly Salary (QAR)</label>
                            <input type="number" id="profileSalaryAmount" placeholder="e.g. 15000"
                                class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1" for="profileMonthlyBudget">Monthly Budget Target (QAR)</label>
                            <input type="number" id="profileMonthlyBudget" placeholder="e.g. 8000"
                                class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1" for="profileFamilyNames">Family Member Names (comma-separated)</label>
                            <input type="text" id="profileFamilyNames" placeholder="e.g. ahmed, fatima, mom"
                                class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                        </div>
                        <button onclick="saveProfile()"
                            class="w-full py-3 text-sm font-medium text-fact-ink bg-fact-yellow rounded-xl hover:bg-fact-yellow/80 transition min-h-[48px]">
                            Save Profile
                        </button>
                    </div>

                    <!-- Backfill Section -->
                    <div id="backfillSection" class="mt-6 pt-4 border-t border-fact-border dark:border-fact-dark-border">
                        <h4 class="font-medium text-sm mb-2">Data Backfill</h4>
                        <p class="text-xs text-fact-muted dark:text-fact-dark-muted mb-3">Categorize legacy transactions that don't have AI subcategories.</p>
                        <button id="backfillBtn" onclick="runBackfill()"
                            class="w-full py-3 text-sm font-medium text-white bg-fact-purple rounded-xl hover:bg-fact-purple/80 transition min-h-[48px]">
                            Run Backfill
                        </button>
                        <p id="backfillStatus" class="text-xs text-fact-muted dark:text-fact-dark-muted mt-2 text-center"></p>
                    </div>
                </div>
            </div>

            <!-- Footer (for General tab) -->
            <div id="settingsFooter" class="p-5 border-t border-fact-border dark:border-fact-dark-border flex-shrink-0">
                <button onclick="saveSettings()"
                    class="w-full px-4 py-3 text-sm bg-gradient-to-r from-fact-yellow via-fact-green to-fact-purple text-white rounded-xl font-medium hover:opacity-90 transition min-h-[48px]">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- SHORTCUT SETUP MODAL -->
    <div id="shortcutSetupModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" onclick="if(event.target === this) closeShortcutSetup()">
        <div class="modal-box card rounded-2xl w-full max-w-lg overflow-hidden flex flex-col">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <h3 class="font-display font-semibold text-lg">iOS Shortcuts Setup</h3>
                <button onclick="closeShortcutSetup()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4 text-sm">
                <ol class="list-decimal list-inside space-y-2 text-fact-ink dark:text-fact-dark-ink">
                    <li>Generate a Shortcut key in Settings.</li>
                    <li>Open the Shortcut template and install it.</li>
                    <li>Paste your key into the Shortcut.</li>
                    <li>Trigger the Shortcut with a test SMS.</li>
                </ol>
                <a id="shortcutTemplateLink" href="#" target="_blank"
                    class="inline-flex items-center justify-center w-full px-4 py-3 text-sm bg-fact-ink dark:bg-white text-white dark:text-fact-ink rounded-xl font-medium hover:opacity-90 transition min-h-[48px]">
                    Open Shortcut Template
                </a>
                <p class="text-xs text-fact-muted">If the link is missing, update CONFIG.SHORTCUT_TEMPLATE_URL in the configuration.</p>
            </div>
        </div>
    </div>

    <!-- ADD/EDIT RECIPIENT MODAL -->
    <div id="recipientModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-sm overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border">
                <h3 class="font-display font-semibold" id="recipientModalTitle">Add Contact</h3>
            </div>
            <div class="p-5 space-y-4">
                <input type="hidden" id="recipientEditIndex" value="-1">
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1.5" for="recipientPhone">
                        Phone Number
                    </label>
                    <input type="tel" id="recipientPhone" placeholder="e.g., 55512345"
                        class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1.5" for="recipientBankAccount">
                        Bank Account <span class="text-fact-muted">(optional)</span>
                    </label>
                    <input type="text" id="recipientBankAccount" placeholder="e.g., QA12QNBA000..."
                        class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1.5" for="recipientShortName">
                        Short Name <span class="text-fact-red">*</span>
                    </label>
                    <input type="text" id="recipientShortName" placeholder="e.g., Mom" required
                        class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1.5" for="recipientLongName">
                        Full Name <span class="text-fact-muted">(optional)</span>
                    </label>
                    <input type="text" id="recipientLongName" placeholder="e.g., Sarah Johnson"
                        class="w-full px-4 py-3 border border-fact-border dark:border-fact-dark-border rounded-xl bg-white dark:bg-fact-dark-card text-sm focus:outline-none focus:ring-2 focus:ring-fact-yellow">
                </div>
            </div>
            <div class="p-5 border-t border-fact-border dark:border-fact-dark-border flex gap-3">
                <button onclick="closeRecipientModal()"
                    class="flex-1 px-4 py-3 text-sm text-fact-muted hover:text-fact-ink rounded-xl transition min-h-[48px]">
                    Cancel
                </button>
                <button onclick="saveRecipient()"
                    class="flex-1 px-4 py-3 text-sm bg-fact-yellow text-fact-ink rounded-xl font-medium hover:bg-fact-yellow/80 transition min-h-[48px]">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- COMMAND PALETTE -->
    <div id="cmdPalette" class="cmd-palette">
        <div class="cmd-palette-backdrop" onclick="closeCmdPalette()"></div>
        <div class="cmd-palette-box">
            <div class="p-4 border-b border-fact-border dark:border-fact-dark-border">
                <input type="text" id="cmdInput" placeholder="Type a command or search..."
                    class="w-full px-3 py-2 text-sm bg-transparent border-none focus:outline-none"
                    oninput="filterCommands(this.value)" onkeydown="handleCmdKeydown(event)">
            </div>
            <div id="cmdList" class="max-h-[300px] overflow-y-auto">
                <!-- Populated by JS -->
            </div>
            <div class="p-2 border-t border-fact-border dark:border-fact-dark-border bg-gray-50 dark:bg-gray-800">
                <div class="flex items-center justify-between text-[10px] text-fact-muted dark:text-fact-dark-muted">
                    <span><kbd class="px-1 py-0.5 bg-white dark:bg-gray-700 rounded text-[9px]">‚Üë‚Üì</kbd> Navigate</span>
                    <span><kbd class="px-1 py-0.5 bg-white dark:bg-gray-700 rounded text-[9px]">‚Üµ</kbd> Select</span>
                    <span><kbd class="px-1 py-0.5 bg-white dark:bg-gray-700 rounded text-[9px]">Esc</kbd> Close</span>
                </div>
            </div>
        </div>
    </div>

    <!-- KEYBOARD SHORTCUTS HELP MODAL -->
    <div id="shortcutsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-md overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <h3 class="font-display font-semibold">Keyboard Shortcuts</h3>
                <button onclick="closeShortcuts()" class="text-fact-muted hover:text-fact-ink">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div class="space-y-3">
                    <h4 class="text-xs font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wide">Navigation</h4>
                    <div class="flex items-center justify-between py-1">
                        <span class="text-sm">Open command palette</span>
                        <div class="flex gap-1"><span class="kbd-key">‚åò</span><span class="kbd-key">K</span></div>
                    </div>
                    <div class="flex items-center justify-between py-1">
                        <span class="text-sm">Close modal</span>
                        <span class="kbd-key">Esc</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <h4 class="text-xs font-medium text-fact-muted dark:text-fact-dark-muted uppercase tracking-wide">Quick Actions (in palette)</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="flex items-center justify-between"><span>Ask AI</span><span class="kbd-key">A</span></div>
                        <div class="flex items-center justify-between"><span>Refresh</span><span class="kbd-key">R</span></div>
                        <div class="flex items-center justify-between"><span>Goals</span><span class="kbd-key">G</span></div>
                        <div class="flex items-center justify-between"><span>Heatmap</span><span class="kbd-key">H</span></div>
                        <div class="flex items-center justify-between"><span>Export</span><span class="kbd-key">E</span></div>
                        <div class="flex items-center justify-between"><span>Dark Mode</span><span class="kbd-key">D</span></div>
                        <div class="flex items-center justify-between"><span>Merchants</span><span class="kbd-key">M</span></div>
                        <div class="flex items-center justify-between"><span>Transactions</span><span class="kbd-key">T</span></div>
                        <div class="flex items-center justify-between"><span>Voice</span><span class="kbd-key">V</span></div>
                        <div class="flex items-center justify-between"><span>Settings</span><span class="kbd-key">S</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GOALS MODAL -->
    <div id="goalsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-md overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">Budget Goals</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Set spending limits by category</p>
                </div>
                <button onclick="closeGoals()" class="text-fact-muted hover:text-fact-ink">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="goalsList" class="p-5 space-y-4 max-h-[400px] overflow-y-auto">
                <!-- Populated by JS -->
            </div>
            <div class="p-4 border-t border-fact-border dark:border-fact-dark-border bg-gray-50 dark:bg-gray-800">
                <button onclick="addNewGoal()" class="w-full py-2 text-sm font-medium text-fact-yellow hover:bg-fact-yellow/10 rounded-lg transition">
                    + Add Category Goal
                </button>
            </div>
        </div>
    </div>

    <!-- ADD GOAL MODAL -->
    <div id="addGoalModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-sm overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border">
                <h3 class="font-display font-semibold">New Budget Goal</h3>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Category</label>
                    <select id="goalCategory" class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-fact-muted dark:text-fact-dark-muted mb-1">Monthly Budget (QAR)</label>
                    <input type="number" id="goalAmount" placeholder="1000"
                        class="w-full px-3 py-2 border border-fact-border dark:border-fact-dark-border rounded-lg bg-white dark:bg-fact-dark-card">
                </div>
            </div>
            <div class="p-5 border-t border-fact-border dark:border-fact-dark-border flex gap-3">
                <button onclick="closeAddGoal()" class="flex-1 px-4 py-2 text-sm text-fact-muted hover:text-fact-ink rounded-lg">Cancel</button>
                <button onclick="saveGoal()" class="flex-1 px-4 py-2 text-sm bg-fact-yellow text-fact-ink rounded-lg font-medium">Save Goal</button>
            </div>
        </div>
    </div>

    <!-- TIMELINE HEATMAP MODAL -->
    <div id="heatmapModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-2xl overflow-hidden">
            <div class="p-5 border-b border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <div>
                    <h3 class="font-display font-semibold">Spending Heatmap</h3>
                    <p class="text-xs text-fact-muted dark:text-fact-dark-muted">Daily spending intensity</p>
                </div>
                <button onclick="closeHeatmap()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-5">
                <div id="heatmapContainer" class="overflow-x-auto">
                    <!-- Heatmap grid populated by JS -->
                </div>
                <div class="flex items-center justify-between mt-4 text-[10px] text-fact-muted">
                    <span>Less</span>
                    <div class="flex gap-1">
                        <div class="heatmap-cell" style="background: #E5E5E5"></div>
                        <div class="heatmap-cell" style="background: #C6E48B"></div>
                        <div class="heatmap-cell" style="background: #7BC96F"></div>
                        <div class="heatmap-cell" style="background: #239A3B"></div>
                        <div class="heatmap-cell" style="background: #196127"></div>
                    </div>
                    <span>More</span>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA INSTALL BANNER -->
    <div id="installBanner" class="install-banner">
        <div class="flex items-center gap-3">
            <img src="/flow/assets/icon-512-BaCJW5bY.png" alt="FACT/Flow" class="w-10 h-10 rounded-lg">
            <div>
                <div class="font-medium text-sm">Install FACT/Flow</div>
                <div class="text-[11px] opacity-80">Add to home screen for quick access</div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="dismissInstall()" class="px-3 py-1.5 text-xs opacity-80 hover:opacity-100">Later</button>
            <button onclick="installPWA()" class="px-3 py-1.5 text-xs bg-white/20 rounded-lg hover:bg-white/30 font-medium">Install</button>
        </div>
    </div>

    <!-- ONBOARDING WIZARD MODAL -->
    <div id="onboardingModal" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-box card rounded-2xl w-full max-w-md overflow-hidden flex flex-col">
            <!-- Progress bar -->
            <div class="h-1 bg-gray-100 dark:bg-gray-800">
                <div id="onboardingProgress" class="h-full bg-gradient-to-r from-fact-yellow via-fact-green to-fact-purple transition-all duration-300" style="width: 20%"></div>
            </div>

            <!-- Step content container -->
            <div id="onboardingContent" class="p-6 space-y-5 min-h-[340px] flex flex-col">
                <!-- Populated by JS -->
            </div>

            <!-- Footer nav -->
            <div class="p-5 border-t border-fact-border dark:border-fact-dark-border flex items-center justify-between">
                <button id="onboardingBack" onclick="onboardingPrev()" class="px-4 py-2.5 text-sm text-fact-muted hover:text-fact-ink dark:hover:text-fact-dark-ink rounded-xl transition hidden">
                    Back
                </button>
                <div class="flex-1"></div>
                <button id="onboardingNext" onclick="onboardingNext()" class="px-6 py-2.5 text-sm bg-fact-ink dark:bg-white text-white dark:text-fact-ink rounded-xl font-medium hover:opacity-90 transition min-h-[44px]">
                    Next
                </button>
            </div>
        </div>
    </div>

    <!-- Main application script (Vite module) -->
</body>
</html>
